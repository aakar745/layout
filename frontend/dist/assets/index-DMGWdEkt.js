import{F as z,j as a,P as Z,Q as ee,S as te,R as ie,I as ae,J as se,K as E,D as _}from"./index-BfjvBafq.js";import{l as ne,k as re,u as H,j as le,X as oe,i as N,r as c}from"./vendor-react-BNeW3y6d.js";import"./vendor-canvas-BRbMLhVA.js";import{ah as de,a7 as ce,S as C,W as M,c as R,bk as he,b5 as fe,b as ue,a$ as pe}from"./vendor-antd-sZZBSykP.js";import"./vendor-utils-BlPUcn-b.js";import"./vendor-styling-ULYxIwmc.js";const xe=({exhibitionId:s,destination:D="layout",label:k="Back to Layout"})=>{const h=H(),{currentExhibition:f}=N(w=>w.exhibition);return a.jsxs("div",{style:{marginBottom:"24px",position:"sticky",top:"16px",zIndex:10},children:[a.jsx(R,{icon:a.jsx(pe,{}),onClick:()=>h(z(f,D),{state:{exhibitionId:s}}),type:"default",size:"large",style:{borderRadius:"8px",boxShadow:"0 2px 6px rgba(0,0,0,0.08)",background:"white",borderColor:"transparent",fontWeight:500,padding:"0 16px",height:"42px",display:"flex",alignItems:"center",transition:"all 0.3s ease"},className:"back-button-hover",children:a.jsx("span",{style:{marginLeft:8},children:k})}),a.jsx("style",{children:`
        .back-button-hover:hover {
          transform: translateX(-5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          background: #f0f5ff;
          border-color: #d6e4ff;
        }
      `})]})},ve=()=>{var F,L,A;const{message:s}=de.useApp(),{id:D}=ne(),k=re(),h=H(),f=le(),[w,g]=oe(),n=((F=k.state)==null?void 0:F.exhibitionId)||D,{currentExhibition:d,halls:l,stalls:m,loading:T}=N(e=>e.exhibition),I=c.useRef(null),[W,y]=c.useState(!1),[i,j]=c.useState(null),[u,v]=c.useState(null),[P,$]=c.useState({width:0,height:0}),[x,U]=c.useState(!1);c.useEffect(()=>{if(!n){s.error("Exhibition ID not found"),h("/exhibitions");return}},[n,h,s]),c.useEffect(()=>{if(!n){s.error("Exhibition ID not found"),h("/exhibition");return}(async()=>{try{await f(ae(n)).unwrap(),await f(se(n)).unwrap(),U(!0)}catch{s.error("Failed to load data")}})()},[n,f,h]),c.useEffect(()=>{var e,t;!x||!d||(!((e=d.dimensions)!=null&&e.width)||!((t=d.dimensions)!=null&&t.height))&&(s.info("Please set up exhibition space first"),h(z(d,"space"),{state:{exhibitionId:n}}))},[d,n,h,x]),c.useEffect(()=>{!x||T||l.length===0&&(s.info("Please create halls first"),h(z(d,"halls"),{state:{exhibitionId:n}}))},[l,n,h,T,x]),c.useEffect(()=>{x&&d&&l.length>0&&(async()=>{try{const t=l.map(r=>f(E({exhibitionId:n,hallId:r.id,limit:1e3})).unwrap());await Promise.all(t)}catch(t){console.error("Error fetching stalls:",t),s.error("Failed to load stalls")}})()},[d,n,l,f,x]);const O=m.filter(e=>{const t=typeof e.hallId=="string"?e.hallId:String(e.hallId||""),r=String((i==null?void 0:i.id)||(i==null?void 0:i._id)||"");return t===r});c.useEffect(()=>{if(!x||l.length===0)return;const e=w.get("hallId");if(e){const t=l.find(r=>r.id===e||r._id===e);if(t)j(t);else if(l.length>0){j(l[0]);const r=l[0].id||l[0]._id;r&&g({hallId:r.toString()})}}else if(l.length>0){j(l[0]);const t=l[0].id||l[0]._id;t&&g({hallId:t.toString()})}},[l,w,x,g]),c.useEffect(()=>{const e=()=>{if(I.current){const{clientWidth:r,clientHeight:o}=I.current;$({width:Math.max(r||400,400),height:Math.max(o||400,400)})}};e();const t=new ResizeObserver(e);return I.current&&t.observe(I.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]);const X=()=>{if(!i){s.warning("Please select a hall first");return}v(null),y(!0)},V=e=>{if(j(e),v(null),e){const t=e.id||e._id;g(t?{hallId:t.toString()}:{})}else g({})},J=e=>{var r;const t=e?{...e,id:e.id||e._id,_id:e._id||e.id,stallTypeId:typeof e.stallTypeId=="string"?e.stallTypeId:((r=e.stallTypeId)==null?void 0:r._id)||e.stallTypeId,stallType:e.stallType}:null;console.log("Selected stall data:",t),v(t),y(!!t)},K=async e=>{var t,r;try{if(!(i!=null&&i.id)&&!(i!=null&&i._id)){s.error("No hall selected");return}const o=i.id,p=i._id||i.id;if(e.hallId&&e.hallId!==p){s.error("Cannot move stall to a different hall");return}if(console.log("Submitting stall data:",e),e.id||e._id){const S={...e,id:e.id,_id:e._id,hallId:p,stallTypeId:e.stallTypeId};console.log("Update data:",S);const b=e.id||e._id;if(!b)throw new Error("Stall ID is missing");await _.updateStall(n,b,S),s.success("Stall updated successfully")}else{const{id:S,_id:b,...G}=e,B={...G,hallId:p,stallTypeId:e.stallTypeId};console.log("Creating new stall with data:",B),await _.createStall(n,B),s.success("Stall created successfully")}y(!1),f(E({exhibitionId:n,hallId:o,limit:1e3}))}catch(o){console.error("Error saving stall:",o),s.error(((r=(t=o.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to save stall")}},Q=async e=>{var t,r;try{if(!n){s.error("Exhibition ID not found");return}const o=i;if(!o){s.error("No hall selected");return}const p=o.id||o._id;if(!p){s.error("Invalid hall ID");return}await _.deleteStall(n,e),y(!1),v(null),await f(E({exhibitionId:n,hallId:p,limit:1e3})).unwrap(),s.success("Stall deleted successfully")}catch(o){console.error("Error deleting stall:",o),s.error(((r=(t=o.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to delete stall")}},Y=async e=>{var p,S;if(!n){s.error("Exhibition ID not found");return}const t=e.id||e._id;if(!t){console.error("Stall data:",e),s.error("Stall ID not found");return}if(!(i!=null&&i.id)&&!(i!=null&&i._id)){s.error("No hall selected");return}const r=i.id,o=i._id||i.id;try{await _.updateStall(n,t,{...e,id:t,hallId:o}),f(E({exhibitionId:n,hallId:r,limit:1e3}))}catch(b){console.error("Stall update error:",b),s.error(((S=(p=b.response)==null?void 0:p.data)==null?void 0:S.message)||"Failed to update stall position")}},q=()=>{y(!1),v(null)};return a.jsx(Z,{children:a.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column"},children:[a.jsx("div",{style:{padding:"24px 24px 0"},children:a.jsx(xe,{exhibitionId:n})}),a.jsxs(ce,{title:a.jsxs(C,{children:[a.jsx("span",{children:"Stall Manager"}),m.length>100&&a.jsxs(ue,{color:"orange",icon:a.jsx(M,{}),children:["Performance Mode: ",m.length," stalls (viewport culling active)"]})]}),extra:a.jsxs(C,{children:[a.jsx(R,{icon:a.jsx(he,{}),onClick:()=>h(`/exhibition/${n}`,{state:{exhibitionId:n}}),children:"Back to Exhibition"}),a.jsx(R,{type:"primary",icon:a.jsx(fe,{}),onClick:X,disabled:!i,children:"Add Stall"})]}),style:{flex:1},bodyStyle:{height:"calc(100% - 57px)"},children:[m.length>500&&a.jsx("div",{style:{padding:"12px",background:"#fff7e6",border:"1px solid #ffd591",borderRadius:"6px",marginBottom:"16px",fontSize:"14px"},children:a.jsxs(C,{children:[a.jsx(M,{style:{color:"#fa8c16"}}),a.jsxs("div",{children:[a.jsx("strong",{children:"Large Dataset Optimization Active"}),a.jsx("br",{}),a.jsxs("span",{style:{color:"#666"},children:[m.length," stalls detected. Advanced performance optimizations are enabled including viewport culling and simplified rendering. Use zoom and pan to navigate efficiently."]})]})]})}),a.jsx("div",{ref:I,style:{width:"100%",height:"100%",minHeight:"400px",background:"#f0f2f5",borderRadius:"8px",overflow:"hidden"},children:d&&a.jsx(ee,{width:P.width,height:P.height,exhibitionWidth:((L=d.dimensions)==null?void 0:L.width)||100,exhibitionHeight:((A=d.dimensions)==null?void 0:A.height)||100,halls:l,selectedHall:i,onSelectHall:V,isStallMode:!0,children:i&&O.map(e=>a.jsx(te,{stall:e,isSelected:(u==null?void 0:u.id)===e.id||(u==null?void 0:u._id)===e._id,onSelect:()=>J(e),onChange:Y,hallWidth:i.dimensions.width,hallHeight:i.dimensions.height,hallX:i.dimensions.x,hallY:i.dimensions.y,isLargeDataset:m.length>100},e.id||e._id))})})]}),d&&a.jsx(ie,{visible:W,stall:u,hall:i,exhibition:d,onCancel:q,onSubmit:K,onDelete:u?()=>Q(u.id||u._id):void 0})]})})};export{ve as default};
