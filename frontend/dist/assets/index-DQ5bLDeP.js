const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DoSueJxk.js","assets/vendor-react-dkbxt9Jf.js","assets/vendor-utils-ngrFHoWO.js","assets/vendor-antd-mFVHvrVJ.js","assets/vendor-styling-CQa69cNz.js","assets/index-Bppz5v0Z.css"])))=>i.map(i=>d[i]);
import{j as e,K as pe,L as Re,M as Me,O as Ne,P as ze,Q as Pe,R as Be,v as Ee,S as We,z as Le,_ as Fe,T as qe}from"./index-DoSueJxk.js";import{u as Se,l as Ie,R as Ue,k as je,r as E}from"./vendor-react-dkbxt9Jf.js";import{$ as xe,a0 as U,a1 as M,o as Q,aq as K,au as He,a as W,V as Y,h as we,x as se,m as le,aS as Ve,aT as Oe,S as L,J as Ae,ar as Qe,ab as ve,aw as Ke,c as H,j as Ye,ag as X,ai as ke,d as Ge,b as F,at as Je,p as Xe,ay as Ze,C as Ce,z as et,aU as tt,R as Te,aV as it,W as h,T as De,D as $e,aW as J,K as nt,P as re,al as st,aQ as at,ah as rt}from"./vendor-antd-mFVHvrVJ.js";/* empty css                  */import{u as ot}from"./reduxHooks-Be1Cl4uN.js";import{u as he,a as lt}from"./vendor-export-PCv_shhx.js";import{F as ct}from"./FileSaver.min-jwPvKRD0.js";import"./vendor-utils-ngrFHoWO.js";import"./vendor-styling-CQa69cNz.js";const be=t=>{if(!t)return 0;const x=t.shapeType||"rectangle";if(x==="rectangle")return t.width*t.height;if(x==="l-shape"&&t.lShape){const{rect1Width:p,rect1Height:a,rect2Width:f,rect2Height:j}=t.lShape;return p*a+f*j}return t.width*t.height},dt=({bookings:t,paginationTotal:x,stats:p,statsLoading:a=!1})=>{const j=p?{...p,total:x!==void 0?x:p.total,pending:t.filter(d=>d.status==="pending").length,approved:t.filter(d=>d.status==="approved").length,rejected:t.filter(d=>d.status==="rejected").length,confirmed:t.filter(d=>d.status==="confirmed").length,cancelled:t.filter(d=>d.status==="cancelled").length,bookedSQM:Math.round(t.filter(d=>d.status==="confirmed"||d.status==="approved").reduce((d,z)=>{const o=z.stallIds?.reduce((m,S)=>S?.dimensions?m+be(S.dimensions):m,0)||0;return d+o},0)*100)/100}:(()=>{const d=x!==void 0?x:t.length,z=t.filter(o=>o.status==="confirmed"||o.status==="approved").reduce((o,m)=>{const S=m.stallIds?.reduce((C,N)=>N?.dimensions?C+be(N.dimensions):C,0)||0;return o+S},0);return{total:d,pending:t.filter(o=>o.status==="pending").length,approved:t.filter(o=>o.status==="approved").length,rejected:t.filter(o=>o.status==="rejected").length,confirmed:t.filter(o=>o.status==="confirmed").length,cancelled:t.filter(o=>o.status==="cancelled").length,totalSQM:0,bookedSQM:Math.round(z*100)/100}})();return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Total count across all pages",children:["Total Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.total,prefix:e.jsx(He,{})})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Count of all pending bookings",children:["Pending Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.pending,prefix:e.jsx(we,{style:{color:"#faad14"}})})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Count of all approved bookings",children:["Approved Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.approved,prefix:e.jsx(se,{style:{color:"#52c41a"}})})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Count of all confirmed bookings",children:["Confirmed Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.confirmed,prefix:e.jsx(se,{style:{color:"#52c41a"}})})})})]}),e.jsxs(xe,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Count of all rejected bookings",children:["Rejected Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.rejected,prefix:e.jsx(le,{style:{color:"#f5222d"}})})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Count of all cancelled bookings",children:["Cancelled Bookings ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.cancelled,prefix:e.jsx(le,{style:{color:"#f5222d"}})})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Total area from all stalls in bookings",children:["Total SQM ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.totalSQM,precision:1,suffix:"sqm",prefix:e.jsx(Ve,{}),valueStyle:{color:"#722ed1"}})})}),e.jsx(U,{xs:24,sm:12,md:6,children:e.jsx(M,{children:a?e.jsx("div",{style:{textAlign:"center",padding:"20px 0"},children:e.jsx(Q,{})}):e.jsx(K,{title:e.jsxs(W,{title:"Booked area from confirmed and approved bookings",children:["Booked SQM ",e.jsx(Y,{style:{fontSize:"14px",marginLeft:4}})]}),value:j.bookedSQM,precision:1,suffix:"sqm",prefix:e.jsx(Oe,{}),valueStyle:{color:"#52c41a"}})})})]})]})},{RangePicker:ut}=Ke,ht=({filters:t,exhibitions:x,onFilterChange:p,onRefresh:a})=>e.jsx(M,{style:{marginBottom:"24px"},children:e.jsxs(L,{wrap:!0,children:[e.jsx(Ae,{placeholder:"Search by company, customer, email, or phone",prefix:e.jsx(Qe,{}),value:t.search,onChange:f=>p({...t,search:f.target.value}),style:{width:250},allowClear:!0}),e.jsx(ve,{placeholder:"Filter by exhibition",value:t.exhibition,onChange:f=>p({...t,exhibition:f}),style:{minWidth:200},allowClear:!0,options:x.map(f=>({label:f.name,value:f._id}))}),e.jsx(ve,{mode:"multiple",placeholder:"Filter by status",value:t.status,onChange:f=>p({...t,status:f}),style:{minWidth:200},options:[{label:"Pending",value:"pending"},{label:"Approved",value:"approved"},{label:"Rejected",value:"rejected"},{label:"Confirmed",value:"confirmed"},{label:"Cancelled",value:"cancelled"}]}),e.jsx(ut,{onChange:f=>p({...t,dateRange:f?[f[0]?.toISOString()||"",f[1]?.toISOString()||""]:null})}),e.jsx(H,{icon:e.jsx(Ye,{}),onClick:a,children:"Refresh"})]})}),oe=t=>{if(!t)return 0;const x=t.shapeType||"rectangle";if(x==="rectangle")return t.width*t.height;if(x==="l-shape"&&t.lShape){const{rect1Width:p,rect1Height:a,rect2Width:f,rect2Height:j}=t.lShape;return p*a+f*j}return t.width*t.height},xt=(t,x,p,a)=>{(a||X).confirm({title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",color:"#101828",padding:"20px 24px",borderBottom:"1px solid #EAECF0"},children:[e.jsx(Te,{style:{color:"#F04438",fontSize:"22px"}}),e.jsx("span",{style:{fontSize:"18px",fontWeight:600,lineHeight:"28px"},children:"Delete Booking"})]}),content:e.jsxs("div",{style:{padding:"20px 24px",color:"#475467"},children:[e.jsxs("p",{style:{fontSize:"14px",lineHeight:"20px",marginBottom:"8px"},children:["Are you sure you want to delete booking ",e.jsx("strong",{children:p(t._id,t.createdAt)}),"?"]}),e.jsx("p",{style:{color:"#667085",fontSize:"14px",lineHeight:"20px",marginBottom:0},children:"This action cannot be undone and will permanently delete all associated data including invoices."})]}),footer:e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px",padding:"20px 24px",borderTop:"1px solid #EAECF0",marginTop:0},children:[e.jsx(H,{onClick:()=>{a&&a.destroy?a.destroy():X.destroyAll()},style:{height:"40px",padding:"10px 18px",borderRadius:"8px",border:"1px solid #D0D5DD",color:"#344054",fontWeight:500,fontSize:"14px",lineHeight:"20px",display:"flex",alignItems:"center",boxShadow:"0px 1px 2px rgba(16, 24, 40, 0.05)"},children:"Cancel"}),e.jsx(H,{danger:!0,type:"primary",onClick:()=>{x(t._id),a&&a.destroy?a.destroy():X.destroyAll()},style:{height:"40px",padding:"10px 18px",borderRadius:"8px",border:"none",backgroundColor:"#D92D20",color:"white",fontWeight:500,fontSize:"14px",lineHeight:"20px",display:"flex",alignItems:"center",boxShadow:"0px 1px 2px rgba(16, 24, 40, 0.05)"},children:"Delete"})]}),centered:!0,icon:null,width:400,closable:!0,maskClosable:!0,className:"delete-confirmation-modal",styles:{mask:{backgroundColor:"rgba(52, 64, 84, 0.7)"},content:{padding:0,borderRadius:"12px",boxShadow:"0px 4px 6px -2px rgba(16, 24, 40, 0.05), 0px 12px 16px -4px rgba(16, 24, 40, 0.1)"},body:{padding:0},footer:{display:"none"}}})},pt=(t,x)=>{const p=Se(),{data:a,isLoading:f,error:j,refetch:d}=pe({page:1,limit:200},{refetchOnMountOrArgChange:10,refetchOnFocus:!0,refetchOnReconnect:!0}),[z,{isLoading:o}]=Re(),[m,{isLoading:S}]=Me(),C=async i=>{try{if(i.status!=="approved"&&i.status!=="confirmed"){h.warning("Booking must be approved or confirmed before sending invoice.");return}const n=I(i._id);if(!n){h.error("Invoice not found for this booking.");return}const r=i.exhibitorId?.email||i.customerEmail;if(!r){h.error("No email address found for this booking.");return}const s=i.exhibitorId?.contactPerson||i.customerName,v=i.exhibitorId?.companyName||i.companyName,g=i.stallIds.reduce((k,O)=>{const Z=O.dimensions?.width||0,ce=O.dimensions?.height||0,ee=O.ratePerSqm||0;return k+Math.round(Z*ce*ee*100)/100},0);let y=0;const _=i.calculations.stalls.filter(k=>k.discount).map(k=>k.discount);if(_.length>0){const k=_[0];k&&(k.type==="percentage"?y=Math.round(g*k.value/100*100)/100:k.type==="fixed"&&(y=Math.min(k.value,g)))}const b=g-y;let T=0;i.calculations.taxes&&i.calculations.taxes.length>0&&(T=i.calculations.taxes.reduce((k,O)=>{const Z=Math.round(b*O.rate/100*100)/100;return k+Z},0));const P=Math.round((b+T)*100)/100,D=`Dear ${s},

Please find attached the invoice for your stall booking${v?` for ${v}`:""}.

Booking Details:
- Booking ID: ${t.formatBookingNumber(i._id,i.createdAt)}
- Exhibition: ${i.exhibitionId.name}
- Total Amount: ₹${P.toLocaleString()}
- Status: ${i.status.toUpperCase()}

Thank you for your business!

Best regards,
Exhibition Management Team`;await z({id:n,email:r,message:D}).unwrap(),h.success(`Invoice sent successfully to ${r}`)}catch(n){console.error("Error sending invoice:",n),h.error(n?.data?.message||"Failed to send invoice. Please try again.")}},N=async i=>{try{if(i.status!=="approved"&&i.status!=="confirmed"){h.warning("Booking must be approved or confirmed before sending invoice.");return}const n=I(i._id);if(!n){h.error("Invoice not found for this booking.");return}const r=i.exhibitorId?.phone||i.customerPhone;if(!r){h.error("No phone number found for this booking.");return}await m({id:n,phoneNumber:r}).unwrap(),h.success(`Invoice sent successfully via WhatsApp to ${r}`)}catch(n){console.error("Error sending invoice via WhatsApp:",n),h.error(n?.data?.message||"Failed to send invoice via WhatsApp. Please try again.")}},I=i=>f||j||!a?null:(a.data||[]).find(s=>s.bookingId&&typeof s.bookingId=="object"&&s.bookingId._id===i)?._id,V=async i=>{if(i.status!=="approved"&&i.status!=="confirmed"){h.warning("First approve the stall, then view the invoice.");return}if(f){h.loading("Loading invoice data...");return}let n=I(i._id);if(n)p(`/invoice/${n}`);else{const r=new Date(i.createdAt),s=new Date(Date.now()-600*1e3);if(r>s){const g="invoice-loading";h.loading({content:"Loading invoice...",key:g});try{if(await d(),n=I(i._id),n){h.success({content:"Invoice ready!",key:g,duration:1}),p(`/invoice/${n}`);return}h.info({content:"Invoice is being generated. Please wait...",key:g});let y=0;const _=4,b=[1e3,2e3,3e3,5e3],T=async()=>{y++,await d();const P=I(i._id);if(P)h.success({content:"Invoice is ready!",key:g,duration:1}),p(`/invoice/${P}`);else if(y<_){const D=b[y-1]||3e3;h.loading({content:`Preparing invoice... (${y}/${_})`,key:g}),setTimeout(T,D)}else h.warning({content:"Invoice is still being processed. Please try again in a moment.",key:g,duration:4})};setTimeout(T,b[0])}catch{h.error({content:"Failed to load invoice. Please try again.",key:g})}}else{const g="invoice-loading";if(h.loading({content:"Checking for invoice...",key:g}),await d(),n=I(i._id),n){h.success({content:"Invoice found!",key:g,duration:1}),p(`/invoice/${n}`);return}if(i.status==="approved"){h.info({content:"Invoice is being generated. Please wait...",key:g});let y=0;const _=3,b=[2e3,4e3,6e3],T=async()=>{y++,await d();const P=I(i._id);if(P)h.success({content:"Invoice is ready!",key:g,duration:1}),p(`/invoice/${P}`);else if(y<_){const D=b[y-1]||4e3;h.loading({content:`Checking invoice availability... (${y}/${_})`,key:g}),setTimeout(T,D)}else h.warning({content:"Invoice is still being processed. Please refresh the page or try again later.",key:g,duration:4})};setTimeout(T,b[0])}else h.error({content:"No invoice found for this booking. Please contact support if this persists.",key:g})}}};return[{title:"Booking Number",dataIndex:"_id",key:"bookingNumber",fixed:"left",width:190,render:(i,n)=>e.jsx(H,{type:"link",onClick:()=>{t.setSelectedBooking(n),t.setIsDetailsModalVisible(!0)},children:t.formatBookingNumber(i,n.createdAt)})},{title:"Exhibition",dataIndex:["exhibitionId","name"],key:"exhibition",width:250,render:(i,n)=>e.jsx("span",{children:n.exhibitionId.name})},{title:"Company Name",dataIndex:"companyName",key:"company",width:250,render:i=>i||"N/A"},{title:"Stall No.",key:"stallNumber",width:120,render:(i,n)=>e.jsx("span",{children:n.stallIds.map((r,s)=>e.jsxs("span",{children:[r.number,s<n.stallIds.length-1?", ":""]},`stall-${r._id||s}`))})},{title:"Stall Type",key:"stallType",width:120,render:(i,n)=>{const r=Array.from(new Set(n.stallIds.map(s=>s.type)));return e.jsx("span",{children:r.map((s,v)=>e.jsxs("span",{children:[s,v<r.length-1?", ":""]},`type-${s}-${v}`))})}},{title:"Dimensions",key:"dimensions",width:150,render:(i,n)=>e.jsx("span",{children:n.stallIds.map((r,s)=>e.jsxs("span",{children:[r.dimensions?r.dimensions.shapeType==="l-shape"?"L-Shape":`${r.dimensions.width}m × ${r.dimensions.height}m`:"No dimensions",s<n.stallIds.length-1?", ":""]},`dim-${r._id||s}`))})},{title:"Area (sqm)",key:"area",width:120,render:(i,n)=>{const r=n.stallIds.reduce((s,v)=>v.dimensions?s+oe(v.dimensions):s,0);return e.jsxs("span",{children:[Math.round(r)," sqm"]})}},{title:"Base Amount",key:"baseAmount",width:150,render:(i,n)=>`₹${n.stallIds.reduce((s,v)=>{const g=oe(v.dimensions),y=v.ratePerSqm||0;return s+Math.round(g*y*100)/100},0).toLocaleString()}`},{title:"Discount",key:"discount",width:150,render:(i,n)=>{const r=n.stallIds.reduce((y,_)=>{const b=oe(_.dimensions),T=_.ratePerSqm||0;return y+Math.round(b*T*100)/100},0),s=n.calculations.stalls.filter(y=>y.discount).map(y=>y.discount);if(s.length===0)return"-";const v=s[0];if(!v)return"-";let g=0;return v.type==="percentage"?g=Math.round(r*v.value/100*100)/100:v.type==="fixed"&&(g=Math.min(v.value,r)),g===0?"-":e.jsx(W,{title:e.jsx("div",{children:s.map((y,_)=>e.jsxs("div",{children:[y?.name,": ",y?.type==="percentage"?`${y?.value}%`:`₹${y?.value}`,e.jsx("br",{}),"Current Amount: ₹",g.toLocaleString()]},`discount-${_}-${y?.name||"unnamed"}`))}),children:e.jsxs(F,{color:"red",children:["-₹",g.toLocaleString(),v?.type==="percentage"&&` (${v.value}%)`,s.length>1&&" +"]})})}},{title:"Total Amount",key:"amount",width:150,render:(i,n)=>{const r=n.stallIds.reduce((b,T)=>{const P=oe(T.dimensions),D=T.ratePerSqm||0;return b+Math.round(P*D*100)/100},0);let s=0;const v=n.calculations.stalls.filter(b=>b.discount).map(b=>b.discount);if(v.length>0){const b=v[0];b&&(b.type==="percentage"?s=Math.round(r*b.value/100*100)/100:b.type==="fixed"&&(s=Math.min(b.value,r)))}const g=r-s;let y=0;return n.calculations.taxes&&n.calculations.taxes.length>0&&(y=n.calculations.taxes.reduce((b,T)=>{const P=Math.round(g*T.rate/100*100)/100;return b+P},0)),`₹${(Math.round((g+y)*100)/100).toLocaleString()}`}},{title:"Booked By",dataIndex:"bookedBy",key:"bookedBy",width:200,render:(i,n)=>{if(n.bookingSource==="exhibitor"&&n.exhibitorId){const r=n.exhibitorId;return e.jsx(W,{title:`${r.email} - Exhibitor Portal`,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.contactPerson}),e.jsx("div",{className:"text-xs text-gray-500",children:"Exhibitor Portal"})]})})}else if(n.bookingSource==="admin"&&n.userId){const r=n.userId,s=r.role?.name||"Admin";return e.jsx(W,{title:`${r.email} - ${s}`,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.name||r.username}),e.jsx("div",{className:"text-xs text-gray-500",children:s})]})})}return e.jsx("span",{className:"text-gray-400",children:"System"})}},{title:"Created At",dataIndex:"createdAt",key:"createdAt",width:200,render:i=>Ge(i).format("MMM D, YYYY HH:mm")},{title:"Status",dataIndex:"status",key:"status",width:120,fixed:"right",render:i=>e.jsx(F,{color:i==="confirmed"?"success":i==="approved"?"blue":i==="pending"?"warning":i==="rejected"?"error":"default",children:i.toUpperCase()})},{title:"Actions",key:"actions",fixed:"right",width:220,render:(i,n)=>e.jsxs(L,{children:[e.jsx(W,{title:"View Details",children:e.jsx(H,{icon:e.jsx(Je,{}),onClick:()=>{t.setSelectedBooking(n),t.setIsDetailsModalVisible(!0)}})}),e.jsx(Xe,{menu:{items:[...n.status!=="cancelled"&&t.hasPermission("view_bookings")?[{key:"invoice",icon:e.jsx(Ce,{}),label:n.status!=="approved"&&n.status!=="confirmed"?"Approve First to View Invoice":"View Invoice",disabled:f||n.status!=="approved"&&n.status!=="confirmed",onClick:()=>V(n)}]:[],...n.status!=="cancelled"&&t.hasPermission("view_bookings")?[{key:"sendInvoice",icon:e.jsx(et,{}),label:o?"Sending...":n.status!=="approved"&&n.status!=="confirmed"?"Approve First to Send Invoice":"Send Invoice",disabled:o||n.status!=="approved"&&n.status!=="confirmed",onClick:()=>C(n)}]:[],{key:"sendWhatsApp",icon:e.jsx(tt,{}),label:S?"Sending WhatsApp...":n.status!=="approved"&&n.status!=="confirmed"?"Approve First to Send Invoice":"Send Invoice via WhatsApp",disabled:S||n.status!=="approved"&&n.status!=="confirmed",onClick:()=>N(n)},{key:"updateStatus",icon:e.jsx(se,{}),label:"Update Status",onClick:()=>{t.setSelectedBooking(n),t.setSelectedStatus(n.status),t.setRejectionReasonText(n.rejectionReason||""),t.setIsStatusModalVisible(!0)}},...t.hasPermission("delete_bookings")?[{key:"delete",icon:e.jsx(Te,{}),label:"Delete",danger:!0,onClick:()=>{xt(n,t.handleDelete,t.formatBookingNumber,x)}}]:[]]},trigger:["click"],children:e.jsx(H,{icon:e.jsx(Ze,{})})})]})}]},ft=t=>{const{bookings:x,loading:p,pagination:a,fetchBookingsWithPagination:f}=t,[j,d]=X.useModal(),z=pt(t,j),o=(m,S,C,N)=>e.jsx("div",{className:"ant-table-pagination ant-table-pagination-right",style:{padding:"16px 24px",margin:0,display:"flex",justifyContent:"flex-end"},children:e.jsx(it,{current:m,pageSize:S,total:C,showTotal:I=>`Total ${I} items`,showSizeChanger:!0,pageSizeOptions:["5","10","20","50","100"],onChange:I=>N(I,S),onShowSizeChange:(I,V)=>N(I,V),size:"default"})});return e.jsxs(e.Fragment,{children:[d,e.jsx(ke,{columns:z,dataSource:x,loading:p,rowKey:"_id",scroll:{x:1950},pagination:!1}),o(a.page,a.limit,a.total,(m,S)=>f(m,S))]})},mt=t=>{if(!t)return 0;const x=t.shapeType||"rectangle";if(x==="rectangle")return t.width*t.height;if(x==="l-shape"&&t.lShape){const{rect1Width:p,rect1Height:a,rect2Width:f,rect2Height:j}=t.lShape;return p*a+f*j}return t.width*t.height},{Title:_t,Text:u}=De,gt=({selectedBooking:t,isDetailsModalVisible:x,setIsDetailsModalVisible:p,setSelectedBooking:a,setIsStatusModalVisible:f,setSelectedStatus:j,setRejectionReasonText:d,formatBookingNumber:z})=>e.jsx(X,{title:"Booking Details",open:x,onCancel:()=>{p(!1),a(null)},footer:null,width:800,styles:{body:{padding:"16px"}},children:t&&e.jsxs(L,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsx(M,{title:"Booking Information",size:"small",styles:{body:{padding:"16px"}},children:e.jsxs(L,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",backgroundColor:"#fafafa",borderRadius:"6px",border:"1px solid #f0f0f0"},children:[e.jsxs("div",{children:[e.jsx(u,{strong:!0,style:{fontSize:"16px",color:"#1890ff"},children:z(t._id,t.createdAt)}),e.jsx("br",{}),e.jsx(u,{type:"secondary",style:{fontSize:"13px"},children:t.exhibitionId.name})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(F,{color:t.status==="confirmed"?"success":t.status==="approved"?"blue":t.status==="pending"?"warning":t.status==="rejected"?"error":"default",style:{fontSize:"12px",fontWeight:500},children:t.status.toUpperCase()}),e.jsx("br",{}),e.jsx(u,{type:"secondary",style:{fontSize:"12px"},children:new Date(t.createdAt).toLocaleDateString()})]})]}),t.rejectionReason&&e.jsxs("div",{style:{padding:"8px 12px",backgroundColor:"#fff2f0",border:"1px solid #ffccc7",borderRadius:"4px"},children:[e.jsx(u,{type:"secondary",style:{fontSize:"12px",fontWeight:500},children:"Rejection Reason:"}),e.jsx("br",{}),e.jsx(u,{style:{fontSize:"13px"},children:t.rejectionReason})]}),e.jsxs("div",{children:[e.jsx(u,{strong:!0,style:{fontSize:"14px",marginBottom:"8px",display:"block"},children:"Customer Details"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px 24px"},children:[e.jsxs("div",{children:[e.jsx(u,{type:"secondary",style:{fontSize:"12px",display:"block"},children:"Name"}),e.jsx(u,{style:{fontSize:"13px"},children:t.customerName})]}),e.jsxs("div",{children:[e.jsx(u,{type:"secondary",style:{fontSize:"12px",display:"block"},children:"Company"}),e.jsx(u,{style:{fontSize:"13px"},children:t.companyName})]}),e.jsxs("div",{children:[e.jsx(u,{type:"secondary",style:{fontSize:"12px",display:"block"},children:"Email"}),e.jsx(u,{style:{fontSize:"13px"},children:t.customerEmail})]}),e.jsxs("div",{children:[e.jsx(u,{type:"secondary",style:{fontSize:"12px",display:"block"},children:"Phone"}),e.jsx(u,{style:{fontSize:"13px"},children:t.customerPhone})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{strong:!0,style:{fontSize:"14px",marginBottom:"8px",display:"block"},children:"Booking Source"}),e.jsx("div",{style:{padding:"8px 12px",backgroundColor:"#f6ffed",border:"1px solid #b7eb8f",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:t.bookingSource==="exhibitor"&&t.exhibitorId?e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(u,{strong:!0,style:{fontSize:"13px"},children:t.exhibitorId.contactPerson}),e.jsx("br",{}),e.jsx(u,{type:"secondary",style:{fontSize:"12px"},children:t.exhibitorId.email})]}),e.jsx(F,{color:"blue",style:{fontSize:"11px"},children:"Exhibitor Portal"})]}):t.bookingSource==="admin"&&t.userId?e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(u,{strong:!0,style:{fontSize:"13px"},children:t.userId.name||t.userId.username}),e.jsx("br",{}),e.jsx(u,{type:"secondary",style:{fontSize:"12px"},children:t.userId.email})]}),e.jsx(F,{color:"green",style:{fontSize:"11px"},children:t.userId.role?.name||"Admin"})]}):e.jsx(u,{type:"secondary",style:{fontSize:"13px"},children:"System Generated"})})]})]})}),e.jsx(M,{title:"Stall Details",size:"small",styles:{body:{padding:"12px"}},children:e.jsx(ke,{dataSource:t.stallIds,pagination:!1,rowKey:"_id",size:"small",columns:[{title:"Stall Number",dataIndex:"number",key:"number"},{title:"Stall Type",key:"type",render:o=>o.type||"-"},{title:"Dimensions",key:"dimensions",render:o=>e.jsx(F,{color:"blue",children:o.dimensions?o.dimensions.shapeType==="l-shape"?"L-Shape":`${o.dimensions.width}x${o.dimensions.height}m`:"No dimensions"})},{title:"Rate (per sqm)",dataIndex:"ratePerSqm",key:"rate",render:o=>`₹${o.toLocaleString()}`},{title:"Base Amount",key:"baseAmount",render:o=>{const m=t.calculations.stalls.find(S=>S.stallId===o._id);return m?`₹${m.baseAmount.toLocaleString()}`:"-"}},{title:"Discount",key:"discount",render:o=>{const m=t.calculations.stalls.find(S=>S.stallId===o._id);return m?.discount?e.jsx(W,{title:e.jsx("div",{children:m.discount.type==="percentage"&&` (${m.discount.value}%)`}),children:e.jsxs(F,{color:"red",children:["-₹",m.discount.amount.toLocaleString(),m.discount.type==="percentage"&&` (${m.discount.value}%)`]})}):"-"}}]})}),e.jsx(M,{title:"Financial Summary",size:"small",styles:{body:{padding:"12px"}},children:e.jsx(L,{direction:"vertical",style:{width:"100%"},size:8,children:(()=>{const o=t.stallIds.reduce((i,n)=>{const r=mt(n.dimensions),s=n.ratePerSqm||0;return i+Math.round(r*s*100)/100},0);let m=0;const S=t.calculations.stalls.filter(i=>i.discount).map(i=>i.discount);if(S.length>0){const i=S[0];i&&(i.type==="percentage"?m=Math.round(o*i.value/100*100)/100:i.type==="fixed"&&(m=Math.min(i.value,o)))}const C=o-m,N=t.calculations.taxes.map(i=>({...i,amount:Math.round(C*i.rate/100*100)/100})),I=N.reduce((i,n)=>i+n.amount,0),V=Math.round((C+I)*100)/100;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(u,{children:"Total Base Amount:"}),e.jsxs(u,{children:["₹",o.toLocaleString()]})]}),m>0&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(u,{children:"Total Discount:"}),e.jsxs(u,{type:"danger",children:["-₹",m.toLocaleString()]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(u,{children:"Amount after Discount:"}),e.jsxs(u,{children:["₹",C.toLocaleString()]})]}),e.jsx($e,{style:{margin:"8px 0"}}),N.map(i=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(u,{children:[i.name," (",i.rate,"%):"]}),e.jsxs(u,{children:["₹",i.amount.toLocaleString()]})]},`tax-${i.name}-${i.rate}`)),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"8px"},children:[e.jsx(u,{strong:!0,children:"Total Amount (incl. Taxes):"}),e.jsxs(u,{strong:!0,children:["₹",V.toLocaleString()]})]})]})})()})})]})}),yt=({selectedBooking:t,isStatusModalVisible:x,setIsStatusModalVisible:p,selectedStatus:a,setSelectedStatus:f,rejectionReasonText:j,setRejectionReasonText:d,formatBookingNumber:z,refreshAfterAction:o})=>{const m=Ie(),[S,C]=Ue.useState(!1),{refetch:N}=pe({page:1,limit:100}),I=async(i,n,r)=>{try{C(!0),await m(Ne({id:i,status:n,...r&&{rejectionReason:r}})).unwrap(),h.success(`Booking ${n} successfully`),o(),p(!1),V(null),(n==="approved"||n==="confirmed")&&(m(ze.util.invalidateTags(["Invoice"])),setTimeout(async()=>{await N()},1500))}catch{h.error("Failed to update booking status")}finally{C(!1)}},V=i=>{};return e.jsx(X,{title:"Update Booking Status",open:x,onCancel:()=>{p(!1),d("")},footer:null,width:600,children:t&&e.jsxs("div",{children:[e.jsx(M,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx(Ce,{style:{fontSize:"18px"}}),e.jsx("span",{children:"Booking Information"})]}),style:{marginBottom:16},variant:"borderless",size:"small",children:e.jsxs(L,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px"},children:[e.jsx(F,{color:"processing",children:z(t._id,t.createdAt)}),e.jsx(F,{color:"default",children:t.exhibitionId.name}),e.jsx(F,{color:t.status==="confirmed"?"success":t.status==="approved"?"blue":t.status==="pending"?"warning":t.status==="rejected"?"error":"default",children:t.status.toUpperCase()})]}),e.jsxs("div",{style:{marginTop:"8px"},children:[e.jsx(u,{strong:!0,children:"Stall Details:"}),e.jsx("div",{style:{marginTop:"4px"},children:t.stallIds.map((i,n)=>e.jsxs(F,{style:{margin:"2px"},children:["#",i.number," ",i.type&&`(${i.type})`]},i._id))})]}),e.jsx($e,{style:{margin:"8px 0"}}),e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px"},children:[e.jsx(u,{strong:!0,style:{minWidth:"120px"},children:"Company:"}),e.jsx(u,{children:t.companyName})]}),e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px"},children:[e.jsx(u,{strong:!0,style:{minWidth:"120px"},children:"Current Status:"}),e.jsx(F,{color:t.status==="confirmed"?"success":t.status==="approved"?"blue":t.status==="pending"?"warning":t.status==="rejected"?"error":"default",children:t.status.toUpperCase()})]})]})}),e.jsxs(M,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx(st,{style:{fontSize:"18px"}}),e.jsx("span",{children:"Update Status"})]}),variant:"borderless",size:"small",children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx(u,{strong:!0,children:"Select New Status:"}),e.jsx("div",{style:{marginTop:"16px"},children:e.jsxs(J.Group,{value:a,onChange:i=>f(i.target.value),buttonStyle:"solid",style:{display:"flex",flexWrap:"nowrap",overflowX:"auto"},children:[e.jsx(J.Button,{value:"pending",style:{flex:"0 0 auto"},children:e.jsxs(L,{children:[e.jsx(we,{style:{color:"#faad14"}}),"Pending"]})}),e.jsx(J.Button,{value:"approved",style:{flex:"0 0 auto"},children:e.jsxs(L,{children:[e.jsx(se,{style:{color:"#52c41a"}}),"Approved"]})}),e.jsx(J.Button,{value:"rejected",style:{flex:"0 0 auto"},children:e.jsxs(L,{children:[e.jsx(le,{style:{color:"#f5222d"}}),"Rejected"]})}),e.jsx(J.Button,{value:"confirmed",style:{flex:"0 0 auto"},children:e.jsxs(L,{children:[e.jsx(se,{style:{color:"#1890ff"}}),"Confirmed"]})}),e.jsx(J.Button,{value:"cancelled",style:{flex:"0 0 auto"},children:e.jsxs(L,{children:[e.jsx(le,{style:{color:"#ff7875"}}),"Cancelled"]})})]})})]}),a==="rejected"&&e.jsx("div",{children:e.jsx(nt.Item,{label:e.jsx(u,{strong:!0,children:"Rejection Reason:"}),required:a==="rejected",rules:[{required:!0,message:"Please provide a reason for rejection"}],help:"This will be visible to the customer",children:e.jsx(Ae.TextArea,{rows:4,value:j,onChange:i=>d(i.target.value),placeholder:"Provide a reason for rejection",style:{marginTop:8}})})}),a==="approved"&&e.jsx(re,{message:"Approval Confirmation",description:"By approving this booking, the stalls will be reserved but not yet confirmed. Customer will be notified.",type:"success",showIcon:!0,style:{marginTop:8}}),a==="confirmed"&&e.jsx(re,{message:"Confirmation Notice",description:"By confirming this booking, the stalls will be marked as booked. This should be done after payment is received.",type:"info",showIcon:!0,style:{marginTop:8}}),a==="cancelled"&&e.jsx(re,{message:"Cancellation Warning",description:"By cancelling this booking, all stalls will be marked as available again.",type:"warning",showIcon:!0,style:{marginTop:8}}),a==="pending"&&e.jsx(re,{message:"Return to Pending",description:"This booking will be moved back to pending status.",type:"warning",showIcon:!0,style:{marginTop:8}})]}),e.jsxs("div",{style:{marginTop:24,display:"flex",justifyContent:"flex-end",gap:"8px"},children:[e.jsx(H,{onClick:()=>{p(!1),d("")},children:"Cancel"}),e.jsx(H,{type:"primary",onClick:()=>{if(a==="rejected"&&!j.trim()){h.error("Rejection reason is required when rejecting a booking");return}I(t._id,a,a==="rejected"?j:void 0)},loading:S,disabled:a==="rejected"&&!j.trim(),children:"Update Status"})]})]})]})})},jt=t=>{if(!t)return 0;const x=t.shapeType||"rectangle";if(x==="rectangle")return t.width*t.height;if(x==="l-shape"&&t.lShape){const{rect1Width:p,rect1Height:a,rect2Width:f,rect2Height:j}=t.lShape;return p*a+f*j}return t.width*t.height},{Title:vt,Text:bt}=De,Rt=()=>{const t=Ie(),{bookings:x,loading:p,pagination:a,stats:f,statsLoading:j}=je(l=>l.booking),{exhibitions:d,activeExhibitions:z}=je(l=>l.exhibition),[o,m]=E.useState(null),[S,C]=E.useState(!1),[N,I]=E.useState(!1),[V,i]=E.useState("pending"),[n,r]=E.useState(""),[s,v]=E.useState({search:"",status:[],dateRange:null,exhibition:null}),g=Se(),{data:y,isLoading:_,error:b,refetch:T}=pe({page:1,limit:200},{refetchOnMountOrArgChange:10,refetchOnFocus:!0,refetchOnReconnect:!0}),{hasPermission:P}=ot(),D=E.useCallback((l=1,w=10,q)=>{const A=q||s,$={page:l,limit:w};A.search&&($.search=A.search),A.exhibition&&($.exhibitionId=A.exhibition),A.status&&A.status.length>0&&($.status=A.status),A.dateRange&&A.dateRange.length===2&&($.startDate=A.dateRange[0],$.endDate=A.dateRange[1]),t(Pe($))},[t,s]),k=E.useCallback(l=>{t(Be(l?{exhibitionId:l}:{}))},[t]),O=E.useCallback(()=>{D(a.page,a.limit),k(s.exhibition||void 0)},[D,k,a.page,a.limit,s.exhibition]);E.useEffect(()=>{D(a.page,a.limit),k(s.exhibition||void 0)},[D,k,a.page,a.limit,s.exhibition]),E.useEffect(()=>{t(Ee()),t(We())},[t]),E.useEffect(()=>{x.length>0&&[...new Set(x.map(w=>w.exhibitionId._id))].forEach(w=>{t(Le(w))})},[x,t]),E.useEffect(()=>{const l=setTimeout(()=>{D(1,a.limit)},s.search?500:0);return()=>clearTimeout(l)},[s.search,D,a.limit]);const Z=async l=>{try{await t(qe(l)).unwrap(),h.success("Booking deleted successfully"),O()}catch(w){h.error(w?.message||"Failed to delete booking")}},ce=l=>{v(l),D(1,a.limit,l),k(l.exhibition||void 0)},ee=Array.isArray(x)?x:[],de=ee.filter(l=>{const w=d.find(q=>q._id===l.exhibitionId._id);return w&&w.status==="published"&&w.isActive}),fe=de.filter(l=>{if(s.exhibition&&(typeof l.exhibitionId=="string"?l.exhibitionId:l.exhibitionId._id)!==s.exhibition||s.status&&s.status.length>0&&!s.status.includes(l.status))return!1;if(s.dateRange&&s.dateRange.length===2){const w=new Date(l.createdAt),q=new Date(s.dateRange[0]),A=new Date(s.dateRange[1]);if(w<q||w>A)return!1}if(s.search){const w=s.search.toLowerCase();if(![l.companyName,l.customerName,l.customerEmail,l.customerPhone].join(" ").toLowerCase().includes(w))return!1}return!0}),ae=(l,w)=>{const q=new Date(w);if(isNaN(q.getTime()))return"--/--/--";const A=q.getFullYear();let $=de.find(c=>c._id===l);if($||($=ee.find(c=>c._id===l)),!$||!$.exhibitionId)return`--/${A}/--`;const te=typeof $.exhibitionId=="string"?$.exhibitionId:$.exhibitionId._id;if(!te)return`--/${A}/--`;const ie=ee.filter(c=>(typeof c.exhibitionId=="string"?c.exhibitionId:c.exhibitionId?._id)===te).sort((c,R)=>new Date(c.createdAt).getTime()-new Date(R.createdAt).getTime()).findIndex(c=>c._id===l)+1;if(ie===0)return`--/${A}/--`;const ue=ie.toString().padStart(2,"0");return`${d.find(c=>c._id===te)?.invoicePrefix||$.exhibitionId?.invoicePrefix||"BK"}/${A}/${ue}`},_e=async()=>{try{if(h.loading({content:"Preparing export...",key:"export"}),!d||d.length===0){h.warning("Exhibitions data is still loading. Please wait and try again."),h.destroy("export");return}const l={};s.search&&(l.search=s.search),s.exhibition&&(l.exhibitionId=s.exhibition),s.status&&s.status.length>0&&(l.status=s.status),s.dateRange&&s.dateRange.length===2&&(l.startDate=s.dateRange[0],l.endDate=s.dateRange[1]);const A=(await(await Fe(async()=>{const{default:c}=await import("./index-DoSueJxk.js").then(R=>R.Z);return{default:c}},__vite__mapDeps([0,1,2,3,4,5]))).default.get("/bookings/export",{params:l})).data;if(!Array.isArray(A))throw new Error("Invalid data format received");const te=A.filter(c=>{const R=typeof c.exhibitionId=="string"?c.exhibitionId:c.exhibitionId?._id;if(!R||!d||d.length===0)return!0;const ne=d.find(B=>B._id===R);return ne&&ne.status==="published"&&ne.isActive}).map(c=>{const R=c.stallIds||[],ne=R.reduce((B,G)=>G?.dimensions?B+jt(G.dimensions):B,0);return{"Booking Number":ae(c._id,c.createdAt),Exhibition:c.exhibitionId?.name||"Unknown Exhibition","Company Name":c.companyName||"N/A","Customer Name":c.customerName,"Customer Email":c.customerEmail,"Customer Phone":c.customerPhone,"Stall Numbers":R.length>0?R.map(B=>B?.number||"N/A").join(", "):"No stalls","Stall Types":R.length>0?Array.from(new Set(R.map(B=>B?.type||(B?.stallTypeId&&typeof B.stallTypeId=="object"?B.stallTypeId.name:"-")))).join(", "):"No types",Dimensions:R.length>0?R.map(B=>{const G=B?.dimensions;return G?G.shapeType==="l-shape"?"L-Shape":`${G.width}m × ${G.height}m`:"No dimensions"}).join(", "):"No dimensions","Total Area (sqm)":Math.round(ne),"Base Amount":Math.round(c.calculations?.totalBaseAmount||0),Discount:Math.round(c.calculations?.totalDiscountAmount||0),"Total Amount":Math.round(c.calculations?.totalAmount||c.amount||0),Status:c.status?.toUpperCase()||"UNKNOWN","Booked By":c.bookingSource==="exhibitor"&&c.exhibitorId?`${c.exhibitorId?.contactPerson||"Unknown"} (Exhibitor)`:c.userId?`${c.userId?.name||c.userId?.username||"Unknown"} (Admin)`:"System","Created Date":new Date(c.createdAt).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"})}}),me=he.json_to_sheet(te),ie=he.book_new();he.book_append_sheet(ie,me,"Bookings");const ue=lt(ie,{bookType:"xlsx",type:"array"}),ge=new Blob([ue],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),ye=new Date().toISOString().split("T")[0];ct.saveAs(ge,`bookings_export_${ye}.xlsx`),h.success({content:"Export successful!",key:"export",duration:2})}catch(l){console.error("Export error:",l),h.error({content:"Failed to export bookings",key:"export",duration:2})}};return e.jsxs("div",{className:"dashboard-container",children:[e.jsx("div",{style:{marginBottom:"24px"},children:e.jsxs(xe,{gutter:[24,24],align:"middle",children:[e.jsx(U,{flex:"auto",children:e.jsxs(L,{direction:"vertical",size:4,children:[e.jsx(vt,{level:4,style:{margin:0},children:"Stall Bookings"}),e.jsx(bt,{type:"secondary",children:"Manage exhibition stall bookings"})]})}),e.jsx(U,{children:e.jsxs(L,{children:[e.jsx(H,{icon:e.jsx(at,{}),onClick:_e,size:"large",children:"Export"}),e.jsx(H,{type:"primary",size:"large",icon:e.jsx(rt,{}),onClick:()=>g("/bookings/create"),children:"Create Booking"})]})})]})}),e.jsx(dt,{bookings:fe,paginationTotal:fe.length,stats:f,statsLoading:j}),e.jsx(ht,{filters:s,exhibitions:z,onFilterChange:ce,onRefresh:O}),e.jsx(M,{className:"info-card",styles:{body:{padding:0,overflow:"auto"},header:{paddingBottom:12}},title:"Booking List",children:e.jsx(ft,{bookings:de,loading:p,fetchBookingsWithPagination:D,pagination:a,setSelectedBooking:m,setIsDetailsModalVisible:C,setIsStatusModalVisible:I,setSelectedStatus:i,setRejectionReasonText:r,formatBookingNumber:ae,handleDelete:Z,hasPermission:P})}),e.jsx(gt,{selectedBooking:o,isDetailsModalVisible:S,setIsDetailsModalVisible:C,setSelectedBooking:m,setIsStatusModalVisible:I,setSelectedStatus:i,setRejectionReasonText:r,formatBookingNumber:ae}),e.jsx(yt,{selectedBooking:o,isStatusModalVisible:N,setIsStatusModalVisible:I,selectedStatus:V,setSelectedStatus:i,rejectionReasonText:n,setRejectionReasonText:r,formatBookingNumber:ae,refreshAfterAction:O})]})};export{Rt as default};
