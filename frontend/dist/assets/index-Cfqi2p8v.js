import{j as n}from"./vendor-pdf-Cn0rG44s.js";import{a4 as K,r as c,G as Q,S as Z,h as C,af as ee}from"./vendor-antd-B8jUXf3i.js";import{b as te,a as ie,u as A,d as ae}from"./vendor-react-DW9h-haf.js";import{b as se,u as L}from"./vendor-redux-rS0pI56E.js";import{v as k,F as re,G as ne,S as oe,H as le,z as de,A as ce,B as E,x as _}from"./index-4IR4xblb.js";import"./vendor-canvas-DrFPvyt4.js";import{_ as he,S as fe}from"./vendor-antd-icons-BoTJB7uA.js";import"./vendor-http-t--hEgTQ.js";import"./vendor-ui-BmMA_ojr.js";const ue=({exhibitionId:a,destination:j="layout",label:D="Back to Layout"})=>{const h=A(),{currentExhibition:f}=L(w=>w.exhibition);return n.jsxs("div",{style:{marginBottom:"24px",position:"sticky",top:"16px",zIndex:10},children:[n.jsx(C,{icon:n.jsx(fe,{}),onClick:()=>h(k(f,j),{state:{exhibitionId:a}}),type:"default",size:"large",style:{borderRadius:"8px",boxShadow:"0 2px 6px rgba(0,0,0,0.08)",background:"white",borderColor:"transparent",fontWeight:500,padding:"0 16px",height:"42px",display:"flex",alignItems:"center",transition:"all 0.3s ease"},className:"back-button-hover",children:n.jsx("span",{style:{marginLeft:8},children:D})}),n.jsx("style",{children:`
        .back-button-hover:hover {
          transform: translateX(-5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          background: #f0f5ff;
          border-color: #d6e4ff;
        }
      `})]})},ve=()=>{var F,P,R;const{message:a}=K.useApp(),{id:j}=te(),D=ie(),h=A(),f=se(),[w,g]=ae(),s=((F=D.state)==null?void 0:F.exhibitionId)||j,{currentExhibition:d,halls:o,stalls:M,loading:T}=L(e=>e.exhibition),b=c.useRef(null),[N,I]=c.useState(!1),[t,v]=c.useState(null),[u,y]=c.useState(null),[z,H]=c.useState({width:0,height:0}),[x,W]=c.useState(!1);c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibitions");return}},[s,h,a]),c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibition");return}(async()=>{try{await f(de(s)).unwrap(),await f(ce(s)).unwrap(),W(!0)}catch{a.error("Failed to load data")}})()},[s,f,h]),c.useEffect(()=>{var e,i;!x||!d||(!((e=d.dimensions)!=null&&e.width)||!((i=d.dimensions)!=null&&i.height))&&(a.info("Please set up exhibition space first"),h(k(d,"space"),{state:{exhibitionId:s}}))},[d,s,h,x]),c.useEffect(()=>{!x||T||o.length===0&&(a.info("Please create halls first"),h(k(d,"halls"),{state:{exhibitionId:s}}))},[o,s,h,T,x]),c.useEffect(()=>{x&&d&&o.length>0&&(async()=>{try{const i=o.map(r=>f(E({exhibitionId:s,hallId:r.id})).unwrap());await Promise.all(i)}catch(i){console.error("Error fetching stalls:",i),a.error("Failed to load stalls")}})()},[d,s,o,f,x]);const U=M.filter(e=>e.hallId===((t==null?void 0:t.id)||(t==null?void 0:t._id)));c.useEffect(()=>{if(!x||o.length===0)return;const e=w.get("hallId");if(e){const i=o.find(r=>r.id===e||r._id===e);if(i)v(i);else if(o.length>0){v(o[0]);const r=o[0].id||o[0]._id;r&&g({hallId:r.toString()})}}else if(o.length>0){v(o[0]);const i=o[0].id||o[0]._id;i&&g({hallId:i.toString()})}},[o,w,x,g]),c.useEffect(()=>{const e=()=>{if(b.current){const{clientWidth:r,clientHeight:l}=b.current;H({width:Math.max(r||400,400),height:Math.max(l||400,400)})}};e();const i=new ResizeObserver(e);return b.current&&i.observe(b.current),window.addEventListener("resize",e),()=>{i.disconnect(),window.removeEventListener("resize",e)}},[]);const $=()=>{if(!t){a.warning("Please select a hall first");return}y(null),I(!0)},G=e=>{if(v(e),y(null),e){const i=e.id||e._id;g(i?{hallId:i.toString()}:{})}else g({})},O=e=>{var r;const i=e?{...e,id:e.id||e._id,_id:e._id||e.id,stallTypeId:typeof e.stallTypeId=="string"?e.stallTypeId:((r=e.stallTypeId)==null?void 0:r._id)||e.stallTypeId,stallType:e.stallType}:null;console.log("Selected stall data:",i),y(i),I(!!i)},V=async e=>{var i,r;try{if(!(t!=null&&t.id)&&!(t!=null&&t._id)){a.error("No hall selected");return}const l=t.id,p=t._id||t.id;if(e.hallId&&e.hallId!==p){a.error("Cannot move stall to a different hall");return}if(console.log("Submitting stall data:",e),e.id||e._id){const S={...e,id:e.id,_id:e._id,hallId:p,stallTypeId:e.stallTypeId};console.log("Update data:",S);const m=e.id||e._id;if(!m)throw new Error("Stall ID is missing");await _.updateStall(s,m,S),a.success("Stall updated successfully")}else{const{id:S,_id:m,...J}=e,B={...J,hallId:p,stallTypeId:e.stallTypeId};console.log("Creating new stall with data:",B),await _.createStall(s,B),a.success("Stall created successfully")}I(!1),f(E({exhibitionId:s,hallId:l}))}catch(l){console.error("Error saving stall:",l),a.error(((r=(i=l.response)==null?void 0:i.data)==null?void 0:r.message)||"Failed to save stall")}},X=async e=>{var i,r;try{if(!s){a.error("Exhibition ID not found");return}const l=t;if(!l){a.error("No hall selected");return}const p=l.id||l._id;if(!p){a.error("Invalid hall ID");return}await _.deleteStall(s,e),I(!1),y(null),await f(E({exhibitionId:s,hallId:p})).unwrap(),a.success("Stall deleted successfully")}catch(l){console.error("Error deleting stall:",l),a.error(((r=(i=l.response)==null?void 0:i.data)==null?void 0:r.message)||"Failed to delete stall")}},Y=async e=>{var p,S;if(!s){a.error("Exhibition ID not found");return}const i=e.id||e._id;if(!i){console.error("Stall data:",e),a.error("Stall ID not found");return}if(!(t!=null&&t.id)&&!(t!=null&&t._id)){a.error("No hall selected");return}const r=t.id,l=t._id||t.id;try{await _.updateStall(s,i,{...e,id:i,hallId:l}),f(E({exhibitionId:s,hallId:r}))}catch(m){console.error("Stall update error:",m),a.error(((S=(p=m.response)==null?void 0:p.data)==null?void 0:S.message)||"Failed to update stall position")}},q=()=>{I(!1),y(null)};return n.jsx(re,{children:n.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column"},children:[n.jsx("div",{style:{padding:"24px 24px 0"},children:n.jsx(ue,{exhibitionId:s})}),n.jsx(Q,{title:"Stall Manager",extra:n.jsxs(Z,{children:[n.jsx(C,{icon:n.jsx(he,{}),onClick:()=>h(`/exhibition/${s}`,{state:{exhibitionId:s}}),children:"Back to Exhibition"}),n.jsx(C,{type:"primary",icon:n.jsx(ee,{}),onClick:$,disabled:!t,children:"Add Stall"})]}),style:{flex:1},bodyStyle:{height:"calc(100% - 57px)"},children:n.jsx("div",{ref:b,style:{width:"100%",height:"100%",minHeight:"400px",background:"#f0f2f5",borderRadius:"8px",overflow:"hidden"},children:d&&n.jsx(ne,{width:z.width,height:z.height,exhibitionWidth:((P=d.dimensions)==null?void 0:P.width)||100,exhibitionHeight:((R=d.dimensions)==null?void 0:R.height)||100,halls:o,selectedHall:t,onSelectHall:G,isStallMode:!0,children:t&&U.map(e=>n.jsx(oe,{stall:e,isSelected:(u==null?void 0:u.id)===e.id||(u==null?void 0:u._id)===e._id,onSelect:()=>O(e),onChange:Y,hallWidth:t.dimensions.width,hallHeight:t.dimensions.height,hallX:t.dimensions.x,hallY:t.dimensions.y},e.id||e._id))})})}),d&&n.jsx(le,{visible:N,stall:u,hall:t,exhibition:d,onCancel:q,onSubmit:V,onDelete:u?()=>X(u.id||u._id):void 0})]})})};export{ve as default};
