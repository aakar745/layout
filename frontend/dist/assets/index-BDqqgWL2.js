import{j as i,E as q,z as G,A as J,B as w,w as j}from"./index-DoSueJxk.js";import{X as K,m as Q,u as P,l as Z,Y as ee,k as A,r as d}from"./vendor-react-dkbxt9Jf.js";import{C as te,S as ie,a as ae}from"./FixtureForm-CZKRuS-V.js";import"./vendor-canvas-CSSoKFlf.js";import{g as H}from"./url-DUULaBjX.js";import{Y as se,a1 as le,S as D,V as R,c as C,aH as ne,ah as re,b as oe,aE as de}from"./vendor-antd-mFVHvrVJ.js";import"./vendor-utils-ngrFHoWO.js";import"./vendor-styling-CQa69cNz.js";import"./stallUtils-DlikgrX5.js";import"./stall-BMZvk0fo.js";const ce=({exhibitionId:a,destination:E="layout",label:_="Back to Layout"})=>{const c=P(),{currentExhibition:h}=A(y=>y.exhibition);return i.jsxs("div",{style:{marginBottom:"24px",position:"sticky",top:"16px",zIndex:10},children:[i.jsx(C,{icon:i.jsx(de,{}),onClick:()=>c(H(h,E),{state:{exhibitionId:a}}),type:"default",size:"large",style:{borderRadius:"8px",boxShadow:"0 2px 6px rgba(0,0,0,0.08)",background:"white",borderColor:"transparent",fontWeight:500,padding:"0 16px",height:"42px",display:"flex",alignItems:"center",transition:"all 0.3s ease"},className:"back-button-hover",children:i.jsx("span",{style:{marginLeft:8},children:_})}),i.jsx("style",{children:`
        .back-button-hover:hover {
          transform: translateX(-5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          background: #f0f5ff;
          border-color: #d6e4ff;
        }
      `})]})},ye=()=>{const{message:a}=se.useApp(),{id:E}=K(),_=Q(),c=P(),h=Z(),[y,p]=ee(),s=_.state?.exhibitionId||E,{currentExhibition:o,halls:r,stalls:x,loading:k}=A(e=>e.exhibition),S=d.useRef(null),[B,b]=d.useState(!1),[l,v]=d.useState(null),[g,I]=d.useState(null),[z,F]=d.useState({width:0,height:0}),[f,L]=d.useState(!1);d.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),c("/exhibitions");return}},[s,c,a]),d.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),c("/exhibition");return}(async()=>{try{await h(G(s)).unwrap(),await h(J(s)).unwrap(),L(!0)}catch{a.error("Failed to load data")}})()},[s,h,c]),d.useEffect(()=>{!f||!o||(!o.dimensions?.width||!o.dimensions?.height)&&(a.info("Please set up exhibition space first"),c(H(o,"space"),{state:{exhibitionId:s}}))},[o,s,c,f]),d.useEffect(()=>{!f||k||r.length===0&&(a.info("Please create halls first"),c(H(o,"halls"),{state:{exhibitionId:s}}))},[r,s,c,k,f]),d.useEffect(()=>{f&&o&&r.length>0&&(async()=>{try{const t=r.map(n=>h(w({exhibitionId:s,hallId:n.id,limit:1e3})).unwrap());await Promise.all(t)}catch(t){console.error("Error fetching stalls:",t),a.error("Failed to load stalls")}})()},[o,s,r,h,f]);const M=x.filter(e=>{const t=typeof e.hallId=="string"?e.hallId:String(e.hallId||""),n=String(l?.id||l?._id||"");return t===n});d.useEffect(()=>{if(!f||r.length===0)return;const e=y.get("hallId");if(e){const t=r.find(n=>n.id===e||n._id===e);if(t)v(t);else if(r.length>0){v(r[0]);const n=r[0].id||r[0]._id;n&&p({hallId:n.toString()})}}else if(r.length>0){v(r[0]);const t=r[0].id||r[0]._id;t&&p({hallId:t.toString()})}},[r,y,f,p]),d.useEffect(()=>{const e=()=>{if(S.current){const{clientWidth:n,clientHeight:u}=S.current;F({width:Math.max(n||400,400),height:Math.max(u||400,400)})}};e();const t=new ResizeObserver(e);return S.current&&t.observe(S.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]);const N=()=>{if(!l){a.warning("Please select a hall first");return}I(null),b(!0)},U=e=>{if(v(e),I(null),e){const t=e.id||e._id;p(t?{hallId:t.toString()}:{})}else p({})},W=e=>{const t=e?{...e,id:e.id||e._id,_id:e._id||e.id,stallTypeId:typeof e.stallTypeId=="string"?e.stallTypeId:e.stallTypeId?._id||e.stallTypeId,stallType:e.stallType}:null;console.log("Selected stall data:",t),I(t),b(!!t)},$=async e=>{try{if(!l?.id&&!l?._id){a.error("No hall selected");return}const t=l.id,n=l._id||l.id;if(e.hallId&&e.hallId!==n){a.error("Cannot move stall to a different hall");return}if(console.log("Submitting stall data:",e),e.id||e._id){const u={...e,id:e.id,_id:e._id,hallId:n,stallTypeId:e.stallTypeId};console.log("Update data:",u);const m=e.id||e._id;if(!m)throw new Error("Stall ID is missing");await j.updateStall(s,m,u),a.success("Stall updated successfully")}else{const{id:u,_id:m,...Y}=e,T={...Y,hallId:n,stallTypeId:e.stallTypeId};console.log("Creating new stall with data:",T),await j.createStall(s,T),a.success("Stall created successfully")}b(!1),h(w({exhibitionId:s,hallId:t,limit:1e3}))}catch(t){console.error("Error saving stall:",t),a.error(t.response?.data?.message||"Failed to save stall")}},O=async e=>{try{if(!s){a.error("Exhibition ID not found");return}const t=l;if(!t){a.error("No hall selected");return}const n=t.id||t._id;if(!n){a.error("Invalid hall ID");return}await j.deleteStall(s,e),b(!1),I(null),await h(w({exhibitionId:s,hallId:n,limit:1e3})).unwrap(),a.success("Stall deleted successfully")}catch(t){console.error("Error deleting stall:",t),a.error(t.response?.data?.message||"Failed to delete stall")}},V=async e=>{if(!s){a.error("Exhibition ID not found");return}const t=e.id||e._id;if(!t){console.error("Stall data:",e),a.error("Stall ID not found");return}if(!l?.id&&!l?._id){a.error("No hall selected");return}const n=l.id,u=l._id||l.id;try{await j.updateStall(s,t,{...e,id:t,hallId:u}),h(w({exhibitionId:s,hallId:n,limit:1e3}))}catch(m){console.error("Stall update error:",m),a.error(m.response?.data?.message||"Failed to update stall position")}},X=()=>{b(!1),I(null)};return i.jsx(q,{children:i.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column"},children:[i.jsx("div",{style:{padding:"24px 24px 0"},children:i.jsx(ce,{exhibitionId:s})}),i.jsxs(le,{title:i.jsxs(D,{children:[i.jsx("span",{children:"Stall Manager"}),x.length>100&&i.jsxs(oe,{color:"orange",icon:i.jsx(R,{}),children:["Performance Mode: ",x.length," stalls (viewport culling active)"]})]}),extra:i.jsxs(D,{children:[i.jsx(C,{icon:i.jsx(ne,{}),onClick:()=>c(`/exhibition/${s}`,{state:{exhibitionId:s}}),children:"Back to Exhibition"}),i.jsx(C,{type:"primary",icon:i.jsx(re,{}),onClick:N,disabled:!l,children:"Add Stall"})]}),style:{flex:1},styles:{body:{height:"calc(100% - 57px)"}},children:[x.length>500&&i.jsx("div",{style:{padding:"12px",background:"#fff7e6",border:"1px solid #ffd591",borderRadius:"6px",marginBottom:"16px",fontSize:"14px"},children:i.jsxs(D,{children:[i.jsx(R,{style:{color:"#fa8c16"}}),i.jsxs("div",{children:[i.jsx("strong",{children:"Large Dataset Optimization Active"}),i.jsx("br",{}),i.jsxs("span",{style:{color:"#666"},children:[x.length," stalls detected. Advanced performance optimizations are enabled including viewport culling and simplified rendering. Use zoom and pan to navigate efficiently."]})]})]})}),i.jsx("div",{ref:S,style:{width:"100%",height:"100%",minHeight:"400px",background:"#f0f2f5",borderRadius:"8px",overflow:"hidden"},children:o&&i.jsx(te,{width:z.width,height:z.height,exhibitionWidth:o.dimensions?.width||100,exhibitionHeight:o.dimensions?.height||100,halls:r,selectedHall:l,onSelectHall:U,isStallMode:!0,children:l&&M.map(e=>i.jsx(ie,{stall:e,isSelected:g?.id===e.id||g?._id===e._id,onSelect:()=>W(e),onChange:V,hallWidth:l.dimensions.width,hallHeight:l.dimensions.height,hallX:l.dimensions.x,hallY:l.dimensions.y,isLargeDataset:x.length>100},e.id||e._id))})})]}),o&&i.jsx(ae,{visible:B,stall:g,hall:l,exhibition:o,onCancel:X,onSubmit:$,onDelete:g?()=>O(g.id||g._id):void 0})]})})};export{ye as default};
