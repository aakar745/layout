import{a as R,j as e}from"./index-DoSueJxk.js";import{u as ve,r as i}from"./vendor-react-dkbxt9Jf.js";import{X as Se,c,T as be,$ as L,a0 as l,a1 as g,aq as w,V as X,x as W,m as F,J as Z,ar as ee,ab as _,aw as Ae,S as te,j as se,b as u,au as Ce,R as Re,ai as Le,ag as k,am as d,d as M,B as ie,P as re,al as le,f as ae,at as we}from"./vendor-antd-mFVHvrVJ.js";import{u as ke}from"./reduxHooks-Be1Cl4uN.js";import"./vendor-utils-ngrFHoWO.js";import"./vendor-styling-CQa69cNz.js";const z={getActivities:async(x={})=>(await R.get("/activities",{params:x})).data,getStats:async(x=30)=>(await R.get("/activities/stats",{params:{days:x}})).data,getFilters:async()=>(await R.get("/activities/filters")).data,clearLogs:async x=>(await R.delete("/activities/clear",{data:x})).data},{Title:I,Text:a}=be,{RangePicker:ze}=Ae,{Option:T}=_,Be=()=>{const{hasPermission:x}=ke(),y=ve();if(!x("view_activities"))return e.jsx(Se,{status:"403",title:"403",subTitle:"Sorry, you are not authorized to access this page.",extra:e.jsx(c,{type:"primary",onClick:()=>y("/dashboard"),children:"Back to Dashboard"})});const[ne,oe]=i.useState([]),[ce,P]=i.useState(!1),[m,$]=i.useState(!1),[h,v]=i.useState({current:1,pageSize:50,total:0}),[o,de]=i.useState(null),[V,xe]=i.useState(null),[r,he]=i.useState(null),[ue,E]=i.useState(!1),[ge,D]=i.useState(!1),[p,G]=i.useState(!1),[n,O]=i.useState(""),[S,N]=i.useState(""),[b,Y]=i.useState(void 0),[A,H]=i.useState(void 0),[C,J]=i.useState(void 0),[f,U]=i.useState(null),j=async()=>{P(!0);try{const t={page:h.current,limit:h.pageSize,search:S||void 0,action:b,resource:A,success:C,startDate:f?.[0]?.toISOString(),endDate:f?.[1]?.toISOString()};console.log("Fetching activities with params:",t);const s=await z.getActivities(t);console.log("Activities response:",s),oe(s.activities),v(B=>({...B,total:s.pagination.total}))}catch(t){console.error("Error fetching activities:",t)}finally{P(!1)}},q=async()=>{$(!0);try{const t=await z.getStats(30);de(t)}catch(t){console.error("Error fetching stats:",t)}finally{$(!1)}},pe=async()=>{try{const t=await z.getFilters();xe(t)}catch(t){console.error("Error fetching filters:",t)}};i.useEffect(()=>{j()},[h.current,h.pageSize]),i.useEffect(()=>{q(),pe()},[]);const fe=!!(S||b||A||C!==void 0||f),K=()=>{console.log("Applying filters:",{searchText:S,selectedAction:b,selectedResource:A,selectedSuccess:C,dateRange:f}),v(t=>({...t,current:1})),j()},je=()=>{N(""),Y(void 0),H(void 0),J(void 0),U(null),v(t=>({...t,current:1})),setTimeout(j,100)},ye=async()=>{if(n==="CLEAR ALL LOGS"){G(!0);try{const t=await z.clearLogs({confirmText:n});k.success({title:"Logs Cleared Successfully",content:`${t.deletedCount} activity logs have been cleared from the database.`,onOk(){D(!1),O(""),j(),q()}})}catch(t){console.error("Error clearing logs:",t),k.error({title:"Error Clearing Logs",content:t.response?.data?.message||"Failed to clear activity logs. Please try again."})}finally{G(!1)}}},Q=()=>{D(!1),O("")},me=[{title:"Timestamp",dataIndex:"timestamp",key:"timestamp",width:180,render:t=>e.jsxs("div",{children:[e.jsx("div",{children:M(t).format("MMM DD, YYYY")}),e.jsx(a,{type:"secondary",style:{fontSize:"12px"},children:M(t).format("HH:mm:ss")})]}),sorter:!0,defaultSortOrder:"descend"},{title:"User",key:"user",width:200,render:(t,s)=>s.userId?e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(ae,{style:{marginRight:4}}),s.userId.username||s.userId.name]}),e.jsx(a,{type:"secondary",style:{fontSize:"12px"},children:s.userId.email})]}):s.exhibitorId?e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(ae,{style:{marginRight:4}}),s.exhibitorId.contactPerson]}),e.jsx(a,{type:"secondary",style:{fontSize:"12px"},children:s.exhibitorId.companyName})]}):e.jsx(u,{color:"default",children:"System"})},{title:"Action",dataIndex:"action",key:"action",width:150,render:t=>{const s={user_created:"green",user_updated:"blue",user_deleted:"red",exhibitor_registered:"green",exhibitor_updated:"blue",exhibitor_deleted:"red",exhibition_created:"green",exhibition_updated:"blue",exhibition_deleted:"red",booking_created:"green",booking_updated:"blue",booking_cancelled:"orange",booking_deleted:"red",invoice_downloaded:"purple",stall_created:"green",stall_updated:"blue",stall_deleted:"red"};return e.jsx(u,{color:s[t]||"default",children:t.replace(/_/g," ").toUpperCase()})}},{title:"Resource",dataIndex:"resource",key:"resource",width:120,render:t=>e.jsx(u,{color:"geekblue",children:t.toUpperCase()})},{title:"Description",key:"description",render:(t,s)=>e.jsxs("div",{children:[e.jsx("div",{children:s.details.description}),e.jsxs(a,{type:"secondary",style:{fontSize:"12px"},children:[s.method," ",s.endpoint]})]})},{title:"Status",dataIndex:"success",key:"success",width:100,render:t=>e.jsx(ie,{status:t?"success":"error",text:t?"Success":"Failed"})},{title:"Actions",key:"actions",width:80,render:(t,s)=>e.jsx(c,{type:"text",icon:e.jsx(we,{}),onClick:()=>{he(s),E(!0)}})}];return e.jsxs("div",{className:"activity-page",children:[e.jsxs("div",{style:{marginBottom:24},children:[e.jsx(I,{level:2,children:"System Activity"}),e.jsx(a,{type:"secondary",children:"Monitor all user actions and system events in real-time"})]}),e.jsxs(L,{gutter:[16,16],style:{marginBottom:24},children:[e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(g,{children:e.jsx(w,{title:"Total Activities",value:o?.totalActivities||0,loading:m,prefix:e.jsx(X,{})})})}),e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(g,{children:e.jsx(w,{title:"Successful",value:o?.successfulActivities||0,loading:m,prefix:e.jsx(W,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(g,{children:e.jsx(w,{title:"Failed",value:o?.failedActivities||0,loading:m,prefix:e.jsx(F,{}),valueStyle:{color:"#cf1322"}})})}),e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(g,{children:e.jsx(w,{title:"Success Rate",value:o?.successRate||0,precision:1,suffix:"%",loading:m,valueStyle:{color:(o?.successRate||0)>95?"#3f8600":(o?.successRate||0)>80?"#faad14":"#cf1322"}})})})]}),e.jsxs(g,{style:{marginBottom:24},children:[e.jsxs(L,{gutter:[16,16],align:"middle",children:[e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(Z,{placeholder:"Search activities...",prefix:e.jsx(ee,{}),value:S,onChange:t=>N(t.target.value),onPressEnter:K})}),e.jsx(l,{xs:24,sm:12,md:4,children:e.jsx(_,{placeholder:"Action",value:b,onChange:Y,allowClear:!0,style:{width:"100%"},children:V?.actions.map(t=>e.jsx(T,{value:t,children:t.replace(/_/g," ")},t))})}),e.jsx(l,{xs:24,sm:12,md:4,children:e.jsx(_,{placeholder:"Resource",value:A,onChange:H,allowClear:!0,style:{width:"100%"},children:V?.resources.map(t=>e.jsx(T,{value:t,children:t},t))})}),e.jsx(l,{xs:24,sm:12,md:4,children:e.jsxs(_,{placeholder:"Status",value:C,onChange:J,allowClear:!0,style:{width:"100%"},children:[e.jsx(T,{value:!0,children:"Success"}),e.jsx(T,{value:!1,children:"Failed"})]})}),e.jsx(l,{xs:24,sm:12,md:6,children:e.jsx(ze,{value:f,onChange:t=>U(t),style:{width:"100%"},placeholder:["Start Date","End Date"]})})]}),e.jsxs(L,{style:{marginTop:16},justify:"space-between",align:"middle",children:[e.jsx(l,{flex:"auto",children:e.jsxs(te,{wrap:!0,children:[e.jsx(c,{type:"primary",icon:e.jsx(ee,{}),onClick:K,children:"Search"}),e.jsx(c,{icon:e.jsx(se,{}),onClick:je,children:"Reset"}),e.jsx(c,{icon:e.jsx(se,{}),onClick:j,children:"Refresh"})]})}),e.jsx(l,{children:e.jsxs(te,{children:[fe&&e.jsx(u,{color:"blue",icon:e.jsx(Ce,{}),children:"Filters Active"}),e.jsx(c,{danger:!0,icon:e.jsx(Re,{}),onClick:()=>D(!0),style:{borderRadius:"6px",fontWeight:500,height:"36px",paddingLeft:"16px",paddingRight:"16px"},children:"Clear Logs"})]})})]})]}),e.jsx(g,{children:e.jsx(Le,{columns:me,dataSource:ne,rowKey:"_id",loading:ce,pagination:{current:h.current,pageSize:h.pageSize,total:h.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,s)=>`${s[0]}-${s[1]} of ${t} activities`,onChange:(t,s)=>{v(B=>({...B,current:t,pageSize:s||50}))}},scroll:{x:1200}})}),e.jsx(k,{title:"Activity Details",open:ue,onCancel:()=>E(!1),footer:[e.jsx(c,{onClick:()=>E(!1),children:"Close"},"close")],width:800,children:r&&e.jsxs("div",{children:[e.jsxs(d,{column:2,bordered:!0,children:[e.jsx(d.Item,{label:"Timestamp",children:M(r.timestamp).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(d.Item,{label:"Status",children:e.jsx(ie,{status:r.success?"success":"error",text:r.success?"Success":"Failed"})}),e.jsx(d.Item,{label:"Action",children:e.jsx(u,{color:"blue",children:r.action})}),e.jsx(d.Item,{label:"Resource",children:e.jsx(u,{color:"geekblue",children:r.resource})}),e.jsx(d.Item,{label:"Method",children:e.jsx(u,{children:r.method})}),e.jsx(d.Item,{label:"Endpoint",children:e.jsx("code",{children:r.endpoint})}),e.jsx(d.Item,{label:"IP Address",children:r.ipAddress||"N/A"}),e.jsx(d.Item,{label:"User Agent",span:2,children:e.jsx(a,{style:{fontSize:"12px",wordBreak:"break-all"},children:r.userAgent||"N/A"})})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx(I,{level:5,children:"Description"}),e.jsx(a,{children:r.details.description})]}),r.details.oldValues&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(I,{level:5,children:"Previous Values"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:12,borderRadius:4,fontSize:"12px",overflow:"auto"},children:JSON.stringify(r.details.oldValues,null,2)})]}),r.details.newValues&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(I,{level:5,children:"New Values"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:12,borderRadius:4,fontSize:"12px",overflow:"auto"},children:JSON.stringify(r.details.newValues,null,2)})]}),r.errorMessage&&e.jsx("div",{style:{marginTop:16},children:e.jsx(re,{type:"error",message:"Error Details",description:r.errorMessage})})]})}),e.jsx(k,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",color:"#ff4d4f",fontSize:"16px",fontWeight:600},children:[e.jsx(le,{style:{marginRight:12,fontSize:"20px",padding:"8px",backgroundColor:"#fff2f0",borderRadius:"50%",border:"2px solid #ffccc7"}}),"Clear All Activity Logs"]}),open:ge,onCancel:Q,closable:!p,maskClosable:!p,width:650,centered:!0,className:"clear-logs-modal",footer:[e.jsx(c,{size:"large",disabled:p,onClick:Q,style:{minWidth:"100px",height:"40px",borderRadius:"6px"},children:"Cancel"},"cancel"),e.jsx(c,{type:"primary",danger:!0,size:"large",loading:p,disabled:n!=="CLEAR ALL LOGS",onClick:ye,style:{minWidth:"140px",height:"40px",borderRadius:"6px",fontWeight:600},children:"Clear All Logs"},"clear")],children:e.jsxs("div",{style:{padding:"8px 0"},children:[e.jsx(re,{message:"⚠️ Permanent Data Deletion Warning",description:e.jsxs("div",{style:{marginTop:8},children:[e.jsxs("div",{style:{marginBottom:8},children:["This action will ",e.jsx("strong",{children:"permanently delete all activity logs"})," from the database."]}),e.jsxs("div",{style:{fontSize:"13px",color:"#666"},children:["• This operation cannot be undone",e.jsx("br",{}),"• The deletion action will be logged before clearing",e.jsx("br",{}),"• Consider backing up your database first"]})]}),type:"warning",showIcon:!0,style:{marginBottom:24,border:"1px solid #faad14",borderRadius:"8px"}}),e.jsxs("div",{style:{backgroundColor:"#fafafa",border:"1px solid #d9d9d9",borderRadius:"8px",padding:"16px",marginBottom:24},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:12,fontSize:"14px",fontWeight:600,color:"#262626"},children:[e.jsx(X,{style:{marginRight:8,color:"#1890ff"}}),"Current Activity Statistics"]}),e.jsxs(L,{gutter:[16,8],children:[e.jsx(l,{span:8,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"20px",fontWeight:"bold",color:"#1890ff"},children:o?.totalActivities||0}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Total Activities"})]})}),e.jsx(l,{span:8,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"20px",fontWeight:"bold",color:"#52c41a"},children:o?.successfulActivities||0}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Successful"})]})}),e.jsx(l,{span:8,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"20px",fontWeight:"bold",color:"#ff4d4f"},children:o?.failedActivities||0}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Failed"})]})})]})]}),e.jsxs("div",{style:{backgroundColor:"#fff2f0",border:"1px solid #ffccc7",borderRadius:"8px",padding:"20px",marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16,fontSize:"14px",lineHeight:"1.6"},children:e.jsx(a,{strong:!0,style:{color:"#262626"},children:"To confirm this dangerous action, please type the following text exactly:"})}),e.jsx("div",{style:{textAlign:"center",marginBottom:16,padding:"12px",backgroundColor:"#ffffff",border:"2px dashed #ff4d4f",borderRadius:"6px"},children:e.jsx(a,{code:!0,style:{color:"#ff4d4f",fontWeight:"bold",fontSize:"16px",letterSpacing:"1px"},children:"CLEAR ALL LOGS"})}),e.jsx(Z,{placeholder:"Type the confirmation text here...",value:n,onChange:t=>O(t.target.value),disabled:p,size:"large",style:{borderColor:n==="CLEAR ALL LOGS"?"#52c41a":"#ff4d4f",borderWidth:"2px",borderRadius:"6px",fontSize:"14px",textAlign:"center",fontWeight:n==="CLEAR ALL LOGS"?"bold":"normal"},suffix:n==="CLEAR ALL LOGS"?e.jsx(W,{style:{color:"#52c41a",fontSize:"16px"}}):n?e.jsx(F,{style:{color:"#ff4d4f",fontSize:"16px"}}):null}),n&&n!=="CLEAR ALL LOGS"&&e.jsx("div",{style:{marginTop:8,padding:"8px 12px",backgroundColor:"#fff1f0",border:"1px solid #ffccc7",borderRadius:"4px",textAlign:"center"},children:e.jsxs(a,{type:"danger",style:{fontSize:"13px"},children:[e.jsx(F,{style:{marginRight:4}}),"Please type exactly: ",e.jsx(a,{code:!0,strong:!0,children:"CLEAR ALL LOGS"})]})}),n==="CLEAR ALL LOGS"&&e.jsx("div",{style:{marginTop:8,padding:"8px 12px",backgroundColor:"#f6ffed",border:"1px solid #b7eb8f",borderRadius:"4px",textAlign:"center"},children:e.jsxs(a,{type:"success",style:{fontSize:"13px",fontWeight:"bold"},children:[e.jsx(W,{style:{marginRight:4}}),"Confirmation text verified. You may now proceed."]})})]}),e.jsxs("div",{style:{textAlign:"center",padding:"12px",backgroundColor:"#fff7e6",border:"1px solid #ffd591",borderRadius:"6px",fontSize:"13px",color:"#ad6800"},children:[e.jsx(le,{style:{marginRight:4}}),e.jsx("strong",{children:"Last Warning:"})," This action will permanently delete ",o?.totalActivities||0," activity logs."]})]})})]})};export{Be as default};
