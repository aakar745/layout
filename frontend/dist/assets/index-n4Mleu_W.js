import{C as he,Z as xe,_ as me,j as t,aa as ge}from"./index-BRKtYmDF.js";import{u as pe,j as je,r as s,i as ye,R as fe}from"./vendor-react-BNeW3y6d.js";import{X as be,d as E,ah as ve,a7 as Z,S as m,T as Ie,a as v,c as g,j as we,K as N,bb as Se,a4 as D,bf as ke,bp as Ce,bd as Re,am as Ee,Z as Ne,b as De,aR as Me,b0 as Ae,z as Le,V as Fe}from"./vendor-antd-Dz3j4xaK.js";import"./vendor-utils-CsjRLf7T.js";import"./vendor-styling-BEMjND7I.js";import"./vendor-canvas-BRbMLhVA.js";const{Title:Te,Text:u}=Ie,{Option:I}=D,{RangePicker:_e}=ke,Be=()=>{var K;const w=pe(),M=je(),[A,G]=s.useState(1),[L,H]=s.useState(10),[p,F]=s.useState(""),[j,T]=s.useState(null),[y,_]=s.useState(null),[o,O]=s.useState(null),[Q,S]=s.useState(!1),[$,P]=s.useState(null),[k,Y]=s.useState(""),[z,V]=s.useState(""),[l,X]=s.useState("createdAt"),[r,q]=s.useState("descend"),[d,J]=be.useMessage(),[h,B]=s.useState(null),[U,C]=s.useState(0),{exhibitions:ee,loading:te}=ye(e=>e.exhibition);s.useEffect(()=>{M(he())},[M]);const{data:i,isLoading:W,refetch:ne}=xe({page:A,limit:L}),[se,{isLoading:ae}]=me(),ie=fe.useMemo(()=>i!=null&&i.data?i.data.filter(e=>{const n=p.toLowerCase(),a=p===""||e.invoiceNumber&&e.invoiceNumber.toLowerCase().includes(n)||e._id.toLowerCase().includes(n)||e.bookingId.customerName&&e.bookingId.customerName.toLowerCase().includes(n)||e.bookingId.companyName&&e.bookingId.companyName.toLowerCase().includes(n),c=!j||e.status===j,f=!y||e.bookingId.exhibitionId&&e.bookingId.exhibitionId._id===y;let x=!0;if(o&&o[0]&&o[1]){const b=E(e.createdAt);x=b.isAfter(o[0])&&b.isBefore(o[1])}return a&&c&&f&&x}):[],[i,p,j,y,o]),oe=async e=>{try{B(e),C(0),d.loading({content:"Preparing invoice...",key:e});const n=await ge(`/invoices/${e}/download?force=false`,!1,f=>{const x=f.total,b=f.loaded;if(x){const R=Math.round(b*100/x);C(R),R%25===0&&d.loading({content:`Downloading: ${R}% complete`,key:e})}}),a=window.URL.createObjectURL(new Blob([n.data])),c=document.createElement("a");c.href=a,c.setAttribute("download",`invoice-${e}.pdf`),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(a),d.success({content:"Invoice downloaded successfully",key:e})}catch(n){console.error("Download error:",n),d.error({content:"Failed to download invoice",key:e})}finally{B(null),C(0)}},le=async()=>{if(!(!$||!k))try{d.loading({content:"Sending email...",key:"email"}),await se({id:$,email:k,message:z||void 0}).unwrap(),d.success({content:"Invoice sent via email successfully",key:"email"}),S(!1),Y(""),V(""),P(null)}catch(e){console.error("Email error:",e),d.error({content:"Failed to send invoice via email",key:"email"})}},re=e=>{P(e),S(!0)},de=()=>{F(""),T(null),_(null),O(null)},ce=[{title:"Invoice #",dataIndex:["invoiceNumber"],key:"invoiceNumber",sorter:!0,sortOrder:l==="invoiceNumber"?r:null,render:(e,n)=>t.jsx("a",{onClick:()=>w(`/invoice/${n._id}`),children:e||"N/A"})},{title:"Company",dataIndex:["bookingId","companyName"],key:"companyName",sorter:!0,sortOrder:l==="companyName"?r:null,render:e=>e||"N/A"},{title:"Exhibition",dataIndex:["bookingId","exhibitionId","name"],key:"exhibitionName",sorter:!0,sortOrder:l==="exhibitionName"?r:null,render:(e,n)=>t.jsx("a",{onClick:()=>w(`/exhibition/${n.bookingId.exhibitionId._id}`),children:e})},{title:"Amount",dataIndex:"amount",key:"amount",sorter:!0,sortOrder:l==="amount"?r:null,render:e=>`â‚¹${e.toLocaleString("en-IN")}`},{title:"Status",dataIndex:"status",key:"status",sorter:!0,sortOrder:l==="status"?r:null,render:e=>t.jsx(De,{color:e==="paid"?"green":e==="pending"?"gold":e==="cancelled"?"red":"blue",children:e.toUpperCase()})},{title:"Due Date",dataIndex:"dueDate",key:"dueDate",sorter:!0,sortOrder:l==="dueDate"?r:null,render:e=>e?E(e).format("DD MMM YYYY"):"N/A"},{title:"Created",dataIndex:"createdAt",key:"createdAt",sorter:!0,sortOrder:l==="createdAt"?r:null,render:e=>E(e).format("DD MMM YYYY")},{title:"Actions",key:"actions",render:(e,n)=>t.jsxs(m,{direction:"vertical",size:"small",style:{width:"100%"},children:[t.jsxs(m,{children:[t.jsx(v,{title:"View Invoice",children:t.jsx(g,{type:"text",icon:t.jsx(Me,{}),onClick:()=>w(`/invoice/${n._id}`)})}),t.jsx(v,{title:"Download",children:t.jsx(g,{type:"text",icon:t.jsx(Ae,{}),onClick:()=>oe(n._id),loading:h===n._id&&U<100,disabled:h!==null&&h!==n._id})}),t.jsx(v,{title:"Email",children:t.jsx(g,{type:"text",icon:t.jsx(Le,{}),onClick:()=>re(n._id),disabled:h!==null})})]}),h===n._id&&t.jsx(Fe,{percent:U,size:"small",status:"active",style:{marginBottom:0,marginTop:4}})]})}],ue=(e,n,a)=>{a&&a.field&&(X(a.field),q(a.order||"descend"))};return t.jsxs(ve,{children:[J,t.jsxs("div",{className:"invoice-list-container",children:[t.jsx(Z,{children:t.jsxs(m,{direction:"vertical",style:{width:"100%"},size:"large",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(Te,{level:2,style:{margin:0},children:"Invoices"}),t.jsx(m,{children:t.jsx(v,{title:"Refresh",children:t.jsx(g,{icon:t.jsx(we,{}),onClick:()=>ne(),loading:W})})})]}),t.jsx(Z,{size:"small",title:t.jsxs(m,{children:[t.jsx(Re,{})," Filters"]}),children:t.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"16px"},children:[t.jsxs("div",{style:{minWidth:"200px",flex:1},children:[t.jsx(u,{strong:!0,children:"Search"}),t.jsx(N,{placeholder:"Search by invoice #, company...",value:p,onChange:e=>F(e.target.value),prefix:t.jsx(Se,{}),allowClear:!0})]}),t.jsxs("div",{style:{minWidth:"150px"},children:[t.jsx(u,{strong:!0,children:"Status"}),t.jsxs(D,{style:{width:"100%"},placeholder:"Filter by status",value:j,onChange:T,allowClear:!0,children:[t.jsx(I,{value:"pending",children:"Pending"}),t.jsx(I,{value:"paid",children:"Paid"}),t.jsx(I,{value:"cancelled",children:"Cancelled"})]})]}),t.jsxs("div",{style:{minWidth:"200px"},children:[t.jsx(u,{strong:!0,children:"Exhibition"}),t.jsx(D,{style:{width:"100%"},placeholder:"Filter by exhibition",value:y,onChange:_,loading:te,allowClear:!0,children:ee.map(e=>t.jsx(I,{value:e._id||e.id,children:e.name},e._id||e.id))})]}),t.jsxs("div",{style:{minWidth:"300px"},children:[t.jsx(u,{strong:!0,children:"Date Range"}),t.jsx(_e,{style:{width:"100%"},value:o,onChange:O})]}),t.jsx("div",{style:{display:"flex",alignItems:"flex-end"},children:t.jsx(g,{icon:t.jsx(Ce,{}),onClick:de,children:"Clear Filters"})})]})}),t.jsx(Ee,{columns:ce,dataSource:ie,rowKey:"_id",loading:W,pagination:{current:A,pageSize:L,total:((K=i==null?void 0:i.pagination)==null?void 0:K.total)||0,onChange:(e,n)=>{G(e),n&&H(n)},showSizeChanger:!0,showTotal:e=>`Total ${e} invoices`},onChange:ue})]})}),t.jsxs(Ne,{title:"Send Invoice via Email",open:Q,onCancel:()=>S(!1),onOk:le,okText:"Send",confirmLoading:ae,children:[t.jsxs("div",{style:{marginBottom:16},children:[t.jsx(u,{strong:!0,children:"Email Address"}),t.jsx(N,{placeholder:"Enter recipient email",value:k,onChange:e=>Y(e.target.value),style:{width:"100%"}})]}),t.jsxs("div",{children:[t.jsx(u,{strong:!0,children:"Message (Optional)"}),t.jsx(N.TextArea,{placeholder:"Enter optional message",value:z,onChange:e=>V(e.target.value),rows:4})]})]})]})]})};export{Be as default};
