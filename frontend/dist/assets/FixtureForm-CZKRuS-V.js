import{j as e,J as Xe,a as ot}from"./index-DoSueJxk.js";import{R as ee,g as rt,r as d}from"./vendor-react-dkbxt9Jf.js";import{L as je,G as xe,R as pe,T as ge,r as it,a as at,I as lt,C as dt,b as ct,c as ht,K as Ee,S as ut,F as mt,d as pt}from"./vendor-canvas-CSSoKFlf.js";import{K as z,ag as Ie,aF as J,M as ft,az as gt,aC as He,w as Ue,v as xt,S as Z,c as he,aI as bt,aJ as yt,J as $e,ab as K,D as Ae,$ as we,a0 as re,a1 as fe,R as _e,T as Be,W as Ne,aB as jt,af as wt,V as vt,ac as St,aK as Ct,aL as kt,aM as We,ad as It,aN as Rt,aO as Tt,Y as Mt,n as De,aP as Ft,aa as Et}from"./vendor-antd-mFVHvrVJ.js";import{c as Le}from"./stallUtils-DlikgrX5.js";import Pt from"./stall-BMZvk0fo.js";const qe=({width:t,height:n,scale:i=1,position:h={x:0,y:0},isSelected:r=!1,onSelect:S=()=>{},onChange:T=()=>{},children:c,isEditable:b=!0})=>{const g=$=>{b&&(S(),$.cancelBubble=!0)},w=ee.useMemo(()=>{const $=[];for(let R=0;R<=t;R+=5)$.push(e.jsx(je,{points:[R,0,R,n],stroke:"#e8e8e8",strokeWidth:1/i,dash:[5/i]},`v${R}`));for(let R=0;R<=n;R+=5)$.push(e.jsx(je,{points:[0,R,t,R],stroke:"#e8e8e8",strokeWidth:1/i,dash:[5/i]},`h${R}`));return $},[t,n,i]);return e.jsxs(xe,{x:h.x,y:h.y,width:t,height:n,onClick:g,children:[e.jsx(pe,{width:t,height:n,fill:"#ffffff",stroke:r&&b?"#1890ff":"#d9d9d9",strokeWidth:r&&b?2/i:1/i,shadowColor:"rgba(0,0,0,0.1)",shadowBlur:10/i,shadowOffset:{x:0,y:0},shadowOpacity:.5,cornerRadius:4/i}),e.jsx(xe,{children:w}),e.jsx(ge,{text:`${t}m × ${n}m`,fontSize:14/i,fill:"#666666",x:5,y:5}),c]})},zt=({visible:t,width:n,height:i,onCancel:h,onSubmit:r})=>{const[S]=z.useForm();ee.useEffect(()=>{t&&S.setFieldsValue({width:n,height:i})},[t,n,i,S]);const T=()=>{S.validateFields().then(c=>{r(c),S.resetFields()})};return e.jsx(Ie,{title:"Edit Exhibition Space",open:t,onCancel:()=>{S.resetFields(),h()},onOk:T,destroyOnHidden:!0,children:e.jsxs(z,{form:S,layout:"vertical",initialValues:{width:n,height:i},children:[e.jsx(z.Item,{name:"width",label:"Width (meters)",rules:[{required:!0,message:"Please enter width"},{type:"number",min:10,message:"Width must be at least 10 meters"}],children:e.jsx(J,{min:10,max:1e3,style:{width:"100%"},placeholder:"Enter width in meters"})}),e.jsx(z.Item,{name:"height",label:"Height (meters)",rules:[{required:!0,message:"Please enter height"},{type:"number",min:10,message:"Height must be at least 10 meters"}],children:e.jsx(J,{min:10,max:1e3,style:{width:"100%"},placeholder:"Enter height in meters"})})]})})},$t=({hall:t,isSelected:n=!1,onSelect:i,onChange:h,scale:r=1,position:S={x:0,y:0},exhibitionWidth:T=100,exhibitionHeight:c=100,isStallMode:b=!1})=>{const g=ee.useRef(null),w=ee.useRef(null),$=ee.useMemo(()=>{const M=[],{width:f,height:F}=t.dimensions,y=1,u=.5;for(let l=0;l<=f;l+=y)M.push(e.jsx(je,{points:[l,0,l,F],stroke:"#ddd",strokeWidth:1/r,dash:[2/r,2/r],listening:!1},`v-major-${l}`));for(let l=u;l<f;l+=y)M.push(e.jsx(je,{points:[l,0,l,F],stroke:"#e8e8e8",strokeWidth:.5/r,dash:[1/r,3/r],listening:!1},`v-minor-${l}`));for(let l=0;l<=F;l+=y)M.push(e.jsx(je,{points:[0,l,f,l],stroke:"#ddd",strokeWidth:1/r,dash:[2/r,2/r],listening:!1},`h-major-${l}`));for(let l=u;l<F;l+=y)M.push(e.jsx(je,{points:[0,l,f,l],stroke:"#e8e8e8",strokeWidth:.5/r,dash:[1/r,3/r],listening:!1},`h-minor-${l}`));return M},[t.dimensions.width,t.dimensions.height,r]);ee.useEffect(()=>{n&&w.current&&g.current&&(w.current.nodes([g.current]),w.current.getLayer()?.batchDraw())},[n]);const X=M=>{M.cancelBubble=!0;const f=M.target,F=f.x(),y=f.y(),u=Math.max(0,Math.min(F,T-t.dimensions.width)),l=Math.max(0,Math.min(y,c-t.dimensions.height));f.x(Math.round(u)),f.y(Math.round(l))},R=M=>{M.cancelBubble=!0;const f=M.target,F=Math.max(0,Math.min(f.x(),T-t.dimensions.width)),y=Math.max(0,Math.min(f.y(),c-t.dimensions.height));h?.({...t,_id:t._id,id:t.id||t._id,exhibitionId:t.exhibitionId,dimensions:{...t.dimensions,x:Math.round(F),y:Math.round(y)}})},D=M=>{M.cancelBubble=!0},q=M=>{if(!g.current)return;const f=g.current,F=f.scaleX(),y=f.scaleY();f.scaleX(1),f.scaleY(1);const u=Math.round(f.width()*F),l=Math.round(f.height()*y),j=f.x(),o=f.y(),p=Math.max(0,Math.min(j,T-u)),C=Math.max(0,Math.min(o,c-l));h?.({...t,_id:t._id,id:t.id||t._id,exhibitionId:t.exhibitionId,dimensions:{x:p,y:C,width:Math.max(5,Math.min(u,T-p)),height:Math.max(5,Math.min(l,c-C))}})},N=M=>{M.cancelBubble=!0,i?.(t)};return e.jsxs(xe,{ref:g,x:t.dimensions.x,y:t.dimensions.y,width:t.dimensions.width,height:t.dimensions.height,draggable:!b&&!!h,onClick:N,onTap:N,onDragStart:D,onDragMove:X,onDragEnd:R,onTransformEnd:q,children:[e.jsx(pe,{width:t.dimensions.width,height:t.dimensions.height,fill:"#ffffff",stroke:n?"#1890ff":"#d9d9d9",strokeWidth:n?2/r:1/r,shadowColor:"rgba(0,0,0,0.1)",shadowBlur:5/r,shadowOffset:{x:2/r,y:2/r},shadowOpacity:.5}),e.jsx(xe,{children:$}),e.jsx(ge,{text:t.name,fontSize:14/r,fill:"#000000",width:t.dimensions.width,align:"center",y:t.dimensions.height/2-7/r})]})};var _t=it();const Bt=rt(_t),At=t=>{if(!t)return"";const i=Xe.replace("/api",""),h=t.replace(/^\/?(api\/uploads\/)?/,"");if(h.includes("fixtures/"))return`${i}/api/uploads/${h}`;const r=localStorage.getItem("token");return r?`${i}/api/uploads/${h}?token=${r}`:""},Nt=({fixture:t,isSelected:n=!1,onSelect:i,onChange:h,scale:r=1,position:S={x:0,y:0},exhibitionWidth:T=100,exhibitionHeight:c=100,isEditable:b=!0})=>{const g=ee.useRef(null),w=ee.useRef(null),[$,X]=d.useState("");d.useEffect(()=>{if(t.icon){const l=At(t.icon);X(l)}else X("")},[t.icon]);const[R]=Bt($);ee.useEffect(()=>{n&&w.current&&g.current&&(w.current.nodes([g.current]),w.current.getLayer()?.batchDraw())},[n]);const D=l=>{l.cancelBubble=!0},q=l=>{l.cancelBubble=!0;const j=l.target,o=j.x(),p=j.y(),C=Math.max(0,Math.min(o,T-t.dimensions.width)),_=Math.max(0,Math.min(p,c-t.dimensions.height));j.x(Math.round(C)),j.y(Math.round(_))},N=l=>{l.cancelBubble=!0;const j=l.target,o=j.x(),p=j.y(),C=Math.max(0,Math.min(o,T-t.dimensions.width)),_=Math.max(0,Math.min(p,c-t.dimensions.height)),W=t._id||t.id;h?.({...t,_id:W,id:W,exhibitionId:t.exhibitionId,position:{x:Math.round(C),y:Math.round(_)}})},M=l=>{if(!g.current)return;const j=g.current,o=j.scaleX(),p=j.scaleY(),C=j.rotation();j.scaleX(1),j.scaleY(1);const _=Math.round(t.dimensions.width*o),W=Math.round(t.dimensions.height*p),B=j.x(),Y=j.y(),V=Math.max(0,Math.min(B,T-_)),v=Math.max(0,Math.min(Y,c-W)),E=t._id||t.id;h?.({...t,_id:E,id:E,exhibitionId:t.exhibitionId,position:{x:V,y:v},dimensions:{width:Math.max(.5,Math.min(_,T-V)),height:Math.max(.5,Math.min(W,c-v))},rotation:C})},f=l=>{l.cancelBubble=!0,i?.(t)},F=()=>{const l=t.borderColor||(n?"#1890ff":"#d9d9d9"),j=t.borderRadius!==void 0?t.borderRadius/r:3/r;return R?e.jsx(lt,{image:R,width:t.dimensions.width,height:t.dimensions.height,fill:t.color||"#ffffff",stroke:l,strokeWidth:n?2/r:1/r,cornerRadius:j,shadowColor:"rgba(0,0,0,0.1)",shadowBlur:5/r,shadowOffset:{x:2/r,y:2/r},shadowOpacity:.5}):e.jsx(pe,{width:t.dimensions.width,height:t.dimensions.height,fill:t.color||"#f0f2f5",stroke:l,strokeWidth:n?2/r:1/r,cornerRadius:j,shadowColor:"rgba(0,0,0,0.1)",shadowBlur:5/r,shadowOffset:{x:2/r,y:2/r},shadowOpacity:.5})},y=(l,j)=>`${Math.round(l)} m x ${Math.round(j)} m`,u=(l,j)=>{const o=Math.min(l,j)*.12,p=8/r,C=16/r;return Math.max(p,Math.min(C,o))};return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{ref:g,x:t.position.x,y:t.position.y,width:t.dimensions.width,height:t.dimensions.height,rotation:t.rotation||0,draggable:b&&!!h,onClick:f,onTap:f,onDragStart:D,onDragMove:q,onDragEnd:N,onTransformEnd:M,children:[F(),R&&t.name&&t.showName!==!1&&e.jsx(ge,{text:t.name,fontSize:12/r,fill:"#000000",width:t.dimensions.width,align:"center",y:-16/r}),!R&&e.jsxs(e.Fragment,{children:[t.name&&e.jsx(ge,{text:t.name,fontSize:u(t.dimensions.width,t.dimensions.height),fill:"#333333",fontStyle:"bold",width:t.dimensions.width,height:t.dimensions.height*.6,align:"center",verticalAlign:"middle",wrap:"word",x:0,y:t.dimensions.height*.2}),e.jsx(ge,{text:y(t.dimensions.width,t.dimensions.height),fontSize:u(t.dimensions.width,t.dimensions.height)*.8,fill:"#666666",width:t.dimensions.width,align:"center",x:0,y:t.dimensions.height*.75})]})]}),n&&b&&e.jsx(at,{ref:w,rotateEnabled:!0,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:(l,j)=>j.width<.5||j.height<.5?l:j})]})},Wt=({visible:t,x:n,y:i,onExhibitionClick:h,onHallClick:r,onStallClick:S,onFixtureClick:T,onClose:c})=>{if(!t)return null;const b=[{key:"exhibition",icon:e.jsx(gt,{}),label:"Exhibition Space",onClick:()=>{h(),c()}},{key:"hall",icon:e.jsx(He,{}),label:"Add Hall",onClick:()=>{r(),c()}}];return S&&b.push({key:"stall",icon:e.jsx(Ue,{}),label:"Add Stall",onClick:()=>{S(),c()}}),T&&b.push({key:"fixture",icon:e.jsx(xt,{}),label:"Add Fixture",onClick:()=>{T(),c()}}),e.jsx("div",{style:{position:"fixed",top:i,left:n,zIndex:1e3,boxShadow:"0 2px 8px rgba(0,0,0,0.15)",borderRadius:"4px",backgroundColor:"#fff",width:"200px"},children:e.jsx(ft,{items:b})})},qt=({dimensions:t,fill:n,stroke:i,strokeWidth:h,shadowColor:r="rgba(0,0,0,0.1)",shadowBlur:S=3,shadowOffset:T={x:1,y:1},shadowOpacity:c=.3,rotation:b=0,perfectDrawEnabled:g=!0,transformsEnabled:w="all",cornerRadius:$=.05})=>{const X=t.shapeType||"rectangle";if(X==="rectangle")return e.jsx(pe,{width:t.width,height:t.height,fill:n,stroke:i,strokeWidth:h,shadowColor:r,shadowBlur:S,shadowOffset:T,shadowOpacity:c,rotation:b,perfectDrawEnabled:g,transformsEnabled:w,cornerRadius:$});if(X==="l-shape"&&t.lShape){const{rect1Width:R,rect1Height:D,rect2Width:q,rect2Height:N,orientation:M}=t.lShape;let f=0,F=0,y=0,u=0,l=M;switch(M==="horizontal"?l="bottom-left":M==="vertical"&&(l="top-left"),l){case"top-left":f=0,F=0,y=R,u=0;break;case"top-right":f=q,F=0,y=0,u=0;break;case"bottom-left":f=0,F=0,y=R,u=D-N;break;case"bottom-right":f=q-R,F=0,y=0,u=D;break;default:f=0,F=N,y=R,u=0;break}return e.jsxs(xe,{children:[e.jsx(pe,{x:f,y:F,width:R,height:D,fill:n,stroke:i,strokeWidth:h,shadowColor:r,shadowBlur:S,shadowOffset:T,shadowOpacity:c,rotation:b,perfectDrawEnabled:g,transformsEnabled:w,cornerRadius:$}),e.jsx(pe,{x:y,y:u,width:q,height:N,fill:n,stroke:i,strokeWidth:h,shadowColor:r,shadowBlur:S,shadowOffset:T,shadowOpacity:c,rotation:b,perfectDrawEnabled:g,transformsEnabled:w,cornerRadius:$})]})}return e.jsx(pe,{width:t.width,height:t.height,fill:n,stroke:i,strokeWidth:h,shadowColor:r,shadowBlur:S,shadowOffset:T,shadowOpacity:c,rotation:b,perfectDrawEnabled:g,transformsEnabled:w,cornerRadius:$})},Yt=({stall:t,isSelected:n=!1,onSelect:i,onChange:h,hallWidth:r=0,hallHeight:S=0,hallX:T=0,hallY:c=0,scale:b=1,isDragging:g=!1,isLargeDataset:w=!1})=>{const $=d.useRef(null),[X,R]=d.useState(!1),[D,q]=d.useState(!1),[N,M]=d.useState(!1);d.useEffect(()=>{if(w)return;M(window.innerWidth<768);const k=()=>{M(window.innerWidth<768)};return window.addEventListener("resize",k),()=>window.removeEventListener("resize",k)},[w]),d.useEffect(()=>{if(!w)if(X&&!g)q(!0);else if(g)q(!1);else{const k=setTimeout(()=>{q(!1)},100);return()=>clearTimeout(k)}},[X,g,w]),d.useEffect(()=>{if(!w&&X&&$.current&&!g){if(N&&!n)return;$.current.getStage()&&$.current.moveToTop()}},[X,n,N,g,w]);const f=n||t.isSelected,F=d.useCallback(k=>{switch(k){case"available":return"#52c41a";case"booked":return"#faad14";case"reserved":return"#1890ff";default:return"#d9d9d9"}},[]),y=d.useCallback(k=>{switch(k){case"available":return"rgba(82, 196, 26, 0.2)";case"booked":return"rgba(250, 173, 20, 0.2)";case"reserved":return"rgba(24, 144, 255, 0.2)";default:return"rgba(217, 217, 217, 0.2)"}},[]),u=d.useCallback(k=>Math.round(k*2)/2,[]),l=d.useCallback(k=>{k.cancelBubble=!0;const H=k.target,G=H.x()-T,Q=H.y()-c,L=Math.max(0,Math.min(G,r-t.dimensions.width)),te=Math.max(0,Math.min(Q,S-t.dimensions.height)),le=u(L),ue=u(te);H.x(le+T),H.y(ue+c)},[T,c,r,S,t.dimensions.width,t.dimensions.height,u]),j=d.useCallback(k=>{if(k.cancelBubble=!0,!h)return;const H=k.target,G=H.x()-T,Q=H.y()-c,L=Math.max(0,Math.min(G,r-t.dimensions.width)),te=Math.max(0,Math.min(Q,S-t.dimensions.height)),le=u(L),ue=u(te);h({...t,id:t.id||t._id,_id:t._id||t.id,dimensions:{...t.dimensions,x:le,y:ue}})},[h,T,c,r,S,t,u]),o=d.useCallback(k=>{k.cancelBubble=!0},[]),p=d.useCallback(k=>{k.cancelBubble=!0,i&&!g&&i()},[i,g]),C=d.useCallback(()=>{w||N&&!f||g||R(!0)},[N,f,g,w]),_=d.useCallback(()=>{w||R(!1)},[w]),W={x:0,y:0,width:10,height:10},B=t.dimensions||W,Y=t.typeName||t.stallType?.name||(typeof t.stallTypeId=="object"?t.stallTypeId?.name:null)||"Standard",V=Le(B);t.ratePerSqm*V;const v=0,E=d.useMemo(()=>{const k=B.shapeType==="l-shape"?`L-Shape (${V.toFixed(1)} sqm)`:`${B.width}m x ${B.height}m`;return t.status!=="available"&&t.companyName?`${Y} - ${k} - ${t.companyName}`:`${Y} - ${k}`},[Y,B,V,t.status,t.companyName]);return e.jsxs(xe,{ref:$,x:B.x+T,y:B.y+c,width:B.width,height:B.height,draggable:!!h,onClick:p,onTap:p,onDragStart:o,onDragMove:l,onDragEnd:j,opacity:t.status==="available"?1:.7,cursor:t.status==="available"?"pointer":"default",onMouseEnter:C,onMouseLeave:_,listening:g?!1:!N||t.status==="available",transformsEnabled:g||N?"position":"all",children:[e.jsx(qt,{dimensions:B,fill:f?"rgba(24, 144, 255, 0.1)":y(t.status),stroke:f?"#1890ff":F(t.status),strokeWidth:f?2/b:1/b,shadowColor:w?"transparent":"rgba(0,0,0,0.1)",shadowBlur:w||g?0:N?2:3,shadowOffset:{x:1,y:1},shadowOpacity:w||g?0:.3,rotation:v,perfectDrawEnabled:!g&&!w,transformsEnabled:g?"position":"all",cornerRadius:w?0:.05}),e.jsx(ge,{text:t.number,fontSize:Math.min(B.width,B.height)*(w?.2:.25),fill:"#000000",width:B.width,height:B.height,align:"center",verticalAlign:"middle",transformsEnabled:"position",perfectDrawEnabled:!g&&!w,fontStyle:w?"normal":"bold",listening:!1,visible:!w||B.width>2}),f&&!g&&!w&&e.jsx(dt,{x:B.width-2,y:2,radius:Math.min(.8,B.width*.05),fill:"#1890ff",stroke:"#ffffff",strokeWidth:.2/b,transformsEnabled:"position",listening:!1}),D&&!g&&!w&&e.jsxs(ct,{x:B.width/2,y:-5/b,opacity:.9,listening:!1,children:[e.jsx(ht,{fill:"#333",cornerRadius:3/b,pointerDirection:"down",pointerWidth:6/b,pointerHeight:4/b,shadowColor:"rgba(0,0,0,0.3)",shadowBlur:2/b,shadowOffset:{x:1/b,y:1/b},shadowOpacity:.8}),e.jsx(ge,{text:E,fontFamily:"Arial",fontSize:Math.max(16/b,Math.min(22/b,B.width*.25/b)),padding:12/b,fill:"white",align:"center",width:Math.max(100/b,E.length*10/b),listening:!1})]})]})},Xt=d.memo(Yt),en=({width:t,height:n,exhibitionWidth:i=100,exhibitionHeight:h=100,halls:r=[],stalls:S=[],fixtures:T=[],selectedHall:c=null,selectedFixture:b=null,onSelectHall:g=()=>{},onSelectFixture:w=()=>{},onHallChange:$=()=>{},onFixtureChange:X=()=>{},onExhibitionChange:R=()=>{},onAddHall:D=()=>{},onAddStall:q=()=>{},onAddFixture:N=()=>{},children:M,isStallMode:f=!1,isFixtureMode:F=!1,isPublicView:y=!1})=>{const u=d.useRef(null),l=d.useRef(null),j=d.useRef(null),[o,p]=d.useState(1),[C,_]=d.useState({x:0,y:0}),[W,B]=d.useState(!1),[Y,V]=d.useState(!1),[v,E]=d.useState({visible:!1,x:0,y:0}),[k,H]=d.useState(!1),[G,Q]=d.useState(!1),[L,te]=d.useState(!1),[le,ue]=d.useState(void 0);d.useEffect(()=>{const a=()=>{te(window.innerWidth<768)};return a(),window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)}},[]);const Se=d.useCallback(()=>{if(!u.current)return null;const a=u.current,x=a.getAbsoluteTransform().copy().invert(),P=x.point({x:0,y:0}),m=x.point({x:a.width(),y:a.height()}),A=Math.max(i,h)*.1;return{left:P.x-A,top:P.y-A,right:m.x+A,bottom:m.y+A}},[i,h]),ne=d.useCallback((a,x,P,m)=>{const A=Se();return A?!(a+P<A.left||a>A.right||x+m<A.top||x>A.bottom):!0},[Se]),Re=d.useMemo(()=>!S||S.length===0?S:f&&S.length>50?S.filter(a=>{const x=r.find(A=>A.id===a.hallId||A._id===a.hallId);if(!x)return!1;const P=x.dimensions.x+a.dimensions.x,m=x.dimensions.y+a.dimensions.y;return ne(P,m,a.dimensions.width,a.dimensions.height)}):S,[S,r,f,ne]),de=S?.length>100,[,Te]=d.useState({}),Ce=d.useCallback(()=>{de&&Te({})},[de]),ie=d.useCallback((()=>{let a;return()=>{clearTimeout(a),a=setTimeout(Ce,100)}})(),[Ce]),Me=d.useCallback(a=>{if(a.evt.preventDefault(),!u.current)return;const x=u.current,P=o,m=x.getPointerPosition(),A={x:(m.x-x.x())/P,y:(m.y-x.y())/P},se=1.15,oe=a.evt.deltaY<0?P*se:P/se,me=Math.min(Math.max(.1,oe),20),ve={x:m.x-A.x*me,y:m.y-A.y*me};p(me),_(ve),ie()},[o,ie]),s=d.useCallback(()=>{if(!u.current)return;const a=u.current,x=Math.min(o*1.15,20),P=a.width()/2,m=a.height()/2,A={x:(P-C.x)/o,y:(m-C.y)/o},se={x:P-A.x*x,y:m-A.y*x};p(x),_(se),ie()},[o,C,ie]),I=d.useCallback(()=>{if(!u.current)return;const a=u.current,x=Math.max(o/1.15,.1),P=a.width()/2,m=a.height()/2,A={x:(P-C.x)/o,y:(m-C.y)/o},se={x:P-A.x*x,y:m-A.y*x};p(x),_(se),ie()},[o,C,ie]),U=d.useCallback(a=>{a?(ue(Ee.pixelRatio),Ee.pixelRatio=L?.8:1):le&&(Ee.pixelRatio=le)},[le,L]),O=d.useCallback(a=>{if(a.target===u.current&&(E({...v,visible:!1}),V(!0),U(!0),l.current)){if(y){const x=L?{x:-10,y:-10,width:t+20,height:n+20}:void 0;l.current.cache(x)}if(l.current.listening(!1),y&&u.current){const x=u.current.container();x.style.cursor="grabbing",x.classList.add("dragging"),u.current.batchDraw(),l.current.getChildren().forEach(m=>{if(m.shadowForStrokeEnabled&&(m._savedShadowForStroke=m.shadowForStrokeEnabled(),m.shadowForStrokeEnabled(!1)),m.perfectDrawEnabled&&(m._savedPerfectDraw=m.perfectDrawEnabled(),m.perfectDrawEnabled(!1)),m.cache&&!m.isCached&&m.width&&m.height){m._dragCached=!0;try{L?m.cache({offset:10,pixelRatio:.8}):m.cache()}catch{m._dragCached=!1}}})}}},[v,y,U,L,t,n]),ae=d.useCallback(a=>{if(y&&a.target===u.current){if(a.evt&&a.evt._dragSkipUpdate)return;if(a.evt&&(a.evt._dragSkipUpdate=!0),u.current&&l.current){const x=L?.85:.7;Math.random()>x&&u.current.batchDraw()}return}a.target===u.current&&L&&l.current&&(a.cancelBubble=!0)},[L,y]),be=d.useCallback(a=>{if(a.target===u.current){if(_({x:a.target.x(),y:a.target.y()}),U(!1),l.current&&(l.current.listening(!0),y&&l.current.clearCache(),y&&u.current)){const x=u.current.container();x.style.cursor="",x.classList.remove("dragging"),l.current.getChildren().forEach(m=>{m._savedShadowForStroke!==void 0&&(m.shadowForStrokeEnabled(m._savedShadowForStroke),delete m._savedShadowForStroke),m._savedPerfectDraw!==void 0&&(m.perfectDrawEnabled(m._savedPerfectDraw),delete m._savedPerfectDraw),m._dragCached&&(m.clearCache(),delete m._dragCached)})}setTimeout(()=>{u.current&&u.current.batchDraw()},50),V(!1),ie()}},[y,U,ie]),Fe=d.useCallback(()=>{B(!0),document.body.style.cursor=Y?"grabbing":"grab"},[Y]),ye=d.useCallback(()=>{B(!1),document.body.style.cursor="default"},[]),Ve=a=>{const x=a.target.getClassName();if(x==="Stage"||x==="Layer"){E({...v,visible:!1});return}if(x==="Group"||x==="Rect"){if(g(null),w(null),F){E({...v,visible:!1});return}const P=u.current?.getPointerPosition();if(P&&Oe(P)){const{x:m,y:A}=P,{x:se,y:oe}=u.current?.position()||{x:0,y:0},{x:me,y:ve}=u.current?.scale()||{x:1,y:1},nt=(m-se)/me,st=(A-oe)/ve;E({x:nt,y:st,visible:!0})}else E({...v,visible:!1})}else E({...v,visible:!1})},Oe=a=>{if(!i||!h||!u.current)return!1;const{x,y:P}=a,{x:m,y:A}=u.current.position(),{x:se}=u.current.scale(),oe={x:(x-m)/se,y:(P-A)/se};return oe.x>=0&&oe.x<=i&&oe.y>=0&&oe.y<=h},Ge=d.useCallback(()=>{g(null),w(null),H(!0),Q(!0),E({...v,visible:!1})},[g,w,v]),Ke=d.useCallback(a=>{R(a),Q(!1)},[R]),Ze=()=>{H(!0),Q(!0),E({...v,visible:!1})},Je=()=>{D(),E({...v,visible:!1})},Qe=()=>{q(),E({...v,visible:!1})};d.useEffect(()=>{if(t>0&&n>0&&i>0&&h>0){const a=f?20:40,x=t-a*2,P=n-a*2,m=x/i,A=P/h,oe=Math.min(m,A),me=(t-i*oe)/2,ve=(n-h*oe)/2;p(oe),_({x:me,y:ve}),u.current&&u.current.batchDraw()}},[t,n,i,h,f]);const et=ee.Children.map(M,a=>ee.isValidElement(a)?ee.cloneElement(a,{scale:o,position:C}):a),tt=e.jsx(qe,{width:i,height:h,scale:o,position:{x:0,y:0},isSelected:!1,onSelect:void 0,onChange:void 0,isEditable:!1});return t<=0||n<=0||i<=0||h<=0?e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"#fafafa"},children:"Loading..."}):e.jsxs("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#fafafa",cursor:W?Y?"grabbing":"grab":"default"},children:[e.jsx("div",{style:{position:"absolute",top:16,right:16,zIndex:1,display:"flex",gap:"8px"},children:e.jsxs(Z,{style:{background:"rgba(255, 255, 255, 0.9)",padding:"8px",borderRadius:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",backdropFilter:"blur(8px)"},children:[e.jsx(he,{icon:e.jsx(bt,{}),onClick:I,disabled:o<=.1,style:{borderRadius:"6px",display:"flex",alignItems:"center",justifyContent:"center"}}),e.jsxs("div",{style:{padding:"0 8px",fontSize:"14px",color:"#666",userSelect:"none"},children:[Math.round(o*100),"%"]}),e.jsx(he,{icon:e.jsx(yt,{}),onClick:s,disabled:o>=20,style:{borderRadius:"6px",display:"flex",alignItems:"center",justifyContent:"center"}})]})}),e.jsxs(ut,{ref:u,width:t,height:n,onClick:Ve,draggable:!0,onDragStart:O,onDragMove:ae,onDragEnd:be,onMouseEnter:Fe,onMouseLeave:ye,onWheel:Me,x:C.x,y:C.y,scaleX:o,scaleY:o,perfectDrawEnabled:!Y&&!y&&!de,listening:!Y,pixelRatio:de?Y?.5:.8:Y?L?.8:1:Math.min(1.5,window.devicePixelRatio||1),dragDistance:y?L?5:3:0,children:[y&&e.jsx(mt,{ref:j,listening:!1,children:tt}),e.jsxs(pt,{ref:l,imageSmoothingEnabled:!Y&&!de,perfectDrawEnabled:!Y&&!de,listening:!Y,children:[!y&&e.jsx(qe,{width:i,height:h,scale:o,position:{x:0,y:0},isSelected:k,onSelect:F?void 0:Ge,onChange:f||F?void 0:R,isEditable:!f&&!F}),r.map(a=>e.jsx($t,{hall:a,isSelected:c?.id===a.id,onSelect:()=>g(a),onChange:f||F?void 0:$,scale:o,position:{x:0,y:0},exhibitionWidth:i,exhibitionHeight:h,isStallMode:f||F},a._id||a.id)),Re.map(a=>{const x=a._id||a.id,P=r.find(m=>m.id===a.hallId||m._id===a.hallId);return P?e.jsx(Xt,{stall:{...a,_id:x,id:x},hallX:P.dimensions.x,hallY:P.dimensions.y,hallWidth:P.dimensions.width,hallHeight:P.dimensions.height,scale:o,isDragging:Y&&y},x):null}),[...T].sort((a,x)=>(a.zIndex||1)-(x.zIndex||1)).map(a=>{const x=a._id||a.id,m=(b?._id||b?.id)===x;return e.jsx(Nt,{fixture:{...a,_id:x,id:x},isSelected:m,onSelect:()=>w(a),onChange:F?X:void 0,scale:o,position:{x:0,y:0},exhibitionWidth:i,exhibitionHeight:h,isEditable:F},x)}),et]})]}),e.jsx(Wt,{visible:v.visible,x:v.x,y:v.y,onExhibitionClick:Ze,onHallClick:Je,onStallClick:Qe,onClose:()=>E({...v,visible:!1})}),e.jsx(zt,{visible:G,width:i,height:h,onCancel:()=>Q(!1),onSubmit:Ke})]})},{Title:Ht}=Be,tn=({visible:t,stall:n,hall:i,exhibition:h,onCancel:r,onSubmit:S,onDelete:T})=>{const[c]=z.useForm(),[b,g]=d.useState([]),[w,$]=d.useState(!1),[X,R]=d.useState("rectangle"),[D,q]=d.useState(0),N=o=>Math.round(o*2)/2,M=(o,p,C,_,W)=>{const Y=[...C].sort((v,E)=>{const k=Math.floor(v.dimensions.y/2.5),H=Math.floor(E.dimensions.y/2.5);return k===H?v.dimensions.x-E.dimensions.x:v.dimensions.y-E.dimensions.y}),V=(v,E)=>v+o>_||E+p>W?!1:!Y.some(k=>{const H=k.dimensions.x,G=k.dimensions.y,Q=k.dimensions.width,L=k.dimensions.height,te=1;return!(v+o+te<=H||v>=H+Q+te||E+p+te<=G||E>=G+L+te)});for(const v of Y){const E=N(v.dimensions.x+v.dimensions.width+.5),k=N(v.dimensions.y);if(V(E,k))return{x:E,y:k};const H=N(v.dimensions.x),G=N(v.dimensions.y+v.dimensions.height+.5);if(V(H,G))return{x:H,y:G}}for(let v=0;v<W;v+=.5)for(let E=0;E<_;E+=.5){const k=N(E),H=N(v);if(V(k,H))return{x:k,y:H}}return{x:0,y:0}};d.useEffect(()=>{if(n&&t){console.log("Setting form values for stall:",n);const o=n.dimensions.shapeType||"rectangle";R(o);let p;typeof n.stallTypeId=="string"?p=n.stallTypeId:n.stallTypeId&&typeof n.stallTypeId=="object"?p=n.stallTypeId._id||n.stallTypeId.id:p="";const C={number:n.number,stallTypeId:p,shapeType:o,width:n.dimensions.width,height:n.dimensions.height,rect1Width:n.dimensions.lShape?.rect1Width||0,rect1Height:n.dimensions.lShape?.rect1Height||0,rect2Width:n.dimensions.lShape?.rect2Width||0,rect2Height:n.dimensions.lShape?.rect2Height||0,orientation:n.dimensions.lShape?.orientation||"bottom-left",ratePerSqm:n.ratePerSqm,status:n.status};console.log("Form values to set:",C),setTimeout(()=>{c.setFieldsValue(C),R(o)},0),q(Le(n.dimensions))}else if(i&&t&&!n){const o=Math.min(20,i.dimensions.width/4),p=Math.min(20,i.dimensions.height/4);c.setFieldsValue({shapeType:"rectangle",status:"available",width:o,height:p,rect1Width:Math.floor(o*.6),rect1Height:p,rect2Width:Math.floor(o*.4),rect2Height:Math.floor(p*.6),orientation:"bottom-left",ratePerSqm:0}),R("rectangle"),q(o*p)}},[n,i,c,t]),d.useEffect(()=>{t||(c.resetFields(),R("rectangle"),q(0))},[t,c]),d.useEffect(()=>{t&&(async()=>{try{$(!0);const p=await Pt.getStallTypes();console.log("Fetched stall types:",p.data);const C=h.stallRates?.map(W=>W.stallTypeId)||[];console.log("Configured stall type IDs:",C);const _=p.data.filter(W=>W.status==="active"&&W._id&&C.includes(W._id));console.log("Filtered stall types:",_),g(_)}catch(p){console.error("Failed to fetch stall types:",p)}finally{$(!1)}})()},[t,h.stallRates]);const f=o=>{console.log("Stall type changed to:",o);const p=h.stallRates?.find(C=>C.stallTypeId===o);console.log("Found stall rate:",p),p&&c.setFieldsValue({ratePerSqm:p.rate})},F=o=>{R(o),y()},y=()=>{const o=c.getFieldsValue(),p=o.shapeType||"rectangle";if(p==="rectangle"){const C=(o.width||0)*(o.height||0);q(C)}else if(p==="l-shape"){const C=(o.rect1Width||0)*(o.rect1Height||0),_=(o.rect2Width||0)*(o.rect2Height||0);q(C+_)}},u=()=>{c.resetFields(),R("rectangle"),q(0),r()},l=()=>{if(console.log("Hall data:",i),!i||!i._id&&!i.id){Ne.error("Invalid hall selected. Please try again.");return}c.validateFields().then(o=>{const p=i._id||i.id;if(!p){Ne.error("Hall ID is missing. Please select a hall again.");return}const C=n?{x:n.dimensions.x,y:n.dimensions.y}:M(o.width,o.height,h.stalls?.filter(B=>B.hallId===p)||[],i.dimensions.width,i.dimensions.height),_=o.shapeType||"rectangle",W={id:n?.id,_id:n?._id,number:o.number,stallTypeId:o.stallTypeId,dimensions:{x:C.x,y:C.y,width:_==="rectangle"?o.width:Math.max(o.rect1Width,o.rect2Width),height:_==="rectangle"?o.height:Math.max(o.rect1Height,o.rect2Height),shapeType:_,..._==="l-shape"&&{lShape:{rect1Width:o.rect1Width,rect1Height:o.rect1Height,rect2Width:o.rect2Width,rect2Height:o.rect2Height,orientation:o.orientation}}},ratePerSqm:o.ratePerSqm,status:o.status,hallId:p};console.log("Submitting stall data:",W),S(W)})},j=o=>{switch(o){case"available":return"#52c41a";case"booked":return"#faad14";case"reserved":return"#1890ff";default:return"#d9d9d9"}};return e.jsx(e.Fragment,{children:e.jsx(Ie,{title:e.jsxs(Z,{children:[e.jsx(Ue,{style:{fontSize:"20px"}}),e.jsx(Ht,{level:4,style:{margin:0},children:n?"Edit Stall":"Add Stall"})]}),open:t,onCancel:u,destroyOnHidden:!0,forceRender:!0,width:480,centered:!0,footer:[e.jsxs(Z,{size:"middle",children:[n&&T&&e.jsx(he,{danger:!0,icon:e.jsx(_e,{}),onClick:()=>T(n),children:"Delete"}),e.jsx(he,{onClick:u,children:"Cancel"}),e.jsx(he,{type:"primary",onClick:l,children:n?"Save Changes":"Create"})]},"footer-buttons")],children:e.jsxs(z,{form:c,layout:"vertical",preserve:!1,requiredMark:"optional",style:{padding:"12px 0"},children:[e.jsx(z.Item,{name:"number",label:"Stall Number",rules:[{required:!0,message:"Please enter stall number"}],children:e.jsx($e,{placeholder:"Enter stall number",size:"large",style:{borderRadius:"6px"}})}),e.jsx(z.Item,{name:"stallTypeId",label:"Stall Type",rules:[{required:!0,message:"Please select stall type"}],children:e.jsx(K,{loading:w,placeholder:"Select stall type",size:"large",onChange:f,children:b.map(o=>e.jsx(K.Option,{value:o._id,children:o.name},o._id))})}),e.jsx(Ae,{orientation:"left",plain:!0,style:{margin:"24px 0"},children:"Shape & Dimensions"}),e.jsx(z.Item,{name:"shapeType",label:"Stall Shape",rules:[{required:!0,message:"Please select shape type"}],children:e.jsxs(K,{placeholder:"Select stall shape",size:"large",onChange:F,children:[e.jsx(K.Option,{value:"rectangle",children:e.jsxs(Z,{children:[e.jsx("span",{children:"📐"}),"Rectangle"]})}),e.jsx(K.Option,{value:"l-shape",children:e.jsxs(Z,{children:[e.jsx("span",{children:"📐"}),"L-Shape"]})})]})}),X==="rectangle"&&e.jsxs(we,{gutter:16,children:[e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"width",label:"Width (meters)",rules:[{required:!0,message:"Please enter width"},{type:"number",min:1,message:"Width must be at least 1 meter"},{type:"number",max:i?.dimensions.width||100,message:"Width cannot exceed hall width"}],children:e.jsx(J,{min:1,max:i?.dimensions.width||100,style:{width:"100%"},size:"large",placeholder:"Width",addonAfter:"m",onChange:y})})}),e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"height",label:"Height (meters)",rules:[{required:!0,message:"Please enter height"},{type:"number",min:1,message:"Height must be at least 1 meter"},{type:"number",max:i?.dimensions.height||100,message:"Height cannot exceed hall height"}],children:e.jsx(J,{min:1,max:i?.dimensions.height||100,style:{width:"100%"},size:"large",placeholder:"Height",addonAfter:"m",onChange:y})})})]}),X==="l-shape"&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{size:"small",title:"Rectangle 1 Dimensions",style:{marginBottom:"16px"},children:e.jsxs(we,{gutter:16,children:[e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"rect1Width",label:"Width (meters)",rules:[{required:!0,message:"Please enter width"},{type:"number",min:1,message:"Width must be at least 1 meter"}],children:e.jsx(J,{min:1,style:{width:"100%"},size:"large",placeholder:"Width",addonAfter:"m",onChange:y})})}),e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"rect1Height",label:"Height (meters)",rules:[{required:!0,message:"Please enter height"},{type:"number",min:1,message:"Height must be at least 1 meter"}],children:e.jsx(J,{min:1,style:{width:"100%"},size:"large",placeholder:"Height",addonAfter:"m",onChange:y})})})]})}),e.jsxs(fe,{size:"small",title:"Rectangle 2 Dimensions",style:{marginBottom:"16px"},children:[e.jsxs(we,{gutter:16,children:[e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"rect2Width",label:"Width (meters)",rules:[{required:!0,message:"Please enter width"},{type:"number",min:1,message:"Width must be at least 1 meter"}],children:e.jsx(J,{min:1,style:{width:"100%"},size:"large",placeholder:"Width",addonAfter:"m",onChange:y})})}),e.jsx(re,{span:12,children:e.jsx(z.Item,{name:"rect2Height",label:"Height (meters)",rules:[{required:!0,message:"Please enter height"},{type:"number",min:1,message:"Height must be at least 1 meter"}],children:e.jsx(J,{min:1,style:{width:"100%"},size:"large",placeholder:"Height",addonAfter:"m",onChange:y})})})]}),e.jsx(z.Item,{name:"orientation",label:"L-Shape Corner Placement",rules:[{required:!0,message:"Please select corner placement"}],children:e.jsxs(K,{placeholder:"Select corner placement",size:"large",children:[e.jsx(K.Option,{value:"top-left",children:e.jsxs(Z,{children:[e.jsx("span",{children:"┌"}),"Top-Left Corner"]})}),e.jsx(K.Option,{value:"top-right",children:e.jsxs(Z,{children:[e.jsx("span",{children:"┐"}),"Top-Right Corner"]})}),e.jsx(K.Option,{value:"bottom-left",children:e.jsxs(Z,{children:[e.jsx("span",{children:"└"}),"Bottom-Left Corner"]})}),e.jsx(K.Option,{value:"bottom-right",children:e.jsxs(Z,{children:[e.jsx("span",{children:"┘"}),"Bottom-Right Corner"]})})]})})]})]}),e.jsx(fe,{size:"small",style:{background:"#f6ffed",border:"1px solid #b7eb8f",marginBottom:"16px"},children:e.jsxs(we,{justify:"space-between",align:"middle",children:[e.jsx(re,{children:e.jsxs(Z,{children:[e.jsx("span",{style:{fontWeight:"bold",color:"#52c41a"},children:"📐 Total Area:"}),e.jsxs("span",{style:{fontSize:"16px",fontWeight:"bold",color:"#389e0d"},children:[D.toFixed(2)," sqm"]})]})}),e.jsx(re,{children:e.jsx("span",{style:{color:"#73d13d"},children:"Real-time calculation"})})]})}),e.jsx(Ae,{orientation:"left",plain:!0,style:{margin:"24px 0"},children:"Details"}),e.jsx(z.Item,{name:"ratePerSqm",label:"Rate per sq.m (₹)",rules:[{required:!0,message:"Please select a stall type to set the rate"}],children:e.jsx(J,{min:0,style:{width:"100%"},size:"large",placeholder:"Rate will be set based on stall type",prefix:"₹",disabled:!0,formatter:o=>`${o}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:o=>{const p=o?Number(o.replace(/\₹\s?|(,*)/g,"")):0;return isNaN(p)?0:p}})}),e.jsx(z.Item,{name:"status",label:"Status",rules:[{required:!0,message:"Please select status"}],children:e.jsxs(K,{placeholder:"Select status",size:"large",style:{borderRadius:"6px"},children:[e.jsx(K.Option,{value:"available",children:e.jsxs(Z,{children:[e.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:j("available")}}),"Available"]})}),e.jsx(K.Option,{value:"booked",children:e.jsxs(Z,{children:[e.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:j("booked")}}),"Booked"]})}),e.jsx(K.Option,{value:"reserved",children:e.jsxs(Z,{children:[e.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:j("reserved")}}),"Reserved"]})})]})})]})})})},Ye=t=>{if(!t)return"";const i=Xe.replace("/api",""),h=t.replace(/^\/?(api\/uploads\/)?/,"");if(h.includes("fixtures/"))return`${i}/api/uploads/${h}`;const r=localStorage.getItem("token");return r?`${i}/api/uploads/${h}?token=${r}`:""},Ut=({name:t,type:n,color:i,rotation:h,showName:r,iconUrl:S,defaultIcons:T,borderColor:c=null,borderRadius:b=0})=>{d.useEffect(()=>{console.log("FixturePreview rendering with props:",{name:t,type:n,color:i,rotation:h,showName:r,iconUrl:S,defaultIconAvailable:!!T[n],borderColor:c,borderRadius:b})},[t,n,i,h,r,S,T,c,b]);const g=T[n]||"📦";return e.jsxs("div",{style:{padding:"24px",textAlign:"center",backgroundColor:"#fafafa",borderBottom:"1px solid #f0f0f0",borderRadius:"8px 8px 0 0"},children:[e.jsx("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"120px",height:"120px",borderRadius:`${b||4}px`,backgroundColor:i||"#f0f0f0",transform:`rotate(${h}deg)`,transition:"all 0.3s ease",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",overflow:"hidden",position:"relative",border:c?`1px solid ${c}`:"1px solid rgba(0,0,0,0.05)"},children:S?e.jsx("img",{src:S,alt:t,style:{width:"100%",height:"100%",objectFit:"contain",padding:"8px"}}):e.jsx("div",{style:{fontSize:"48px",lineHeight:"1",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:g})}),r&&e.jsx("div",{style:{marginTop:"12px",fontSize:"16px",fontWeight:500,color:"#333"},children:t}),e.jsxs("div",{style:{marginTop:"4px",fontSize:"14px",color:"#888",display:"flex",gap:"8px",justifyContent:"center",alignItems:"center"},children:[e.jsx("span",{children:n.charAt(0).toUpperCase()+n.slice(1)}),e.jsx("span",{children:"•"}),e.jsx("span",{children:i}),h>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:[h,"°"]})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Border: ",c]})]}),b>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Radius: ",b,"px"]})]})]})]})},{Text:Dt}=Be,Pe=({activeKey:t,form:n,fixture:i,exhibitionWidth:h,exhibitionHeight:r,selectedType:S,showName:T,iconFileList:c,fixtureTypes:b,fixtureIcons:g,defaultColors:w,defaultDimensions:$,colorPresets:X,uploadProps:R,iconPreviewVisible:D=!1,previewImage:q="",onTypeChange:N,onColorChange:M,onShowNameChange:f,onIconPreviewCancel:F=()=>{}})=>{switch(t){case"basic":return y();case"position":return u();case"appearance":return l();default:return y()}function y(){return e.jsxs("div",{className:"tab-content",children:[e.jsx(z.Item,{name:"name",label:"Fixture Name",rules:[{required:!0,message:"Please enter fixture name"}],children:e.jsx($e,{placeholder:"Enter fixture name",prefix:e.jsx(vt,{style:{color:"#aaa"}}),style:{borderRadius:"8px"}})}),e.jsx(z.Item,{name:"showName",label:"Show Name on Layout",tooltip:"Toggle whether the fixture name appears on the layout",valuePropName:"checked",children:e.jsx(St,{defaultChecked:!0,checkedChildren:"Visible",unCheckedChildren:"Hidden",onChange:j=>{f(j),console.log("Form values after showName toggle:",n.getFieldsValue(!0))}})}),e.jsx(z.Item,{name:"type",label:"Fixture Type",rules:[{required:!0,message:"Please select fixture type"}],children:e.jsx(K,{placeholder:"Select fixture type",onChange:N,options:b.map(j=>({...j,label:e.jsxs(Z,{children:[e.jsx("span",{style:{fontSize:16},children:g[j.value]}),e.jsx("span",{children:j.label})]})})),style:{width:"100%",borderRadius:"8px"},listHeight:300,dropdownStyle:{borderRadius:"8px"}})})]})}function u(){return e.jsxs("div",{className:"tab-content",children:[e.jsx(fe,{size:"small",title:"Position (meters)",style:{marginBottom:16,borderRadius:8},styles:{body:{padding:"12px 16px"}},children:e.jsxs(we,{gutter:16,children:[e.jsx(re,{span:12,children:e.jsx(z.Item,{name:["position","x"],label:"X Position",rules:[{required:!0,message:"X position is required"}],children:e.jsx(J,{style:{width:"100%",borderRadius:"8px"},min:0,max:h,step:.1,precision:1,placeholder:"X position"})})}),e.jsx(re,{span:12,children:e.jsx(z.Item,{name:["position","y"],label:"Y Position",rules:[{required:!0,message:"Y position is required"}],children:e.jsx(J,{style:{width:"100%",borderRadius:"8px"},min:0,max:r,step:.1,precision:1,placeholder:"Y position"})})})]})}),e.jsx(fe,{size:"small",title:"Dimensions (meters)",style:{marginBottom:16,borderRadius:8},styles:{body:{padding:"12px 16px"}},children:e.jsxs(we,{gutter:16,children:[e.jsx(re,{span:12,children:e.jsx(z.Item,{name:["dimensions","width"],label:"Width",rules:[{required:!0,message:"Width is required"}],children:e.jsx(J,{style:{width:"100%",borderRadius:"8px"},min:.5,max:20,step:.1,precision:1,placeholder:"Width"})})}),e.jsx(re,{span:12,children:e.jsx(z.Item,{name:["dimensions","height"],label:"Height",rules:[{required:!0,message:"Height is required"}],children:e.jsx(J,{style:{width:"100%",borderRadius:"8px"},min:.5,max:20,step:.1,precision:1,placeholder:"Height"})})})]})}),e.jsx(fe,{size:"small",title:e.jsxs("span",{children:[e.jsx(kt,{})," Rotation (degrees)"]}),style:{borderRadius:8},styles:{body:{padding:"12px 16px"}},children:e.jsx(z.Item,{name:"rotation",noStyle:!0,children:e.jsx(Ct,{min:0,max:360,marks:{0:"0°",90:"90°",180:"180°",270:"270°",360:"360°"},tooltip:{formatter:j=>`${j}°`},style:{marginTop:10},keyboard:!1})})})]})}function l(){return e.jsxs("div",{className:"tab-content",children:[e.jsx(z.Item,{name:"color",label:"Color",tooltip:"Choose a color for the fixture. This affects the background color and tint applied to SVG icons.",rules:[{validator:(j,o)=>{try{return o?Promise.resolve():Promise.reject("Please select a color")}catch{return Promise.reject("Please enter a valid color value")}}}],children:e.jsx(We,{format:"hex",allowClear:!0,showText:!0,disabledAlpha:!0,presets:X,onChange:M,style:{width:"100%"}})}),e.jsx(z.Item,{name:"borderColor",label:"Border Color",tooltip:"Choose a border color for the fixture. Leave empty for default borders.",children:e.jsx(We,{format:"hex",allowClear:!0,showText:!0,disabledAlpha:!0,presets:X,style:{width:"100%"}})}),e.jsx(z.Item,{name:"borderRadius",label:"Border Radius",tooltip:"Set the corner radius in pixels. Higher values make more rounded corners.",children:e.jsx(J,{min:0,max:20,step:1,style:{width:"100%",borderRadius:"8px"},addonAfter:"px"})}),e.jsxs(fe,{size:"small",title:"Icon Upload",style:{borderRadius:8,marginBottom:16,marginTop:16},styles:{body:{padding:"16px"}},children:[e.jsx("div",{style:{marginBottom:0},children:e.jsx(It,{...R,children:c.length<1&&e.jsxs("div",{children:[e.jsx(Rt,{style:{fontSize:20}}),e.jsx("div",{style:{marginTop:8},children:"Upload Icon"})]})})}),e.jsx(Dt,{type:"secondary",style:{display:"block",marginTop:12},children:"Upload a custom icon or use the default icon for the selected fixture type. Supported formats: PNG, JPG, SVG. SVG icons are preferred for better quality at all sizes."})]}),e.jsx(z.Item,{name:"icon",label:"Icon URL",tooltip:"URL to an icon image for this fixture. Will be used if no icon is uploaded.",children:e.jsx($e,{placeholder:"https://example.com/icon.png",prefix:e.jsx(Tt,{style:{color:"#aaa"}}),style:{borderRadius:"8px"}})}),e.jsx(Ie,{open:D,title:"Icon Preview",footer:null,onCancel:F,children:e.jsx("img",{alt:"Icon Preview",style:{width:"100%"},src:q})})]})}},Lt=t=>[{key:"basic",label:e.jsxs("span",{children:[e.jsx(He,{}),"Basic Info"]}),children:e.jsx(Pe,{...t,activeKey:"basic"})},{key:"position",label:e.jsxs("span",{children:[e.jsx(jt,{}),"Position"]}),children:e.jsx(Pe,{...t,activeKey:"position"})},{key:"appearance",label:e.jsxs("span",{children:[e.jsx(wt,{}),"Appearance"]}),children:e.jsx(Pe,{...t,activeKey:"appearance"})}],{Text:nn,Title:sn}=Be,{TabPane:on}=De,Vt=[{value:"sofa",label:"Sofa"},{value:"chair",label:"Chair"},{value:"table",label:"Table"},{value:"desk",label:"Desk"},{value:"plant",label:"Plant"},{value:"entrance",label:"Entrance"},{value:"exit",label:"Exit"},{value:"info",label:"Information"},{value:"restroom",label:"Restroom"},{value:"food",label:"Food Area"},{value:"custom",label:"Custom"}],ke={sofa:{width:2,height:1},chair:{width:5,height:5},table:{width:1,height:1},desk:{width:2,height:.8},plant:{width:.5,height:.5},entrance:{width:1.5,height:.2},exit:{width:1.5,height:.2},info:{width:1,height:1},restroom:{width:1,height:1},food:{width:2,height:2},custom:{width:1,height:1}},ce={sofa:"#a0d0ff",chair:"#a0d0ff",table:"#e0e0e0",desk:"#e0e0e0",plant:"#90ee90",entrance:"#98fb98",exit:"#ffcccb",info:"#add8e6",restroom:"#d8bfd8",food:"#ffe4b5",custom:"#f0f0f0"},ze={sofa:"🛋️",chair:"🪑",table:"🪟",desk:"🖥️",plant:"🪴",entrance:"🚪",exit:"🚪",info:"ℹ️",restroom:"🚻",food:"🍽️",custom:"📦"},rn=({visible:t,fixture:n,onCancel:i,onSubmit:h,onDelete:r,exhibitionWidth:S,exhibitionHeight:T})=>{const[c]=z.useForm(),[b,g]=d.useState(!1),[w,$]=d.useState(""),[X,R]=d.useState("basic"),[D,q]=d.useState(""),[N,M]=d.useState([]),[f,F]=d.useState(!1),[y,u]=d.useState(""),{message:l}=Mt.useApp(),[j,o]=d.useState("#f0f0f0"),[p,C]=d.useState("New Fixture"),[_,W]=d.useState("chair"),[B,Y]=d.useState(0),[V,v]=d.useState(!0),[E,k]=d.useState(null),[H,G]=d.useState(0);d.useEffect(()=>{if(t)if(n){const s=ne(n.color),I=ce[n.type]||"#f0f0f0",U=s||I;console.log("Setting up fixture colors:",{original:n.color,normalized:s,fallback:I,final:U}),o(U),C(n.name),W(n.type),Y(n.rotation||0),$(n.type),v(n.showName!==!1),k(n.borderColor||null),G(n.borderRadius||0)}else{const s="chair",I=ce[s];o(I),C("New Fixture"),W(s),Y(0),$(s),v(!0),k(null),G(0)}},[t,n]),d.useEffect(()=>{if(t&&c){if(n){const s=ne(n.color),I=ce[n.type]||"#f0f0f0",U=s||I;c.setFieldsValue({name:n.name,type:n.type,position:{x:n.position.x,y:n.position.y},dimensions:{width:n.dimensions.width,height:n.dimensions.height},rotation:n.rotation||0,color:U,icon:n.icon||"",showName:n.showName!==!1,borderColor:n.borderColor||null,borderRadius:n.borderRadius||0});const O=n.icon?Ye(n.icon):"";q(O),n.icon?M([{uid:"-1",name:n.icon.split("/").pop()||"icon",status:"done",url:O,thumbUrl:O}]):M([])}else{const s="chair",I=ce[s];c.setFieldsValue({name:"New Fixture",type:s,position:{x:Math.floor(S/2),y:Math.floor(T/2)},dimensions:ke[s],rotation:0,color:I,icon:"",showName:!0,borderColor:null,borderRadius:0}),q(""),M([])}R("basic")}},[t,n,c,S,T]);const Q=()=>{if(c&&t)try{const s=c.getFieldsValue(!0);if(s.name&&C(s.name),s.type&&W(s.type),s.rotation!==void 0&&Y(s.rotation),s.color){const I=ne(s.color);I&&o(I)}if(s.showName!==void 0&&v(s.showName),s.borderColor!==void 0){const I=s.borderColor?ne(s.borderColor):null;k(I)}s.borderRadius!==void 0&&G(s.borderRadius)}catch(s){console.log("Error updating preview",s)}};d.useEffect(()=>{if(c&&t)return c.getFieldsValue,Q(),()=>{}},[c,t]);const L=s=>{if($(s),W(s),!n){const I=ce[s]||ce.custom;c.setFieldsValue({dimensions:ke[s]||ke.custom,color:I}),o(I)}},te=s=>{const I=ne(s);c.setFieldValue("color",I),o(I);const U=Object.entries(ce).find(([O,ae])=>ae.toLowerCase()===I.toLowerCase());U&&!n&&(c.setFieldValue("type",U[0]),$(U[0]),W(U[0]))},le=()=>(console.log("Rendering fixture preview with:",{name:p,type:_,color:j,rotation:B,showName:V,iconUrl:D,borderColor:E,borderRadius:H}),e.jsx(Ut,{name:p,type:_,color:j,rotation:B,showName:V,iconUrl:D,defaultIcons:ze,borderColor:E,borderRadius:H})),ue=({file:s,fileList:I})=>{if(s.status==="uploading"&&M(I),s.status==="done"){l.success(`${s.name} uploaded successfully`);let O=(s.response?.url||"").replace(/^\/api\/uploads\//,"");O&&!O.startsWith("fixtures/")&&(O=`fixtures/${O.replace(/^\//,"")}`),console.log("Icon path stored in form:",O),c.setFieldValue("icon",O);const ae=Ye(O);console.log("Using direct backend URL:",ae),q(ae);const be=s.name.toLowerCase().endsWith(".svg"),Fe=I.map(ye=>ye.uid===s.uid?{...ye,url:ae,thumbUrl:ae,type:be?"image/svg+xml":ye.type}:ye);M(Fe),console.log("Form values after icon upload:",c.getFieldsValue(!0))}s.status==="error"&&(l.error(`${s.name} upload failed.`),M(I.filter(U=>U.uid!==s.uid)))},Se={name:"file",action:`${ot.defaults.baseURL}/fixtures/upload/icons`,headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},accept:"image/png,image/jpeg,image/jpg,image/svg+xml",listType:"picture-card",fileList:N,onChange:ue,onPreview:s=>{u(s.url||s.thumbUrl||""),F(!0)},onRemove:()=>(q(""),M([]),c.setFieldValue("icon",""),console.log("Form values after icon removal:",c.getFieldsValue(!0)),!0),maxCount:1,showUploadList:{showPreviewIcon:!0,showRemoveIcon:!0,showDownloadIcon:!1,removeIcon:e.jsx(_e,{style:{color:"#ff4d4f"}})}},ne=s=>{try{if(!s)return"#f0f0f0";if(typeof s=="object"&&s!==null){if(typeof s.toHexString=="function")return s.toHexString();if(s.rgb||s.hex)return s.hex||`rgb(${s.rgb.r},${s.rgb.g},${s.rgb.b})`}if(typeof s=="string"){if(/^#([0-9A-F]{3}){1,2}$/i.test(s))return s;if(/^([0-9A-F]{3}){1,2}$/i.test(s))return`#${s}`;if(/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/.test(s))return s}return"#f0f0f0"}catch(I){return console.error("Error normalizing color:",I),"#f0f0f0"}},Re=[{label:"Primary Colors",colors:["#1890ff","#52c41a","#faad14","#f5222d","#722ed1"]},{label:"Neutrals",colors:["#000000","#262626","#595959","#8c8c8c","#bfbfbf","#d9d9d9","#f0f0f0","#ffffff"]}],de=ee.useCallback(()=>{n&&r&&r(n)},[n,r]),Te=s=>{R(s),document.activeElement instanceof HTMLElement&&document.activeElement.blur()},Ce=Lt({form:c,fixture:n,exhibitionWidth:S,exhibitionHeight:T,selectedType:w,showName:V,iconFileList:N,fixtureTypes:Vt,fixtureIcons:ze,defaultColors:ce,defaultDimensions:ke,colorPresets:Re,uploadProps:Se,iconPreviewVisible:f,previewImage:y,onTypeChange:L,onColorChange:te,onShowNameChange:s=>v(s),onIconPreviewCancel:()=>F(!1),activeKey:X}),ie=async()=>{try{g(!0);const s=await c.validateFields();C(s.name),W(s.type),Y(s.rotation||0),o(ne(s.color)),v(s.showName),k(s.borderColor?ne(s.borderColor):null),G(s.borderRadius||0);let I="";s.icon!==void 0?I=s.icon?Me(s.icon):"":n?.icon&&(I=n.icon),console.log("Form values being submitted:",{name:s.name,type:s.type,color:s.color,icon:s.icon,originalIcon:n?.icon,cleanedIcon:I,showName:s.showName,borderColor:s.borderColor,borderRadius:s.borderRadius});const U=n?._id||n?.id||"",O=s.color?ne(s.color):n?.color||"#f0f0f0",ae=s.borderColor?ne(s.borderColor):null,be={...n,id:U,_id:U,name:s.name,type:s.type,position:s.position,dimensions:s.dimensions,rotation:s.rotation,color:O,icon:I,zIndex:n?.zIndex||1,isActive:n?.isActive!==void 0?n.isActive:!0,borderColor:ae,borderRadius:s.borderRadius||0};U&&(be.showName=s.showName),console.log("Submitting fixture with icon path:",I),console.log("Color being submitted:",O),await h(be),i()}catch(s){console.error("Fixture submission failed:",s),l.error("Failed to save fixture. Please check the form and try again.")}finally{g(!1)}},Me=s=>{if(!s||typeof s!="string")return"";if(s.startsWith("fixtures/")&&!s.includes("?")&&!s.includes("http"))return s;let I=s.replace(/^\/api\/uploads\//,"");if(I=I.replace(/^\//,""),I.includes("?")||I.includes("http")){const U=I.split("?")[0].split("/").pop()||"";if(U)return`fixtures/${U}`}return I&&!I.startsWith("fixtures/")?`fixtures/${I}`:I};return e.jsxs(Ie,{title:e.jsxs("div",{style:{padding:"8px 0",display:"flex",alignItems:"center"},children:[e.jsx("span",{style:{fontSize:24,marginRight:8},children:n?ze[n.type]:"🪑"}),e.jsx("span",{children:n?`Edit ${n.name}`:"Add New Fixture"})]}),open:t,onCancel:i,confirmLoading:b,footer:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:n&&r&&e.jsx(he,{danger:!0,icon:e.jsx(_e,{}),onClick:de,style:{borderRadius:"6px"},children:"Delete"})}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx(he,{onClick:i,icon:e.jsx(Ft,{}),style:{borderRadius:"6px"},children:"Cancel"}),e.jsx(he,{type:"primary",onClick:ie,icon:e.jsx(Et,{}),style:{borderRadius:"6px"},children:n?"Update":"Create"})]})]}),width:560,centered:!0,styles:{header:{borderBottom:"1px solid #f0f0f0",padding:"16px 24px"},body:{backgroundColor:"#fff",borderRadius:"0 0 8px 8px",padding:"0"},footer:{borderTop:"1px solid #f0f0f0",padding:"12px 24px",margin:0}},children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:`
        .svg-icon {
          filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.2));
        }
        
        /* Fix for passive event listener warnings */
        .ant-slider, .ant-slider-handle, .ant-color-picker-trigger, .ant-color-picker-dropdown {
          touch-action: none !important;
        }
        
        .ant-slider-rail, .ant-slider-track {
          touch-action: pan-y !important;
        }
        
        .ant-tabs-tab, .ant-select-selector, .ant-input-number-input, .ant-color-picker-slider, .ant-color-picker-palette {
          touch-action: manipulation !important;
        }
        
        /* Fix circular references warning */
        .ant-color-picker-trigger-disabled .ant-color-picker-clear {
          display: none;
        }
      `}}),le(),e.jsx(z,{form:c,layout:"vertical",initialValues:{name:"New Fixture",type:"chair",position:{x:0,y:0},dimensions:{width:1,height:1},rotation:0,color:"#f0f0f0",icon:"",showName:!0,borderColor:null,borderRadius:0},style:{padding:"0 24px 20px"},onValuesChange:Q,children:e.jsx(De,{activeKey:X,onChange:Te,items:Ce,tabBarStyle:{marginBottom:16},centered:!0})})]})};export{en as C,rn as F,Xt as S,tn as a};
