import{F as C,j as r,P as q,Q as G,S as Z,R as ee,I as te,J as ie,K as E,D as _}from"./index-BP1I9PmK.js";import{l as ae,k as se,u as L,j as ne,X as re,i as A,r as c}from"./vendor-react-BNeW3y6d.js";import"./vendor-canvas-BRbMLhVA.js";import{af as oe,a6 as le,S as de,c as k,be as ce,a_ as he,aV as fe}from"./vendor-antd-DhcJxEc5.js";import"./vendor-utils-j652IAQy.js";import"./vendor-styling-BBrlYwaV.js";const ue=({exhibitionId:a,destination:j="layout",label:D="Back to Layout"})=>{const h=L(),{currentExhibition:f}=A(w=>w.exhibition);return r.jsxs("div",{style:{marginBottom:"24px",position:"sticky",top:"16px",zIndex:10},children:[r.jsx(k,{icon:r.jsx(fe,{}),onClick:()=>h(C(f,j),{state:{exhibitionId:a}}),type:"default",size:"large",style:{borderRadius:"8px",boxShadow:"0 2px 6px rgba(0,0,0,0.08)",background:"white",borderColor:"transparent",fontWeight:500,padding:"0 16px",height:"42px",display:"flex",alignItems:"center",transition:"all 0.3s ease"},className:"back-button-hover",children:r.jsx("span",{style:{marginLeft:8},children:D})}),r.jsx("style",{children:`
        .back-button-hover:hover {
          transform: translateX(-5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          background: #f0f5ff;
          border-color: #d6e4ff;
        }
      `})]})},Ie=()=>{var P,R,z;const{message:a}=oe.useApp(),{id:j}=ae(),D=se(),h=L(),f=ne(),[w,g]=re(),s=((P=D.state)==null?void 0:P.exhibitionId)||j,{currentExhibition:d,halls:o,stalls:M,loading:T}=A(e=>e.exhibition),b=c.useRef(null),[N,I]=c.useState(!1),[t,v]=c.useState(null),[u,y]=c.useState(null),[F,W]=c.useState({width:0,height:0}),[x,H]=c.useState(!1);c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibitions");return}},[s,h,a]),c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibition");return}(async()=>{try{await f(te(s)).unwrap(),await f(ie(s)).unwrap(),H(!0)}catch{a.error("Failed to load data")}})()},[s,f,h]),c.useEffect(()=>{var e,i;!x||!d||(!((e=d.dimensions)!=null&&e.width)||!((i=d.dimensions)!=null&&i.height))&&(a.info("Please set up exhibition space first"),h(C(d,"space"),{state:{exhibitionId:s}}))},[d,s,h,x]),c.useEffect(()=>{!x||T||o.length===0&&(a.info("Please create halls first"),h(C(d,"halls"),{state:{exhibitionId:s}}))},[o,s,h,T,x]),c.useEffect(()=>{x&&d&&o.length>0&&(async()=>{try{const i=o.map(n=>f(E({exhibitionId:s,hallId:n.id})).unwrap());await Promise.all(i)}catch(i){console.error("Error fetching stalls:",i),a.error("Failed to load stalls")}})()},[d,s,o,f,x]);const U=M.filter(e=>e.hallId===((t==null?void 0:t.id)||(t==null?void 0:t._id)));c.useEffect(()=>{if(!x||o.length===0)return;const e=w.get("hallId");if(e){const i=o.find(n=>n.id===e||n._id===e);if(i)v(i);else if(o.length>0){v(o[0]);const n=o[0].id||o[0]._id;n&&g({hallId:n.toString()})}}else if(o.length>0){v(o[0]);const i=o[0].id||o[0]._id;i&&g({hallId:i.toString()})}},[o,w,x,g]),c.useEffect(()=>{const e=()=>{if(b.current){const{clientWidth:n,clientHeight:l}=b.current;W({width:Math.max(n||400,400),height:Math.max(l||400,400)})}};e();const i=new ResizeObserver(e);return b.current&&i.observe(b.current),window.addEventListener("resize",e),()=>{i.disconnect(),window.removeEventListener("resize",e)}},[]);const V=()=>{if(!t){a.warning("Please select a hall first");return}y(null),I(!0)},X=e=>{if(v(e),y(null),e){const i=e.id||e._id;g(i?{hallId:i.toString()}:{})}else g({})},$=e=>{var n;const i=e?{...e,id:e.id||e._id,_id:e._id||e.id,stallTypeId:typeof e.stallTypeId=="string"?e.stallTypeId:((n=e.stallTypeId)==null?void 0:n._id)||e.stallTypeId,stallType:e.stallType}:null;console.log("Selected stall data:",i),y(i),I(!!i)},O=async e=>{var i,n;try{if(!(t!=null&&t.id)&&!(t!=null&&t._id)){a.error("No hall selected");return}const l=t.id,p=t._id||t.id;if(e.hallId&&e.hallId!==p){a.error("Cannot move stall to a different hall");return}if(console.log("Submitting stall data:",e),e.id||e._id){const S={...e,id:e.id,_id:e._id,hallId:p,stallTypeId:e.stallTypeId};console.log("Update data:",S);const m=e.id||e._id;if(!m)throw new Error("Stall ID is missing");await _.updateStall(s,m,S),a.success("Stall updated successfully")}else{const{id:S,_id:m,...Y}=e,B={...Y,hallId:p,stallTypeId:e.stallTypeId};console.log("Creating new stall with data:",B),await _.createStall(s,B),a.success("Stall created successfully")}I(!1),f(E({exhibitionId:s,hallId:l}))}catch(l){console.error("Error saving stall:",l),a.error(((n=(i=l.response)==null?void 0:i.data)==null?void 0:n.message)||"Failed to save stall")}},J=async e=>{var i,n;try{if(!s){a.error("Exhibition ID not found");return}const l=t;if(!l){a.error("No hall selected");return}const p=l.id||l._id;if(!p){a.error("Invalid hall ID");return}await _.deleteStall(s,e),I(!1),y(null),await f(E({exhibitionId:s,hallId:p})).unwrap(),a.success("Stall deleted successfully")}catch(l){console.error("Error deleting stall:",l),a.error(((n=(i=l.response)==null?void 0:i.data)==null?void 0:n.message)||"Failed to delete stall")}},K=async e=>{var p,S;if(!s){a.error("Exhibition ID not found");return}const i=e.id||e._id;if(!i){console.error("Stall data:",e),a.error("Stall ID not found");return}if(!(t!=null&&t.id)&&!(t!=null&&t._id)){a.error("No hall selected");return}const n=t.id,l=t._id||t.id;try{await _.updateStall(s,i,{...e,id:i,hallId:l}),f(E({exhibitionId:s,hallId:n}))}catch(m){console.error("Stall update error:",m),a.error(((S=(p=m.response)==null?void 0:p.data)==null?void 0:S.message)||"Failed to update stall position")}},Q=()=>{I(!1),y(null)};return r.jsx(q,{children:r.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column"},children:[r.jsx("div",{style:{padding:"24px 24px 0"},children:r.jsx(ue,{exhibitionId:s})}),r.jsx(le,{title:"Stall Manager",extra:r.jsxs(de,{children:[r.jsx(k,{icon:r.jsx(ce,{}),onClick:()=>h(`/exhibition/${s}`,{state:{exhibitionId:s}}),children:"Back to Exhibition"}),r.jsx(k,{type:"primary",icon:r.jsx(he,{}),onClick:V,disabled:!t,children:"Add Stall"})]}),style:{flex:1},bodyStyle:{height:"calc(100% - 57px)"},children:r.jsx("div",{ref:b,style:{width:"100%",height:"100%",minHeight:"400px",background:"#f0f2f5",borderRadius:"8px",overflow:"hidden"},children:d&&r.jsx(G,{width:F.width,height:F.height,exhibitionWidth:((R=d.dimensions)==null?void 0:R.width)||100,exhibitionHeight:((z=d.dimensions)==null?void 0:z.height)||100,halls:o,selectedHall:t,onSelectHall:X,isStallMode:!0,children:t&&U.map(e=>r.jsx(Z,{stall:e,isSelected:(u==null?void 0:u.id)===e.id||(u==null?void 0:u._id)===e._id,onSelect:()=>$(e),onChange:K,hallWidth:t.dimensions.width,hallHeight:t.dimensions.height,hallX:t.dimensions.x,hallY:t.dimensions.y},e.id||e._id))})})}),d&&r.jsx(ee,{visible:N,stall:u,hall:t,exhibition:d,onCancel:Q,onSubmit:O,onDelete:u?()=>J(u.id||u._id):void 0})]})})};export{Ie as default};
