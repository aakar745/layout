import{a as q,J as G,j as e}from"./index-DoSueJxk.js";import{r as l,u as ye}from"./vendor-react-dkbxt9Jf.js";import{u as je}from"./reduxHooks-Be1Cl4uN.js";import{u as $,w as fe,b as Se}from"./vendor-export-PCv_shhx.js";import{X as be,c,K as a,W as i,T as ve,a1 as _,$ as E,a0 as h,ab as V,J as I,ar as we,S as g,ah as Ce,af as Q,V as X,ai as Ee,ag as M,aF as f,ac as Ie,aQ as Ae,ad as Fe,C as Ne,b as Z,d as ke,aj as ze,b8 as Te,R as De}from"./vendor-antd-mFVHvrVJ.js";import"./vendor-utils-ngrFHoWO.js";import"./vendor-styling-CQa69cNz.js";const $e=async(d,r)=>{const o=new URLSearchParams;return r?.page&&o.append("page",r.page.toString()),r?.limit&&o.append("limit",r.limit.toString()),r?.search&&o.append("search",r.search),r?.active!==void 0&&o.append("active",r.active.toString()),(await q.get(`/service-charge-stalls/${d}?${o}`)).data},Pe=async(d,r)=>(await q.post(`/service-charge-stalls/${d}`,r)).data.data,qe=async(d,r)=>(await q.put(`/service-charge-stalls/stall/${d}`,r)).data.data,Re=async d=>{await q.delete(`/service-charge-stalls/stall/${d}`)},_e=async(d,r)=>{const o=await fetch(`${G}/service-charge-stalls/${d}/import`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(r)}),j=await o.json();if(!o.ok){const S=new Error(j.message||"Import failed");throw S.validationData=j,S.status=o.status,S}return j.data},{Option:B}=V,{Title:P,Text:n}=ve,Ke=()=>{const{hasPermission:d}=je();if(!d("view_service_charges"))return e.jsx(be,{status:"403",title:"403",subTitle:"Sorry, you are not authorized to access this page.",extra:e.jsx(c,{type:"primary",onClick:()=>window.location.href="/dashboard",children:"Back to Dashboard"})});const[r,o]=l.useState([]),[j,S]=l.useState([]),[m,ee]=l.useState(""),[te,H]=l.useState(!1),[se,A]=l.useState(!1),[ae,F]=l.useState(!1),[re,N]=l.useState(!1),[U,k]=l.useState(null),[L,z]=l.useState(null),[u,T]=l.useState([]),[le,W]=l.useState(!1),[Me,Be]=l.useState(!1),[b,Y]=l.useState({search:"",active:void 0}),[y,O]=l.useState({current:1,pageSize:10,total:0});ye();const[D]=a.useForm(),[v]=a.useForm(),[R]=a.useForm();l.useEffect(()=>{ie()},[]),l.useEffect(()=>{m&&w()},[m,y.current,y.pageSize,b]);const ie=async()=>{try{const t=await fetch(`${G}/exhibitions`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const s=await t.json(),p=Array.isArray(s)?s:s.data||[];S(p),p.length===0&&console.warn("No exhibitions found. User may not have access to any exhibitions.")}else console.error("Failed to fetch exhibitions:",t.status,t.statusText),i.error("Failed to load exhibitions. Please check your permissions.")}catch(t){console.error("Error fetching exhibitions:",t),i.error("Error loading exhibitions")}},w=async()=>{if(m){H(!0);try{const t=await $e(m,{page:y.current,limit:y.pageSize,search:b.search||void 0,active:b.active});o(t.data),O(s=>({...s,total:t.pagination?.total||0}))}catch(t){console.error("Error fetching stalls:",t),i.error("Failed to fetch stalls")}finally{H(!1)}}},ne=async t=>{try{await Pe(m,t),i.success("Service charge stall created successfully"),A(!1),D.resetFields(),w()}catch(s){console.error("Error creating stall:",s),i.error("Failed to create stall")}},oe=async t=>{if(U)try{await qe(U._id,t),i.success("Service charge stall updated successfully"),F(!1),v.resetFields(),k(null),w()}catch(s){console.error("Error updating stall:",s),i.error("Failed to update stall")}},ce=async t=>{try{await Re(t),i.success("Service charge stall deleted successfully"),w()}catch(s){console.error("Error deleting stall:",s),i.error("Failed to delete stall")}},de=t=>{z(t);const s=new FileReader;return s.onload=p=>{try{const C=p.target?.result,J=Se(C,{type:"binary"}),ue=J.SheetNames[0],ge=J.Sheets[ue],K=$.sheet_to_json(ge).map(x=>({stallNumber:String(x["Stall Number"]||x.stallNumber||"").trim(),exhibitorCompanyName:String(x["Exhibitor Company Name"]||x.exhibitorCompanyName||"").trim(),stallArea:parseFloat(x["Stall Area (sqm)"]||x.stallArea||"0"),dimensions:x.Width&&x.Height?{width:parseFloat(x.Width||"0"),height:parseFloat(x.Height||"0")}:void 0}));T(K),i.success(`File uploaded successfully. Found ${K.length} records.`)}catch(C){console.error("Error reading file:",C),i.error("Error reading file. Please make sure it's a valid Excel file.")}},s.readAsBinaryString(t),!1},he=async()=>{if(!u.length){i.error("Please upload a file first");return}W(!0);try{const t=await _e(m,{stalls:u});i.success(`Successfully imported ${t.imported} service charge stalls`),N(!1),z(null),T([]),R.resetFields(),w()}catch(t){if(console.error("Error importing stalls:",t),t.validationData&&t.validationData.message==="Validation failed"&&t.validationData.errors){const s=t.validationData;i.error({content:e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"Import failed with validation errors:"})}),e.jsxs("ul",{style:{margin:"8px 0 0 0",paddingLeft:16,maxHeight:"200px",overflowY:"auto"},children:[s.errors.slice(0,10).map((p,C)=>e.jsx("li",{style:{marginBottom:"4px"},children:p},C)),s.errors.length>10&&e.jsxs("li",{style:{marginTop:"8px",fontStyle:"italic",color:"#666"},children:["... and ",s.errors.length-10," more errors"]})]}),e.jsxs("p",{style:{marginTop:"12px",fontSize:"12px",color:"#666"},children:["Total rows: ",s.totalRows," | Valid: ",s.validRows," | Errors: ",s.errorRows]})]}),duration:8})}else i.error(t.message||"Import failed. Please check your data and try again.")}finally{W(!1)}},me=()=>{const t=[{"Stall Number":"A001","Exhibitor Company Name":"ABC Company Ltd","Stall Area (sqm)":30,Width:5,Height:6},{"Stall Number":"B002","Exhibitor Company Name":"XYZ Exhibition Services","Stall Area (sqm)":60,Width:10,Height:6}],s=$.book_new(),p=$.json_to_sheet(t);$.book_append_sheet(s,p,"Service Charge Stalls"),fe(s,"service-charge-stalls-template.xlsx")},pe=t=>{k(t),v.setFieldsValue({stallNumber:t.stallNumber,exhibitorCompanyName:t.exhibitorCompanyName,stallArea:t.stallArea,dimensions:t.dimensions,isActive:t.isActive}),F(!0)},xe=[{title:"Stall Number",dataIndex:"stallNumber",key:"stallNumber",width:120,render:(t,s)=>e.jsxs("div",{children:[e.jsx(n,{strong:!0,style:{fontSize:"14px"},children:t}),!s.isActive&&e.jsx("div",{children:e.jsx(Z,{color:"red",children:"Inactive"})})]})},{title:"Exhibitor Company",dataIndex:"exhibitorCompanyName",key:"exhibitorCompanyName",width:200,render:t=>e.jsx(n,{style:{fontSize:"13px"},children:t})},{title:"Stall Area",dataIndex:"stallArea",key:"stallArea",width:100,align:"center",render:t=>e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx(n,{strong:!0,style:{fontSize:"14px"},children:t}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:"sqm"})]})},{title:"Dimensions",key:"dimensions",width:120,align:"center",render:t=>e.jsx("div",{children:t.dimensions?e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsxs(n,{style:{fontSize:"13px"},children:[t.dimensions.width," Ã— ",t.dimensions.height]}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:"meters"})]}):e.jsx(n,{type:"secondary",style:{fontSize:"12px"},children:"-"})})},{title:"Status",dataIndex:"isActive",key:"isActive",width:100,align:"center",render:t=>e.jsx(Z,{color:t?"green":"red",children:t?"Active":"Inactive"})},{title:"Created",dataIndex:"createdAt",key:"createdAt",width:120,render:t=>e.jsx(n,{style:{fontSize:"12px"},children:ke(t).format("DD/MM/YYYY")})},{title:"Actions",key:"actions",width:120,align:"center",render:t=>e.jsxs(g,{children:[e.jsx(c,{type:"text",icon:e.jsx(ze,{}),onClick:()=>pe(t),size:"small"}),d("delete_service_charges")&&e.jsx(Te,{title:"Are you sure you want to delete this stall?",onConfirm:()=>ce(t._id),okText:"Yes",cancelText:"No",children:e.jsx(c,{type:"text",icon:e.jsx(De,{}),danger:!0,size:"small"})})]})}];return e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsx(P,{level:2,children:"Service Charge Stalls Management"}),e.jsx(n,{type:"secondary",children:"Manage stall data for service charge auto-fill functionality"})]}),e.jsx(_,{style:{marginBottom:"24px"},children:e.jsxs(E,{gutter:16,align:"middle",children:[e.jsx(h,{span:8,children:e.jsx(V,{placeholder:"Select an exhibition",value:m,onChange:ee,style:{width:"100%"},showSearch:!0,optionFilterProp:"children",children:j.map(t=>e.jsxs(B,{value:t._id,children:[t.name," - ",t.venue]},t._id))})}),e.jsx(h,{span:6,children:e.jsx(I,{placeholder:"Search stalls...",prefix:e.jsx(we,{}),value:b.search,onChange:t=>Y(s=>({...s,search:t.target.value})),allowClear:!0})}),e.jsx(h,{span:4,children:e.jsxs(V,{placeholder:"Status",value:b.active,onChange:t=>Y(s=>({...s,active:t})),allowClear:!0,children:[e.jsx(B,{value:!0,children:"Active"}),e.jsx(B,{value:!1,children:"Inactive"})]})}),e.jsx(h,{span:6,children:e.jsxs(g,{children:[e.jsx(c,{type:"primary",icon:e.jsx(Ce,{}),onClick:()=>A(!0),disabled:!m,children:"Add Stall"}),e.jsx(c,{icon:e.jsx(Q,{}),onClick:()=>N(!0),disabled:!m,children:"Import Excel"})]})})]})}),m?e.jsx(_,{children:e.jsx(Ee,{columns:xe,dataSource:r,rowKey:"_id",loading:te,pagination:{current:y.current,pageSize:y.pageSize,total:y.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,s)=>`${s[0]}-${s[1]} of ${t} stalls`,onChange:(t,s)=>{O(p=>({...p,current:t,pageSize:s||10}))}},size:"middle",scroll:{x:800}})}):e.jsx(_,{children:e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(X,{style:{fontSize:"48px",color:"#d9d9d9",marginBottom:"16px"}}),e.jsx(P,{level:4,type:"secondary",children:"Select an Exhibition"}),e.jsx(n,{type:"secondary",children:"Please select an exhibition to view and manage its service charge stalls."})]})}),e.jsx(M,{title:"Add New Service Charge Stall",open:se,onCancel:()=>{A(!1),D.resetFields()},footer:null,width:600,children:e.jsxs(a,{form:D,layout:"vertical",onFinish:ne,children:[e.jsxs(E,{gutter:16,children:[e.jsx(h,{span:12,children:e.jsx(a.Item,{name:"stallNumber",label:"Stall Number",rules:[{required:!0,message:"Please enter stall number"}],children:e.jsx(I,{placeholder:"Enter stall number"})})}),e.jsx(h,{span:12,children:e.jsx(a.Item,{name:"stallArea",label:"Stall Area (sqm)",rules:[{required:!0,message:"Please enter stall area"},{type:"number",min:1,message:"Area must be at least 1 sqm"}],children:e.jsx(f,{placeholder:"Enter area in sqm",style:{width:"100%"},min:1})})})]}),e.jsx(a.Item,{name:"exhibitorCompanyName",label:"Exhibitor Company Name",rules:[{required:!0,message:"Please enter exhibitor company name"}],children:e.jsx(I,{placeholder:"Enter exhibitor company name"})}),e.jsx(P,{level:5,children:"Dimensions (Optional)"}),e.jsxs(E,{gutter:16,children:[e.jsx(h,{span:12,children:e.jsx(a.Item,{name:["dimensions","width"],label:"Width (meters)",children:e.jsx(f,{placeholder:"Enter width",style:{width:"100%"},min:.1,step:.1})})}),e.jsx(h,{span:12,children:e.jsx(a.Item,{name:["dimensions","height"],label:"Height (meters)",children:e.jsx(f,{placeholder:"Enter height",style:{width:"100%"},min:.1,step:.1})})})]}),e.jsx(a.Item,{children:e.jsxs(g,{children:[e.jsx(c,{type:"primary",htmlType:"submit",children:"Create Stall"}),e.jsx(c,{onClick:()=>{A(!1),D.resetFields()},children:"Cancel"})]})})]})}),e.jsx(M,{title:"Edit Service Charge Stall",open:ae,onCancel:()=>{F(!1),v.resetFields(),k(null)},footer:null,width:600,children:e.jsxs(a,{form:v,layout:"vertical",onFinish:oe,children:[e.jsxs(E,{gutter:16,children:[e.jsx(h,{span:12,children:e.jsx(a.Item,{name:"stallNumber",label:"Stall Number",rules:[{required:!0,message:"Please enter stall number"}],children:e.jsx(I,{placeholder:"Enter stall number"})})}),e.jsx(h,{span:12,children:e.jsx(a.Item,{name:"stallArea",label:"Stall Area (sqm)",rules:[{required:!0,message:"Please enter stall area"},{type:"number",min:1,message:"Area must be at least 1 sqm"}],children:e.jsx(f,{placeholder:"Enter area in sqm",style:{width:"100%"},min:1})})})]}),e.jsx(a.Item,{name:"exhibitorCompanyName",label:"Exhibitor Company Name",rules:[{required:!0,message:"Please enter exhibitor company name"}],children:e.jsx(I,{placeholder:"Enter exhibitor company name"})}),e.jsx(P,{level:5,children:"Dimensions (Optional)"}),e.jsxs(E,{gutter:16,children:[e.jsx(h,{span:12,children:e.jsx(a.Item,{name:["dimensions","width"],label:"Width (meters)",children:e.jsx(f,{placeholder:"Enter width",style:{width:"100%"},min:.1,step:.1})})}),e.jsx(h,{span:12,children:e.jsx(a.Item,{name:["dimensions","height"],label:"Height (meters)",children:e.jsx(f,{placeholder:"Enter height",style:{width:"100%"},min:.1,step:.1})})})]}),e.jsx(a.Item,{name:"isActive",label:"Status",valuePropName:"checked",children:e.jsx(Ie,{checkedChildren:"Active",unCheckedChildren:"Inactive"})}),e.jsx(a.Item,{children:e.jsxs(g,{children:[e.jsx(c,{type:"primary",htmlType:"submit",children:"Update Stall"}),e.jsx(c,{onClick:()=>{F(!1),v.resetFields(),k(null)},children:"Cancel"})]})})]})}),e.jsxs(M,{title:"Import Service Charge Stalls",open:re,onCancel:()=>{N(!1),z(null),T([]),R.resetFields()},footer:null,width:700,children:[e.jsxs("div",{style:{marginBottom:"16px"},children:[e.jsxs(g,{children:[e.jsx(c,{type:"link",icon:e.jsx(Ae,{}),onClick:me,style:{padding:0},children:"Download Template"}),e.jsx(n,{type:"secondary",children:"|"}),e.jsx(n,{type:"secondary",children:"Required columns: Stall Number, Exhibitor Company Name, Stall Area (sqm)"})]}),e.jsx("div",{style:{marginTop:"8px",fontSize:"12px",color:"#666"},children:e.jsxs(n,{type:"secondary",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tips:"})," Ensure stall numbers are unique, area values are numeric, and no duplicate entries exist in your file."]})})]}),e.jsx(Fe,{accept:".xlsx,.xls",beforeUpload:de,showUploadList:!1,children:e.jsx(c,{icon:e.jsx(Q,{}),children:"Select Excel File"})}),L&&e.jsx("div",{style:{margin:"16px 0",padding:"12px",background:"#f0f9ff",border:"1px solid #bae6fd",borderRadius:"6px"},children:e.jsxs(g,{children:[e.jsx(Ne,{style:{color:"#0369a1"}}),e.jsx(n,{strong:!0,children:L.name}),e.jsxs(n,{type:"secondary",children:["(",u.length," records found)"]})]})}),u.length>0&&e.jsxs("div",{style:{margin:"16px 0",padding:"12px",background:"#f6ffed",border:"1px solid #b7eb8f",borderRadius:"6px"},children:[e.jsxs(g,{children:[e.jsx(X,{style:{color:"#52c41a"}}),e.jsx(n,{strong:!0,children:"Preview:"}),e.jsxs(n,{children:[u.length," stalls ready to import"]})]}),e.jsxs("div",{style:{marginTop:"8px",fontSize:"12px",color:"#666"},children:["Sample: ",u[0]?.stallNumber," - ",u[0]?.exhibitorCompanyName," (",u[0]?.stallArea," sqm)"]})]}),e.jsx("div",{style:{marginTop:"24px"},children:e.jsxs(g,{children:[e.jsx(c,{type:"primary",onClick:he,loading:le,disabled:!u.length,children:"Import Stalls"}),e.jsx(c,{onClick:()=>{N(!1),z(null),T([]),R.resetFields()},children:"Cancel"})]})})]})]})};export{Ke as default};
