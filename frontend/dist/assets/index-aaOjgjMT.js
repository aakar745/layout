import{j as e}from"./vendor-pdf-Cn0rG44s.js";import{F as l,r as p,w as f,y as M,z as h,S as b,T as c,G as _,Z as S,h as N,af as Pe,a7 as w,f as P,e as De,D as de,W as Be,K as Ee,t as y}from"./vendor-antd-B8jUXf3i.js";import{b as Le,u as z}from"./vendor-redux-rS0pI56E.js";import{q as Me,U as ce,V as _e,x as ue,W as ze}from"./index-4IR4xblb.js";import{u as Qe}from"./vendor-react-DW9h-haf.js";import{q as Re}from"./vendor-antd-icons-BoTJB7uA.js";import"./vendor-http-t--hEgTQ.js";import"./vendor-ui-BmMA_ojr.js";import"./vendor-canvas-DrFPvyt4.js";const{Title:We,Text:j}=c,Xe=()=>{var te,ne,ie;const[v]=l.useForm(),[I]=l.useForm(),[me,D]=p.useState(!1),[Q,he]=p.useState([]),[Z,O]=p.useState(!1),[k,G]=p.useState([]),[a,xe]=p.useState(null),[pe,ge]=p.useState(),[B,K]=p.useState([]),[E,U]=p.useState({}),[R,H]=p.useState([]),[ye,Y]=p.useState(0),q=Qe(),$=Le(),{loading:je}=z(t=>t.booking),{exhibitions:fe=[],loading:be}=z(t=>t.exhibition),{exhibitors:J=[],loading:Se}=z(t=>t.exhibitor),{isAuthenticated:X}=z(t=>t.auth);p.useEffect(()=>{if(!X){f.error("Please login to create a booking"),q("/login");return}$(Me()),$(ce())},[$,X,q]);const Ae=async t=>{try{O(!0),v.setFieldValue("stallIds",[]),v.setFieldValue("discountId",void 0),v.setFieldValue("extraAmenities",[]),G([]),K([]),H([]),Y(0);const n=await ue.getExhibition(t);xe(n.data);const r=(await ue.getStalls(t)).data.filter(u=>u.status==="available");he(r)}catch(n){console.error("Failed to fetch exhibition data:",n),f.error("Failed to fetch exhibition data")}finally{O(!1)}},L=t=>Math.round(t.ratePerSqm*t.dimensions.width*t.dimensions.height*100)/100,ve=t=>{var r;const n=Q.filter(u=>{const d=u._id||u.id;return d&&t.includes(d)});G(n);const i=n.reduce((u,d)=>u+d.dimensions.width*d.dimensions.height,0);if(Y(i),(r=a==null?void 0:a.basicAmenities)!=null&&r.length){const u=a.basicAmenities.map(d=>{const g=Math.floor(i/d.perSqm)*d.quantity;return{...d,calculatedQuantity:g>0?g:0,key:d._id||d.id}});H(u)}},Ie=(t,n,i)=>{if(!(i!=null&&i.isActive))return 0;let r=0;if(i.type==="percentage")r=t*(Math.max(0,Math.min(100,i.value))/100);else{const u=t/n*i.value;r=Math.min(u,t)}return Math.round(r*100)/100},Ce=async t=>{var n,i;try{const r=J.find(s=>s._id===t.exhibitorId);if(!r)throw new Error("Selected exhibitor not found");const[u,d,g]=t.discountId?t.discountId.split("-"):[],m=(n=a==null?void 0:a.discountConfig)==null?void 0:n.find(s=>`${s.name}-${s.value}-${s.type}`===t.discountId),F=k.map(s=>{const x=s._id||s.id;if(!x)throw new Error(`Invalid stall ID for stall number ${s.number}`);return{stall:s,stallId:x,baseAmount:L(s)}}),o=F.reduce((s,{baseAmount:x})=>s+x,0),A=F.map(({stall:s,stallId:x,baseAmount:T})=>{const oe=m?Ie(T,o,m):0;return{stallId:x,number:s.number,baseAmount:T,discount:m?{name:m.name,type:m.type,value:m.value,amount:oe}:void 0,amountAfterDiscount:Math.round((T-oe)*100)/100}}),se=A.reduce((s,x)=>{var T;return s+(((T=x.discount)==null?void 0:T.amount)||0)},0),W=Math.round((o-se)*100)/100,ae=((i=a==null?void 0:a.taxConfig)==null?void 0:i.filter(s=>s.isActive).map(s=>({name:s.name,rate:s.rate,amount:Math.round(W*s.rate/100*100)/100})))||[],re=ae.reduce((s,x)=>s+x.amount,0),le=Math.round((W+re)*100)/100,V={exhibitionId:t.exhibitionId,exhibitorId:t.exhibitorId,stallIds:A.map(s=>s.stallId),customerName:r.contactPerson,customerEmail:r.email,customerPhone:r.phone,customerAddress:r.address||"N/A",customerGSTIN:r.gstNumber||"N/A",customerPAN:r.panNumber||"N/A",companyName:r.companyName,discount:m?{name:m.name,type:m.type,value:m.value}:void 0,amount:le,calculations:{stalls:A,totalBaseAmount:o,totalDiscountAmount:se,totalAmountAfterDiscount:W,taxes:ae,totalTaxAmount:re,totalAmount:le}};R.length&&(V.basicAmenities=R.filter(s=>s.calculatedQuantity>0).map(s=>({name:s.name,type:s.type,perSqm:s.perSqm,quantity:s.quantity,calculatedQuantity:s.calculatedQuantity,description:s.description}))),B.length&&(V.extraAmenities=ee());const C=await $(_e(V)).unwrap();C&&C.invoiceId?(f.success("Booking created successfully! Redirecting to invoice..."),setTimeout(()=>{q(`/invoice/${C.invoiceId}`)},2e3)):(f.success("Booking created successfully"),q("/bookings")),C&&C.warning&&f.warning(C.warning)}catch(r){console.error("Error creating booking:",r),f.error("Failed to create booking")}},Te=async t=>{try{const n=await ze.createExhibitor(t);f.success("Exhibitor added successfully"),$(ce()),v.setFieldsValue({exhibitorId:n.data._id}),D(!1),I.resetFields()}catch(n){const i=(n==null?void 0:n.message)||"Failed to add exhibitor";f.error(i),i==="User with this email already exists"&&I.setFields([{name:"contactEmail",errors:["This email is already registered"]}])}},we=fe.map(t=>({label:t.name,value:t._id||t.id})),ke=J.map(t=>({label:t.companyName,value:t._id}));Q.map(t=>({label:`Stall ${t.number} (${t.dimensions.width}m × ${t.dimensions.height}m = ${(t.dimensions.width*t.dimensions.height).toFixed(2)} sqm) - ₹${t.ratePerSqm.toLocaleString()}/sq.m`,value:t._id||t.id}));const qe=t=>{ge(t),v.setFieldValue("discountId",t)},$e=()=>{var m,F;const t=k.reduce((o,A)=>o+L(A),0),n=(m=a==null?void 0:a.discountConfig)==null?void 0:m.find(o=>`${o.name}-${o.value}-${o.type}`===pe&&o.isActive),i=n?n.type==="percentage"?Math.round(t*n.value/100*100)/100:Math.min(n.value,t):0,r=Math.round((t-i)*100)/100,u=((F=a==null?void 0:a.taxConfig)==null?void 0:F.filter(o=>o.isActive).map(o=>({name:o.name,rate:o.rate,amount:Math.round(r*o.rate/100*100)/100})))||[],d=u.reduce((o,A)=>o+A.amount,0),g=Math.round((r+d)*100)/100;return{baseAmount:t,selectedDiscount:n,discountAmount:i,amountAfterDiscount:r,taxes:u,totalTaxAmount:d,totalAmount:g}},ee=()=>{var t;return(t=a==null?void 0:a.amenities)!=null&&t.length?a.amenities.filter(n=>{const i=n._id||n.id;return i&&B.includes(i.toString())}).map(n=>{const i=(n._id||n.id).toString();return{id:i,name:n.name,type:n.type,rate:n.rate,description:n.description,quantity:E[i]||1}}):[]},Fe=t=>{const n={...E};t.forEach(i=>{B.includes(i)||(n[i]=1)}),Object.keys(n).forEach(i=>{t.includes(i)||delete n[i]}),U(n),K(t)},Ne=(t,n)=>{U(i=>({...i,[t]:n}))};return e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs(M,{gutter:[24,24],children:[e.jsx(h,{span:24,children:e.jsxs(b,{direction:"vertical",size:4,children:[e.jsx(We,{level:2,style:{margin:0},children:"Create Booking"}),e.jsx(c.Text,{type:"secondary",children:"Create a new stall booking"})]})}),e.jsx(h,{span:24,children:e.jsx(_,{children:e.jsx(l,{form:v,layout:"vertical",onFinish:Ce,style:{maxWidth:800},children:e.jsxs(M,{gutter:16,children:[e.jsx(h,{span:12,children:e.jsx(l.Item,{name:"exhibitionId",label:"Exhibition",rules:[{required:!0,message:"Please select an exhibition"}],children:e.jsx(S,{placeholder:"Select exhibition",loading:be,options:we,onChange:Ae})})}),e.jsx(h,{span:12,children:e.jsx(l.Item,{name:"exhibitorId",label:e.jsxs(b,{children:[e.jsx("span",{children:"Exhibitor"}),e.jsx(N,{type:"link",icon:e.jsx(Pe,{}),onClick:()=>D(!0),style:{padding:0},children:"Add Exhibitor"})]}),rules:[{required:!0,message:"Please select an exhibitor"}],children:e.jsx(S,{showSearch:!0,placeholder:"Select exhibitor",loading:Se,options:ke,filterOption:(t,n)=>{var i;return(((i=n==null?void 0:n.label)==null?void 0:i.toString())??"").toLowerCase().includes(t.toLowerCase())}})})}),e.jsx(h,{span:24,children:e.jsx(l.Item,{name:"stallIds",label:"Select Stalls",rules:[{required:!0,message:"Please select at least one stall"}],children:e.jsx(S,{mode:"multiple",placeholder:Z?"Loading stalls...":"Select stalls",loading:Z,onChange:ve,options:Q.map(t=>({label:`Stall ${t.number} (${t.dimensions.width}m × ${t.dimensions.height}m = ${(t.dimensions.width*t.dimensions.height).toFixed(2)} sqm) - ₹${t.ratePerSqm.toLocaleString()}/sq.m`,value:t._id||t.id}))})})}),k.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(h,{span:24,children:e.jsx(_,{title:"Selected Stalls Summary",size:"small",children:e.jsx(w,{dataSource:k.map(t=>({...t,key:t._id||t.id})),pagination:!1,size:"small",columns:[{title:"Stall Number",dataIndex:"number",key:"number"},{title:"Stall Type",key:"type",render:(t,n)=>{var i,r;return((i=n.stallType)==null?void 0:i.name)||(typeof n.stallTypeId=="object"?(r=n.stallTypeId)==null?void 0:r.name:"Not specified")}},{title:"Dimensions",key:"dimensions",render:(t,n)=>`${n.dimensions.width}m × ${n.dimensions.height}m`},{title:"Area (sqm)",key:"area",render:(t,n)=>(n.dimensions.width*n.dimensions.height).toFixed(2)},{title:"Rate/sq.m",dataIndex:"ratePerSqm",key:"rate",render:t=>`₹${t.toLocaleString()}`},{title:"Base Amount",key:"baseAmount",render:(t,n)=>`₹${L(n).toLocaleString()}`}],summary:()=>{const t=k.reduce((n,i)=>n+L(i),0);return e.jsxs(w.Summary.Row,{children:[e.jsx(w.Summary.Cell,{index:0,colSpan:5,children:e.jsx("strong",{children:"Total Base Amount"})}),e.jsx(w.Summary.Cell,{index:1,children:e.jsxs("strong",{children:["₹",t.toLocaleString()]})})]},"summary")}})})}),e.jsx(h,{span:24,children:e.jsx(_,{title:"Stall Amenities",size:"small",children:e.jsxs(M,{gutter:[16,24],children:[e.jsxs(h,{span:24,children:[e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(c.Title,{level:5,style:{margin:0},children:e.jsxs(b,{children:[e.jsx("span",{children:"Included Basic Amenities"}),e.jsx(P,{color:"green",children:"Based on stall area"})]})}),e.jsxs(c.Text,{type:"secondary",children:["The following amenities are included based on your total stall area of ",ye.toFixed(2)," sqm."]})]}),(te=a==null?void 0:a.basicAmenities)!=null&&te.length?e.jsx(w,{dataSource:R.filter(t=>t.calculatedQuantity>0),columns:[{title:"Name",dataIndex:"name",key:"name",render:(t,n)=>e.jsxs(b,{children:[e.jsx(c.Text,{strong:!0,children:t}),e.jsx(P,{color:"blue",children:n.type})]})},{title:"Quantity",dataIndex:"calculatedQuantity",key:"calculatedQuantity",width:120,render:t=>e.jsxs(P,{color:"green",children:[t," ",t===1?"unit":"units"]})},{title:"Allocation",dataIndex:"perSqm",key:"perSqm",width:180,render:(t,n)=>e.jsx(De,{title:n.description,children:e.jsxs(c.Text,{type:"secondary",children:[e.jsx(Re,{style:{marginRight:5}}),"1 ",n.quantity>1?`set of ${n.quantity}`:"unit"," per ",t," sqm"]})})},{title:"Status",key:"status",width:100,align:"right",render:()=>e.jsx(c.Text,{type:"success",children:"Included"})}],pagination:!1,size:"small",locale:{emptyText:e.jsx(c.Text,{children:"No basic amenities qualify based on the selected stall area."})}}):e.jsx(c.Text,{type:"secondary",children:"No basic amenities have been configured for this exhibition."})]}),e.jsxs(h,{span:24,children:[e.jsx(de,{style:{margin:"12px 0 24px"}}),e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(c.Title,{level:5,style:{margin:0},children:e.jsxs(b,{children:[e.jsx("span",{children:"Additional Amenities"}),e.jsx(P,{color:"blue",children:"Optional"})]})}),e.jsx(c.Text,{type:"secondary",children:"Select any additional amenities for the booking."})]}),(ne=a==null?void 0:a.amenities)!=null&&ne.length?e.jsxs(e.Fragment,{children:[e.jsx(l.Item,{name:"extraAmenities",label:"Select Additional Amenities",children:e.jsx(S,{mode:"multiple",placeholder:"Select amenities",style:{width:"100%"},onChange:Fe,optionLabelProp:"label",options:a.amenities.map(t=>({label:`${t.name} (${t.rate?`₹${t.rate.toLocaleString()}`:"N/A"})`,value:t._id||t.id,key:t._id||t.id}))})}),B.length>0&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(c.Text,{strong:!0,children:"Selected Amenities:"}),e.jsx(w,{dataSource:ee(),columns:[{title:"Name",dataIndex:"name",key:"name",render:(t,n)=>e.jsxs(b,{align:"center",children:[e.jsx(c.Text,{strong:!0,children:t}),e.jsx(P,{color:"blue",children:n.type}),e.jsx(c.Text,{type:"secondary",style:{fontSize:"13px"},children:n.description||""})]})},{title:"Rate",dataIndex:"rate",key:"rate",width:120,align:"right",render:t=>e.jsxs(c.Text,{strong:!0,style:{color:"#1890ff"},children:["₹",t.toLocaleString("en-IN")]})},{title:"Quantity",dataIndex:"quantity",key:"quantity",width:120,render:(t,n)=>e.jsx(Be,{min:1,value:E[n.id]||1,onChange:i=>Ne(n.id,i||1),style:{width:"100%"}})},{title:"Total",key:"total",width:120,align:"right",render:(t,n)=>{const i=E[n.id]||1,r=n.rate*i;return e.jsxs(c.Text,{strong:!0,style:{color:"#1890ff"},children:["₹",r.toLocaleString("en-IN")]})}}],pagination:!1,size:"small"})]})]}):e.jsx(c.Text,{type:"secondary",children:"No additional amenities have been configured for this exhibition."})]})]})})}),e.jsx(h,{span:24,children:e.jsxs(_,{title:"Price Calculations",size:"small",children:[e.jsx(M,{gutter:[16,16],children:e.jsx(h,{span:12,children:e.jsx(l.Item,{name:"discountId",label:"Available Discounts",children:e.jsx(S,{placeholder:"Select discount",allowClear:!0,onChange:qe,options:(ie=a==null?void 0:a.discountConfig)==null?void 0:ie.map(t=>({label:`${t.name} (${t.type==="percentage"?t.value+"%":"₹"+t.value})${t.isActive?"":" - Inactive"}`,value:`${t.name}-${t.value}-${t.type}`,disabled:!t.isActive}))})})})}),e.jsx("div",{style:{background:"#fafafa",padding:"16px",borderRadius:"8px",marginTop:"16px"},children:e.jsx(b,{direction:"vertical",style:{width:"100%"},size:"small",children:(()=>{const{baseAmount:t,selectedDiscount:n,discountAmount:i,amountAfterDiscount:r,taxes:u,totalAmount:d}=$e();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(j,{children:"Total Base Amount:"}),e.jsxs(j,{children:["₹",t.toLocaleString()]})]}),n&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(j,{children:["Discount (",n.type==="percentage"?`${n.value}%`:`₹${n.value.toLocaleString()}`,"):"]}),e.jsxs(j,{type:"danger",children:["-₹",i.toLocaleString()]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(j,{children:"Amount after Discount:"}),e.jsxs(j,{children:["₹",r.toLocaleString()]})]}),e.jsx(de,{style:{margin:"8px 0"}}),u.map(g=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(j,{children:[g.name," (",g.rate,"%):"]}),e.jsxs(j,{children:["₹",g.amount.toLocaleString()]})]},`tax-${g.name}`)),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"8px"},children:[e.jsx(j,{strong:!0,children:"Total Amount (incl. Taxes):"}),e.jsxs(j,{strong:!0,children:["₹",d.toLocaleString()]})]})]})})()})})]})})]}),e.jsx(h,{span:24,children:e.jsx(l.Item,{children:e.jsxs(b,{children:[e.jsx(N,{type:"primary",htmlType:"submit",loading:je,children:"Create Booking"}),e.jsx(N,{onClick:()=>q("/bookings"),children:"Cancel"})]})})})]})})})})]}),e.jsx(Ee,{title:e.jsx("span",{style:{fontSize:"18px",fontWeight:600,color:"#101828"},children:"Add Exhibitor"}),open:me,onCancel:()=>{D(!1),I.resetFields()},width:800,footer:e.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-start",padding:"20px 24px"},children:[e.jsx(N,{onClick:()=>{D(!1),I.resetFields()},style:{height:"40px",padding:"10px 16px",borderRadius:"8px",border:"1px solid #D0D5DD",color:"#344054",fontWeight:500,fontSize:"14px",backgroundColor:"white"},children:"Cancel"}),e.jsx(N,{type:"primary",onClick:I.submit,style:{height:"40px",padding:"10px 16px",borderRadius:"8px",border:"none",backgroundColor:"#6941C6",color:"white",fontWeight:500,fontSize:"14px",boxShadow:"0px 1px 2px rgba(16, 24, 40, 0.05)"},children:"Add Exhibitor"})]}),styles:{body:{padding:"24px",maxHeight:"calc(100vh - 200px)",overflowY:"auto"},header:{borderBottom:"1px solid #E5E7EB",padding:"24px"},footer:{borderTop:"1px solid #E5E7EB",padding:0}},style:{top:20},children:e.jsx(l,{form:I,layout:"vertical",onFinish:Te,requiredMark:!1,children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"32px"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:600,color:"#101828",marginBottom:"24px"},children:"Company Information"}),e.jsx(l.Item,{name:"companyName",label:"Company Name",rules:[{required:!0,message:"Please enter company name"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"address",label:"Address",rules:[{required:!0,message:"Please enter address"}],children:e.jsx(y.TextArea,{rows:3})}),e.jsx(l.Item,{name:"city",label:"City",rules:[{required:!0,message:"Please enter city"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"state",label:"State",rules:[{required:!0,message:"Please enter state"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"pinCode",label:"PIN Code",rules:[{required:!0,message:"Please enter PIN code"},{pattern:/^\d{6}$/,message:"Please enter a valid 6-digit PIN code"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"status",label:"Status",initialValue:"active",children:e.jsxs(S,{children:[e.jsx(S.Option,{value:"active",children:e.jsx("div",{style:{display:"inline-flex",padding:"2px 8px",borderRadius:"16px",fontSize:"12px",fontWeight:500,backgroundColor:"#F6FEF9",color:"#039855",border:"1px solid #ABEFC6",alignItems:"center",height:"22px"},children:"ACTIVE"})}),e.jsx(S.Option,{value:"inactive",children:e.jsx("div",{style:{display:"inline-flex",padding:"2px 8px",borderRadius:"16px",fontSize:"12px",fontWeight:500,backgroundColor:"#FEF3F2",color:"#D92D20",border:"1px solid #FDA29B",alignItems:"center",height:"22px"},children:"INACTIVE"})})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:600,color:"#101828",marginBottom:"24px"},children:"Contact & Legal Information"}),e.jsx(l.Item,{name:"contactPerson",label:"Contact Person",rules:[{required:!0,message:"Please enter contact person"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"contactEmail",label:"Email",rules:[{required:!0,message:"Please enter email"},{type:"email",message:"Please enter a valid email"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"contactPhone",label:"Phone",rules:[{required:!0,message:"Please enter phone number"},{pattern:/^\d{10}$/,message:"Please enter a valid 10-digit phone number"}],children:e.jsx(y,{})}),e.jsx(l.Item,{name:"panNumber",label:"PAN Number",rules:[{pattern:/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/,message:"Please enter a valid PAN number"}],children:e.jsx(y,{placeholder:"ABCDE1234F"})}),e.jsx(l.Item,{name:"gstNumber",label:"GST Number",rules:[{pattern:/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/,message:"Please enter a valid GST number"}],children:e.jsx(y,{placeholder:"27AAPFU0939F1ZV"})})]})]})})})]})};export{Xe as default};
