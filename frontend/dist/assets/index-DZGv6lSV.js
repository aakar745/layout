import{F as C,j as r,P as q,Q as G,S as Z,R as ee,I as te,J as ie,K as E,D as _}from"./index-nu_xN7Rs.js";import{l as ae,k as se,u as L,j as ne,X as re,i as A,r as c}from"./vendor-react-BNeW3y6d.js";import"./vendor-canvas-BRbMLhVA.js";import{ag as oe,a6 as le,S as de,c as k,bg as ce,b1 as he,aY as fe}from"./vendor-antd-CPyaZRZ0.js";import"./vendor-utils-DNTYNPA0.js";import"./vendor-styling-DBLAJE0-.js";const ue=({exhibitionId:a,destination:j="layout",label:D="Back to Layout"})=>{const h=L(),{currentExhibition:f}=A(w=>w.exhibition);return r.jsxs("div",{style:{marginBottom:"24px",position:"sticky",top:"16px",zIndex:10},children:[r.jsx(k,{icon:r.jsx(fe,{}),onClick:()=>h(C(f,j),{state:{exhibitionId:a}}),type:"default",size:"large",style:{borderRadius:"8px",boxShadow:"0 2px 6px rgba(0,0,0,0.08)",background:"white",borderColor:"transparent",fontWeight:500,padding:"0 16px",height:"42px",display:"flex",alignItems:"center",transition:"all 0.3s ease"},className:"back-button-hover",children:r.jsx("span",{style:{marginLeft:8},children:D})}),r.jsx("style",{children:`
        .back-button-hover:hover {
          transform: translateX(-5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          background: #f0f5ff;
          border-color: #d6e4ff;
        }
      `})]})},be=()=>{var P,R,z;const{message:a}=oe.useApp(),{id:j}=ae(),D=se(),h=L(),f=ne(),[w,g]=re(),s=((P=D.state)==null?void 0:P.exhibitionId)||j,{currentExhibition:d,halls:o,stalls:H,loading:T}=A(e=>e.exhibition),m=c.useRef(null),[M,b]=c.useState(!1),[i,v]=c.useState(null),[u,y]=c.useState(null),[F,N]=c.useState({width:0,height:0}),[x,W]=c.useState(!1);c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibitions");return}},[s,h,a]),c.useEffect(()=>{if(!s){a.error("Exhibition ID not found"),h("/exhibition");return}(async()=>{try{await f(te(s)).unwrap(),await f(ie(s)).unwrap(),W(!0)}catch{a.error("Failed to load data")}})()},[s,f,h]),c.useEffect(()=>{var e,t;!x||!d||(!((e=d.dimensions)!=null&&e.width)||!((t=d.dimensions)!=null&&t.height))&&(a.info("Please set up exhibition space first"),h(C(d,"space"),{state:{exhibitionId:s}}))},[d,s,h,x]),c.useEffect(()=>{!x||T||o.length===0&&(a.info("Please create halls first"),h(C(d,"halls"),{state:{exhibitionId:s}}))},[o,s,h,T,x]),c.useEffect(()=>{x&&d&&o.length>0&&(async()=>{try{const t=o.map(n=>f(E({exhibitionId:s,hallId:n.id})).unwrap());await Promise.all(t)}catch(t){console.error("Error fetching stalls:",t),a.error("Failed to load stalls")}})()},[d,s,o,f,x]);const U=H.filter(e=>{const t=typeof e.hallId=="string"?e.hallId:String(e.hallId||""),n=String((i==null?void 0:i.id)||(i==null?void 0:i._id)||"");return t===n});c.useEffect(()=>{if(!x||o.length===0)return;const e=w.get("hallId");if(e){const t=o.find(n=>n.id===e||n._id===e);if(t)v(t);else if(o.length>0){v(o[0]);const n=o[0].id||o[0]._id;n&&g({hallId:n.toString()})}}else if(o.length>0){v(o[0]);const t=o[0].id||o[0]._id;t&&g({hallId:t.toString()})}},[o,w,x,g]),c.useEffect(()=>{const e=()=>{if(m.current){const{clientWidth:n,clientHeight:l}=m.current;N({width:Math.max(n||400,400),height:Math.max(l||400,400)})}};e();const t=new ResizeObserver(e);return m.current&&t.observe(m.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]);const X=()=>{if(!i){a.warning("Please select a hall first");return}y(null),b(!0)},$=e=>{if(v(e),y(null),e){const t=e.id||e._id;g(t?{hallId:t.toString()}:{})}else g({})},O=e=>{var n;const t=e?{...e,id:e.id||e._id,_id:e._id||e.id,stallTypeId:typeof e.stallTypeId=="string"?e.stallTypeId:((n=e.stallTypeId)==null?void 0:n._id)||e.stallTypeId,stallType:e.stallType}:null;console.log("Selected stall data:",t),y(t),b(!!t)},V=async e=>{var t,n;try{if(!(i!=null&&i.id)&&!(i!=null&&i._id)){a.error("No hall selected");return}const l=i.id,p=i._id||i.id;if(e.hallId&&e.hallId!==p){a.error("Cannot move stall to a different hall");return}if(console.log("Submitting stall data:",e),e.id||e._id){const S={...e,id:e.id,_id:e._id,hallId:p,stallTypeId:e.stallTypeId};console.log("Update data:",S);const I=e.id||e._id;if(!I)throw new Error("Stall ID is missing");await _.updateStall(s,I,S),a.success("Stall updated successfully")}else{const{id:S,_id:I,...Q}=e,B={...Q,hallId:p,stallTypeId:e.stallTypeId};console.log("Creating new stall with data:",B),await _.createStall(s,B),a.success("Stall created successfully")}b(!1),f(E({exhibitionId:s,hallId:l}))}catch(l){console.error("Error saving stall:",l),a.error(((n=(t=l.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to save stall")}},Y=async e=>{var t,n;try{if(!s){a.error("Exhibition ID not found");return}const l=i;if(!l){a.error("No hall selected");return}const p=l.id||l._id;if(!p){a.error("Invalid hall ID");return}await _.deleteStall(s,e),b(!1),y(null),await f(E({exhibitionId:s,hallId:p})).unwrap(),a.success("Stall deleted successfully")}catch(l){console.error("Error deleting stall:",l),a.error(((n=(t=l.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to delete stall")}},J=async e=>{var p,S;if(!s){a.error("Exhibition ID not found");return}const t=e.id||e._id;if(!t){console.error("Stall data:",e),a.error("Stall ID not found");return}if(!(i!=null&&i.id)&&!(i!=null&&i._id)){a.error("No hall selected");return}const n=i.id,l=i._id||i.id;try{await _.updateStall(s,t,{...e,id:t,hallId:l}),f(E({exhibitionId:s,hallId:n}))}catch(I){console.error("Stall update error:",I),a.error(((S=(p=I.response)==null?void 0:p.data)==null?void 0:S.message)||"Failed to update stall position")}},K=()=>{b(!1),y(null)};return r.jsx(q,{children:r.jsxs("div",{style:{height:"100%",display:"flex",flexDirection:"column"},children:[r.jsx("div",{style:{padding:"24px 24px 0"},children:r.jsx(ue,{exhibitionId:s})}),r.jsx(le,{title:"Stall Manager",extra:r.jsxs(de,{children:[r.jsx(k,{icon:r.jsx(ce,{}),onClick:()=>h(`/exhibition/${s}`,{state:{exhibitionId:s}}),children:"Back to Exhibition"}),r.jsx(k,{type:"primary",icon:r.jsx(he,{}),onClick:X,disabled:!i,children:"Add Stall"})]}),style:{flex:1},bodyStyle:{height:"calc(100% - 57px)"},children:r.jsx("div",{ref:m,style:{width:"100%",height:"100%",minHeight:"400px",background:"#f0f2f5",borderRadius:"8px",overflow:"hidden"},children:d&&r.jsx(G,{width:F.width,height:F.height,exhibitionWidth:((R=d.dimensions)==null?void 0:R.width)||100,exhibitionHeight:((z=d.dimensions)==null?void 0:z.height)||100,halls:o,selectedHall:i,onSelectHall:$,isStallMode:!0,children:i&&U.map(e=>r.jsx(Z,{stall:e,isSelected:(u==null?void 0:u.id)===e.id||(u==null?void 0:u._id)===e._id,onSelect:()=>O(e),onChange:J,hallWidth:i.dimensions.width,hallHeight:i.dimensions.height,hallX:i.dimensions.x,hallY:i.dimensions.y},e.id||e._id))})})}),d&&r.jsx(ee,{visible:M,stall:u,hall:i,exhibition:d,onCancel:K,onSubmit:V,onDelete:u?()=>Y(u.id||u._id):void 0})]})})};export{be as default};
