import{a as x,C as Te,j as e}from"./index-BP1I9PmK.js";import{r as o,j as ke,i as Pe}from"./vendor-react-BNeW3y6d.js";import{V as i,T as $e,z as Ce,n as ae,a6 as b,O as B,a7 as Y,a8 as l,b as j,a2 as _,I as Re,c as g,aH as M,x as H,h as U,S as te,aD as F,j as Ie,ak as se,d as O,X as Fe,a as D,aN as De,aW as Ee,p as Ae,bm as ne,bn as Me,R as Ue,m as _e,b9 as Ne}from"./vendor-antd-DhcJxEc5.js";import"./vendor-utils-j652IAQy.js";import"./vendor-styling-BBrlYwaV.js";import"./vendor-canvas-BRbMLhVA.js";const y=s=>{var a,p;const r=((p=(a=s.response)==null?void 0:a.data)==null?void 0:p.message)||"An error occurred";throw new Error(r)},w={sendLettersManually:async(s,r)=>{try{return(await x.post(`/exhibition-letters/${s}/send`,{letterType:r})).data}catch(a){return y(a)}},getLetters:async(s,r={})=>{try{const a=new URLSearchParams;return r.page&&a.append("page",r.page.toString()),r.limit&&a.append("limit",r.limit.toString()),r.letterType&&a.append("letterType",r.letterType),r.status&&a.append("status",r.status),r.search&&a.append("search",r.search),(await x.get(`/exhibition-letters/${s}?${a.toString()}`)).data}catch(a){return y(a)}},getStatistics:async s=>{try{return(await x.get(`/exhibition-letters/${s}/statistics`)).data}catch(r){return y(r)}},previewLetter:async(s,r,a)=>{try{return(await x.get(`/exhibition-letters/${s}/preview/${r}?letterType=${a}`)).data}catch(p){return y(p)}},resendLetter:async s=>{try{return(await x.post(`/exhibition-letters/letter/${s}/resend`)).data}catch(r){return y(r)}},getUpcomingSchedules:async()=>{try{return(await x.get("/exhibition-letters/schedules/upcoming")).data}catch(s){return y(s)}},deleteLetter:async s=>{try{return(await x.delete(`/exhibition-letters/letter/${s}`)).data}catch(r){return y(r)}},getLetterById:async s=>{try{return(await x.get(`/exhibition-letters/letter/${s}`)).data}catch(r){return y(r)}},downloadLetterPDF:async s=>{try{return(await x.get(`/exhibition-letters/letter/${s}/download`,{responseType:"blob"})).data}catch(r){return y(r)}},resendBothLetters:async(s,r,a)=>{try{return(await x.post(`/exhibition-letters/${s}/resend-both/${r}`,{letterTypes:a})).data}catch(p){return y(p)}}},{Title:ze,Text:c}=$e,{Option:T}=_,{Search:Be}=Re,{TabPane:re}=ae,{RangePicker:We}=Ne,Ge=()=>{var ee;const[s,r]=o.useState(()=>localStorage.getItem("letters-selected-exhibition")||""),[a,p]=o.useState([]),[$,ie]=o.useState(null),[oe,le]=o.useState([]),[ce,V]=o.useState(!1),[Q,K]=o.useState(!1),[v,E]=o.useState({current:1,pageSize:10,total:0}),[f,W]=o.useState(""),[m,G]=o.useState(""),[S,J]=o.useState(""),[de,he]=o.useState(null),[ue,N]=o.useState(!1),[d,pe]=o.useState(null),X=ke(),{exhibitions:C}=Pe(t=>t.exhibition);o.useEffect(()=>{X(Te())},[X]);const xe=t=>{r(t),t?localStorage.setItem("letters-selected-exhibition",t):localStorage.removeItem("letters-selected-exhibition"),E(n=>({...n,current:1}))};o.useEffect(()=>{s&&C.length>0&&(C.some(n=>n._id===s)||(r(""),localStorage.removeItem("letters-selected-exhibition")))},[s,C]),o.useEffect(()=>{s&&(k(),R())},[s,f,m,S,v.current,v.pageSize]),o.useEffect(()=>{ge()},[]);const k=async()=>{if(s){V(!0);try{const t=await w.getLetters(s,{page:v.current,limit:v.pageSize,letterType:f,status:m,search:S});p(t.letters),E(n=>({...n,total:t.pagination.total}))}catch(t){i.error(t.message||"Failed to fetch letters")}finally{V(!1)}}},R=async()=>{if(s)try{const t=await w.getStatistics(s);ie(t)}catch(t){i.error(t.message||"Failed to fetch statistics")}},ge=async()=>{try{const t=await w.getUpcomingSchedules();le(t)}catch(t){i.error(t.message||"Failed to fetch upcoming schedules")}},Z=async t=>{if(s){K(!0);try{const n=await w.sendLettersManually(s,t);i.success(`${n.result.sent} letters sent successfully`),k(),R()}catch(n){i.error(n.message||"Failed to send letters")}finally{K(!1)}}},ye=async t=>{try{await w.resendLetter(t),i.success("Letter resent successfully"),k(),R()}catch(n){i.error(n.message||"Failed to resend letter")}},me=async t=>{try{await w.deleteLetter(t),i.success("Letter deleted successfully"),k(),R()}catch(n){i.error(n.message||"Failed to delete letter")}},z=async(t,n)=>{if(s)try{const h=n.map(Le=>Le==="standPossession"?"Stand Possession":"Transport").join(" and ");i.loading({content:`Sending ${h} letter(s)...`,key:"resend-letters"});const L=typeof t.bookingId=="object"&&t.bookingId!==null?t.bookingId._id:t.bookingId,u=await w.resendBothLetters(s,L,n),P=u.summary.sent,I=u.summary.failed,ve=u.summary.total;P>0&&I===0?i.success({content:`${h} letter(s) sent successfully (${P}/${ve})`,key:"resend-letters"}):P>0&&I>0?i.warning({content:`Partially successful: ${P} sent, ${I} failed`,key:"resend-letters"}):i.error({content:`Failed to send ${h} letter(s): ${u.message}`,key:"resend-letters"}),n.includes("standPossession")&&u.results.standPossession.message&&!u.results.standPossession.success&&i.warning(u.results.standPossession.message),n.includes("transport")&&u.results.transport.message&&!u.results.transport.success&&i.warning(u.results.transport.message),k(),R()}catch(h){i.error({content:h.message||"Failed to resend letters",key:"resend-letters"})}},je=async t=>{pe(t),N(!0)},fe=async t=>{try{i.loading({content:"Generating PDF...",key:"download"});const n=await w.downloadLetterPDF(t._id),h=window.URL.createObjectURL(n),L=document.createElement("a");L.href=h;const u=t.letterType==="standPossession"?"Stand_Possession":"Transport",P=t.companyName.replace(/[^a-zA-Z0-9\-_]/g,"_").substring(0,20),I=`${u}_Letter_${P}.pdf`;L.setAttribute("download",I),document.body.appendChild(L),L.click(),L.remove(),window.URL.revokeObjectURL(h),i.success({content:"Letter downloaded successfully",key:"download"})}catch(n){i.error({content:n.message||"Failed to download letter",key:"download"})}},Se=()=>{W(""),G(""),J(""),he(null),E(t=>({...t,current:1}))},A=()=>!!(f||m||S||de),q=t=>{const h={sent:{color:"green",icon:e.jsx(H,{})},pending:{color:"orange",icon:e.jsx(U,{})},failed:{color:"red",icon:e.jsx(_e,{})},scheduled:{color:"blue",icon:e.jsx(U,{})}}[t]||{color:"default",icon:null};return e.jsx(j,{color:h.color,icon:h.icon,children:t.toUpperCase()})},be=[{title:"Type",dataIndex:"letterType",key:"letterType",width:120,render:t=>e.jsx(j,{color:t==="standPossession"?"blue":"green",children:t==="standPossession"?"Stand Possession":"Transport"})},{title:"Recipient",key:"recipient",render:(t,n)=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold"},children:n.recipientName}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:n.companyName}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:n.recipientEmail})]})},{title:"Stalls",dataIndex:"stallNumbers",key:"stallNumbers",width:100,render:t=>t.join(", ")},{title:"Status",dataIndex:"status",key:"status",width:100,render:t=>q(t)},{title:"Method",dataIndex:"sendingMethod",key:"sendingMethod",width:100,render:t=>e.jsx(j,{color:t==="automatic"?"purple":"cyan",children:t.toUpperCase()})},{title:"Sent At",dataIndex:"sentAt",key:"sentAt",width:150,render:t=>t?O(t).format("MMM DD, YYYY HH:mm"):"-"},{title:"Actions",key:"actions",width:220,render:(t,n)=>e.jsxs(te,{size:"small",children:[e.jsx(D,{title:"View Letter",children:e.jsx(g,{type:"text",icon:e.jsx(De,{}),onClick:()=>je(n)})}),e.jsx(D,{title:"Download PDF",children:e.jsx(g,{type:"text",icon:e.jsx(Ee,{}),onClick:()=>fe(n)})}),e.jsx(Ae,{menu:{items:[{key:"both",label:"Resend Both Letters",icon:e.jsx(ne,{}),onClick:()=>z(n,["standPossession","transport"])},{key:"standPossession",label:"Resend Stand Possession Only",icon:e.jsx(F,{}),onClick:()=>z(n,["standPossession"])},{key:"transport",label:"Resend Transport Only",icon:e.jsx(F,{}),onClick:()=>z(n,["transport"])}]},trigger:["click"],placement:"bottomLeft",children:e.jsx(D,{title:"Resend Letters",placement:"top",children:e.jsx(g,{type:"text",icon:e.jsx(ne,{}),style:{color:"#1890ff"}})})}),n.status==="failed"&&e.jsx(D,{title:"Resend This Letter",children:e.jsx(g,{type:"text",icon:e.jsx(F,{}),onClick:()=>ye(n._id)})}),["failed","pending"].includes(n.status)&&e.jsx(Me,{title:"Are you sure you want to delete this letter?",onConfirm:()=>me(n._id),okText:"Yes",cancelText:"No",children:e.jsx(D,{title:"Delete Letter",children:e.jsx(g,{type:"text",danger:!0,icon:e.jsx(Ue,{})})})})]})}],we=[{title:"Exhibition",dataIndex:"exhibitionName",key:"exhibitionName"},{title:"Letter Type",dataIndex:"letterType",key:"letterType",render:t=>e.jsx(j,{color:t==="standPossession"?"blue":"green",children:t==="standPossession"?"Stand Possession":"Transport"})},{title:"Scheduled Date",dataIndex:"scheduledDate",key:"scheduledDate",render:t=>O(t).format("MMM DD, YYYY")},{title:"Days Until Start",dataIndex:"daysUntilStart",key:"daysUntilStart",render:t=>`${t} days`},{title:"Status",dataIndex:"status",key:"status",render:t=>e.jsx(j,{color:t==="due"?"red":"blue",children:t.toUpperCase()})}];return e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs(ze,{level:2,children:[e.jsx(Ce,{})," Exhibition Letters Management"]}),e.jsx(c,{type:"secondary",children:"Manage and monitor exhibition letters sent to exhibitors"}),e.jsxs(ae,{defaultActiveKey:"letters",style:{marginTop:"24px"},children:[e.jsxs(re,{tab:"Letters",children:[e.jsxs(b,{style:{marginBottom:"24px"},children:[(s||A())&&e.jsx(B,{style:{marginBottom:"16px"},message:e.jsxs("span",{children:[e.jsx("strong",{children:"Active Filters:"})," ",[s?`Exhibition: ${((ee=C.find(t=>t._id===s))==null?void 0:ee.name)||"Selected"}`:null,f?`Type: ${f==="standPossession"?"Stand Possession":"Transport"}`:null,m?`Status: ${m.charAt(0).toUpperCase()+m.slice(1)}`:null,S?`Search: "${S}"`:null].filter(Boolean).join(" • ")]}),type:"info",showIcon:!0,closable:!1}),e.jsxs(Y,{gutter:[16,16],children:[e.jsxs(l,{xs:24,md:6,children:[e.jsxs(c,{strong:!0,children:["Exhibition:",s&&e.jsx(j,{color:"blue",style:{marginLeft:8},children:"Selected"})]}),e.jsx(_,{style:{width:"100%",marginTop:"8px"},placeholder:"Select Exhibition",value:s||void 0,onChange:xe,showSearch:!0,optionFilterProp:"children",allowClear:!!s,children:C.map(t=>e.jsx(T,{value:t._id,children:t.name},t._id))})]}),e.jsxs(l,{xs:24,md:4,children:[e.jsxs(c,{strong:!0,children:["Letter Type:",f&&e.jsx(j,{color:"green",style:{marginLeft:8},children:"Filtered"})]}),e.jsxs(_,{style:{width:"100%",marginTop:"8px"},placeholder:"All Types",value:f||void 0,onChange:W,allowClear:!!f,children:[e.jsx(T,{value:"standPossession",children:"Stand Possession"}),e.jsx(T,{value:"transport",children:"Transport"})]})]}),e.jsxs(l,{xs:24,md:4,children:[e.jsxs(c,{strong:!0,children:["Status:",m&&e.jsx(j,{color:"orange",style:{marginLeft:8},children:"Filtered"})]}),e.jsxs(_,{style:{width:"100%",marginTop:"8px"},placeholder:"All Statuses",value:m||void 0,onChange:G,allowClear:!!m,children:[e.jsx(T,{value:"sent",children:"Sent"}),e.jsx(T,{value:"pending",children:"Pending"}),e.jsx(T,{value:"failed",children:"Failed"}),e.jsx(T,{value:"scheduled",children:"Scheduled"})]})]}),e.jsxs(l,{xs:24,md:6,children:[e.jsxs(c,{strong:!0,children:["Search:",S&&e.jsx(j,{color:"purple",style:{marginLeft:8},children:"Active"})]}),e.jsx(Be,{style:{marginTop:"8px"},placeholder:"Search by name, company, email...",value:S,onChange:t=>J(t.target.value),allowClear:!!S})]}),e.jsx(l,{xs:24,md:4,children:e.jsx("div",{style:{marginTop:"32px"},children:e.jsx(g,{onClick:Se,disabled:!A(),type:A()?"primary":"default",danger:A(),children:"Reset Filters"})})})]})]}),s&&$&&e.jsxs(Y,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(l,{xs:12,md:6,children:e.jsx(b,{children:e.jsx(M,{title:"Stand Possession - Sent",value:$.standPossession.sent,valueStyle:{color:"#3f8600"},prefix:e.jsx(H,{})})})}),e.jsx(l,{xs:12,md:6,children:e.jsx(b,{children:e.jsx(M,{title:"Stand Possession - Pending",value:$.standPossession.pending,valueStyle:{color:"#cf1322"},prefix:e.jsx(U,{})})})}),e.jsx(l,{xs:12,md:6,children:e.jsx(b,{children:e.jsx(M,{title:"Transport - Sent",value:$.transport.sent,valueStyle:{color:"#3f8600"},prefix:e.jsx(H,{})})})}),e.jsx(l,{xs:12,md:6,children:e.jsx(b,{children:e.jsx(M,{title:"Transport - Pending",value:$.transport.pending,valueStyle:{color:"#cf1322"},prefix:e.jsx(U,{})})})})]}),s&&e.jsxs(b,{style:{marginBottom:"24px"},children:[e.jsxs(te,{wrap:!0,children:[e.jsx(g,{type:"primary",icon:e.jsx(F,{}),loading:Q,onClick:()=>Z("standPossession"),children:"Send Stand Possession Letters"}),e.jsx(g,{type:"primary",icon:e.jsx(F,{}),loading:Q,onClick:()=>Z("transport"),children:"Send Transport Letters"}),e.jsx(g,{icon:e.jsx(Ie,{}),onClick:k,children:"Refresh"})]}),e.jsx(B,{style:{marginTop:"16px"},message:"Quick Actions",description:"Click the double arrow (⏩) button in the table to choose which letters to resend: both types together, or individual Stand Possession or Transport letters.",type:"info",showIcon:!0,closable:!0})]}),e.jsx(b,{children:e.jsx(se,{columns:be,dataSource:a,rowKey:"_id",loading:ce,pagination:{current:v.current,pageSize:v.pageSize,total:v.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,n)=>`${n[0]}-${n[1]} of ${t} letters`,onChange:(t,n)=>{E(h=>({...h,current:t,pageSize:n||10}))}}})})]},"letters"),e.jsxs(re,{tab:"Upcoming Schedules",children:[e.jsx(B,{message:"Automatic Letter Schedules",description:"These letters will be sent automatically based on exhibition dates and letter settings.",type:"info",showIcon:!0,style:{marginBottom:"24px"}}),e.jsx(b,{children:e.jsx(se,{columns:we,dataSource:oe,rowKey:t=>`${t.exhibitionId}-${t.letterType}`,pagination:!1})})]},"schedules")]}),e.jsx(Fe,{title:"Letter Details",open:ue,onCancel:()=>N(!1),footer:[e.jsx(g,{onClick:()=>N(!1),children:"Close"},"close")],width:800,children:d&&e.jsxs("div",{children:[e.jsxs(Y,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Type:"}),e.jsx("div",{children:d.letterType==="standPossession"?"Stand Possession":"Transport"})]}),e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Status:"}),e.jsx("div",{children:q(d.status)})]}),e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Recipient:"}),e.jsx("div",{children:d.recipientName}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:d.recipientEmail})]}),e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Company:"}),e.jsx("div",{children:d.companyName})]}),e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Stalls:"}),e.jsx("div",{children:d.stallNumbers.join(", ")})]}),e.jsxs(l,{span:12,children:[e.jsx(c,{strong:!0,children:"Sent At:"}),e.jsx("div",{children:d.sentAt?O(d.sentAt).format("MMM DD, YYYY HH:mm"):"Not sent"})]})]}),e.jsxs("div",{style:{marginBottom:"16px"},children:[e.jsx(c,{strong:!0,children:"Subject:"}),e.jsx("div",{style:{marginTop:"8px",padding:"8px",background:"#f5f5f5",borderRadius:"4px"},children:d.subject})]}),e.jsxs("div",{children:[e.jsx(c,{strong:!0,children:"Content:"}),e.jsx("div",{style:{marginTop:"8px",padding:"16px",background:"#f5f5f5",borderRadius:"4px",whiteSpace:"pre-line",fontFamily:"monospace",maxHeight:"400px",overflow:"auto"},children:d.content})]}),d.failureReason&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(c,{strong:!0,children:"Failure Reason:"}),e.jsx("div",{style:{marginTop:"8px",padding:"8px",background:"#fff2f0",border:"1px solid #ffccc7",borderRadius:"4px",color:"#a8071a"},children:d.failureReason})]})]})})]})};export{Ge as default};
