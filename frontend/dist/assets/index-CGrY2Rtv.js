import{B as he,X as xe,a5 as me,j as t,a4 as ge}from"./index-0Suq5uxL.js";import{u as pe,j as je,r as s,i as ye,R as fe}from"./vendor-react-BNeW3y6d.js";import{U as ve,d as R,ae as Ie,a5 as G,S as m,T as be,a as I,c as g,j as we,I as N,aW as Se,a1 as D,a$ as ke,b8 as Ce,aZ as Ee,aj as Re,W as Ne,b as De,aO as Me,aQ as Ae,ao as Le,P as Fe}from"./vendor-antd--VDS8NUg.js";import"./vendor-utils-CtctGR1F.js";import"./vendor-styling-CU6mz1ss.js";import"./vendor-canvas-BRbMLhVA.js";const{Title:Oe,Text:u}=be,{Option:b}=D,{RangePicker:Te}=ke,Be=()=>{var Q;const w=pe(),M=je(),[A,H]=s.useState(1),[L,K]=s.useState(10),[p,F]=s.useState(""),[j,O]=s.useState(null),[y,T]=s.useState(null),[o,$]=s.useState(null),[X,S]=s.useState(!1),[_,P]=s.useState(null),[k,Y]=s.useState(""),[W,z]=s.useState(""),[l,Z]=s.useState("createdAt"),[r,q]=s.useState("descend"),[d,J]=ve.useMessage(),[h,B]=s.useState(null),[U,C]=s.useState(0),{exhibitions:ee,loading:te}=ye(e=>e.exhibition);s.useEffect(()=>{M(he())},[M]);const{data:i,isLoading:V,refetch:ne}=xe({page:A,limit:L}),[se,{isLoading:ae}]=me(),ie=fe.useMemo(()=>i!=null&&i.data?i.data.filter(e=>{const n=p.toLowerCase(),a=p===""||e.invoiceNumber&&e.invoiceNumber.toLowerCase().includes(n)||e._id.toLowerCase().includes(n)||e.bookingId.customerName&&e.bookingId.customerName.toLowerCase().includes(n)||e.bookingId.companyName&&e.bookingId.companyName.toLowerCase().includes(n),c=!j||e.status===j,f=!y||e.bookingId.exhibitionId&&e.bookingId.exhibitionId._id===y;let x=!0;if(o&&o[0]&&o[1]){const v=R(e.createdAt);x=v.isAfter(o[0])&&v.isBefore(o[1])}return a&&c&&f&&x}):[],[i,p,j,y,o]),oe=async e=>{try{B(e),C(0),d.loading({content:"Preparing invoice...",key:e});const n=await ge(`/invoices/${e}/download?force=false`,!1,f=>{const x=f.total,v=f.loaded;if(x){const E=Math.round(v*100/x);C(E),E%25===0&&d.loading({content:`Downloading: ${E}% complete`,key:e})}}),a=window.URL.createObjectURL(new Blob([n.data])),c=document.createElement("a");c.href=a,c.setAttribute("download",`invoice-${e}.pdf`),document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(a),d.success({content:"Invoice downloaded successfully",key:e})}catch(n){console.error("Download error:",n),d.error({content:"Failed to download invoice",key:e})}finally{B(null),C(0)}},le=async()=>{if(!(!_||!k))try{d.loading({content:"Sending email...",key:"email"}),await se({id:_,email:k,message:W||void 0}).unwrap(),d.success({content:"Invoice sent via email successfully",key:"email"}),S(!1),Y(""),z(""),P(null)}catch(e){console.error("Email error:",e),d.error({content:"Failed to send invoice via email",key:"email"})}},re=e=>{P(e),S(!0)},de=()=>{F(""),O(null),T(null),$(null)},ce=[{title:"Invoice #",dataIndex:["invoiceNumber"],key:"invoiceNumber",sorter:!0,sortOrder:l==="invoiceNumber"?r:null,render:(e,n)=>t.jsx("a",{onClick:()=>w(`/invoice/${n._id}`),children:e||"N/A"})},{title:"Company",dataIndex:["bookingId","companyName"],key:"companyName",sorter:!0,sortOrder:l==="companyName"?r:null,render:e=>e||"N/A"},{title:"Exhibition",dataIndex:["bookingId","exhibitionId","name"],key:"exhibitionName",sorter:!0,sortOrder:l==="exhibitionName"?r:null,render:(e,n)=>t.jsx("a",{onClick:()=>w(`/exhibition/${n.bookingId.exhibitionId._id}`),children:e})},{title:"Amount",dataIndex:"amount",key:"amount",sorter:!0,sortOrder:l==="amount"?r:null,render:e=>`â‚¹${e.toLocaleString("en-IN")}`},{title:"Status",dataIndex:"status",key:"status",sorter:!0,sortOrder:l==="status"?r:null,render:e=>t.jsx(De,{color:e==="paid"?"green":e==="pending"?"gold":e==="cancelled"?"red":"blue",children:e.toUpperCase()})},{title:"Due Date",dataIndex:"dueDate",key:"dueDate",sorter:!0,sortOrder:l==="dueDate"?r:null,render:e=>e?R(e).format("DD MMM YYYY"):"N/A"},{title:"Created",dataIndex:"createdAt",key:"createdAt",sorter:!0,sortOrder:l==="createdAt"?r:null,render:e=>R(e).format("DD MMM YYYY")},{title:"Actions",key:"actions",render:(e,n)=>t.jsxs(m,{direction:"vertical",size:"small",style:{width:"100%"},children:[t.jsxs(m,{children:[t.jsx(I,{title:"View Invoice",children:t.jsx(g,{type:"text",icon:t.jsx(Me,{}),onClick:()=>w(`/invoice/${n._id}`)})}),t.jsx(I,{title:"Download",children:t.jsx(g,{type:"text",icon:t.jsx(Ae,{}),onClick:()=>oe(n._id),loading:h===n._id&&U<100,disabled:h!==null&&h!==n._id})}),t.jsx(I,{title:"Email",children:t.jsx(g,{type:"text",icon:t.jsx(Le,{}),onClick:()=>re(n._id),disabled:h!==null})})]}),h===n._id&&t.jsx(Fe,{percent:U,size:"small",status:"active",style:{marginBottom:0,marginTop:4}})]})}],ue=(e,n,a)=>{a&&a.field&&(Z(a.field),q(a.order||"descend"))};return t.jsxs(Ie,{children:[J,t.jsxs("div",{className:"invoice-list-container",children:[t.jsx(G,{children:t.jsxs(m,{direction:"vertical",style:{width:"100%"},size:"large",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(Oe,{level:2,style:{margin:0},children:"Invoices"}),t.jsx(m,{children:t.jsx(I,{title:"Refresh",children:t.jsx(g,{icon:t.jsx(we,{}),onClick:()=>ne(),loading:V})})})]}),t.jsx(G,{size:"small",title:t.jsxs(m,{children:[t.jsx(Ee,{})," Filters"]}),children:t.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"16px"},children:[t.jsxs("div",{style:{minWidth:"200px",flex:1},children:[t.jsx(u,{strong:!0,children:"Search"}),t.jsx(N,{placeholder:"Search by invoice #, company...",value:p,onChange:e=>F(e.target.value),prefix:t.jsx(Se,{}),allowClear:!0})]}),t.jsxs("div",{style:{minWidth:"150px"},children:[t.jsx(u,{strong:!0,children:"Status"}),t.jsxs(D,{style:{width:"100%"},placeholder:"Filter by status",value:j,onChange:O,allowClear:!0,children:[t.jsx(b,{value:"pending",children:"Pending"}),t.jsx(b,{value:"paid",children:"Paid"}),t.jsx(b,{value:"cancelled",children:"Cancelled"})]})]}),t.jsxs("div",{style:{minWidth:"200px"},children:[t.jsx(u,{strong:!0,children:"Exhibition"}),t.jsx(D,{style:{width:"100%"},placeholder:"Filter by exhibition",value:y,onChange:T,loading:te,allowClear:!0,children:ee.map(e=>t.jsx(b,{value:e._id||e.id,children:e.name},e._id||e.id))})]}),t.jsxs("div",{style:{minWidth:"300px"},children:[t.jsx(u,{strong:!0,children:"Date Range"}),t.jsx(Te,{style:{width:"100%"},value:o,onChange:$})]}),t.jsx("div",{style:{display:"flex",alignItems:"flex-end"},children:t.jsx(g,{icon:t.jsx(Ce,{}),onClick:de,children:"Clear Filters"})})]})}),t.jsx(Re,{columns:ce,dataSource:ie,rowKey:"_id",loading:V,pagination:{current:A,pageSize:L,total:((Q=i==null?void 0:i.pagination)==null?void 0:Q.total)||0,onChange:(e,n)=>{H(e),n&&K(n)},showSizeChanger:!0,showTotal:e=>`Total ${e} invoices`},onChange:ue})]})}),t.jsxs(Ne,{title:"Send Invoice via Email",open:X,onCancel:()=>S(!1),onOk:le,okText:"Send",confirmLoading:ae,children:[t.jsxs("div",{style:{marginBottom:16},children:[t.jsx(u,{strong:!0,children:"Email Address"}),t.jsx(N,{placeholder:"Enter recipient email",value:k,onChange:e=>Y(e.target.value),style:{width:"100%"}})]}),t.jsxs("div",{children:[t.jsx(u,{strong:!0,children:"Message (Optional)"}),t.jsx(N.TextArea,{placeholder:"Enter optional message",value:W,onChange:e=>z(e.target.value),rows:4})]})]})]})]})};export{Be as default};
